<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Starnet ðŸ’« Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {margin:0; font-family:Arial, sans-serif; background:#f9fafb; color:#333;}
    .sidebar {width:220px; height:100%; position:fixed; top:0; left:0; background:#4f46e5; color:#fff; padding-top:20px;}
    .sidebar h2 {text-align:center; margin:0 0 30px; font-size:18px; color:#fff;}
    .sidebar a {display:block; color:#e0e7ff; padding:10px 20px; text-decoration:none;}
    .sidebar a:hover, .sidebar a.active {background:#4338ca; color:#fff;}
    .main {margin-left:220px; padding:20px;}
    .card {background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); margin-bottom:20px;}
    table {width:100%; border-collapse:collapse; font-size:14px;}
    th,td {padding:10px; border-bottom:1px solid #e2e8f0; text-align:left;}
    th {background:#eef2ff;}
    input,select {padding:6px; margin:6px 0; width:100%; border:1px solid #ccc; border-radius:6px;}
    button {padding:8px 12px; margin:4px 2px; border:none; border-radius:6px; cursor:pointer;}
    button.primary {background:#4f46e5; color:white;}
    button.danger {background:#ef4444; color:white;}
    button.success {background:#22c55e; color:white;}
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Starnet ðŸ’«</h2>
    <a href="#" class="active" onclick="showSection('dashboard',this)">ðŸ“Š Dashboard</a>
    <a href="#" onclick="showSection('billing',this)">ðŸ’³ Billing</a>
  </div>

  <div class="main">
    <!-- Dashboard -->
    <div id="dashboard" class="section">
      <h2>Dashboard</h2>
      <div class="card">
        <p>Total Tunggakan: <span id="totalTunggakan">0</span></p>
      </div>
      <div class="card">
        <canvas id="billingChart"></canvas>
      </div>
    </div>

    <!-- Billing -->
    <div id="billing" class="section" style="display:none;">
      <h2>Billing</h2>
      <form id="billingForm">
        <input type="hidden" id="billingId">
        <label>User</label><input id="billingUser" required>
        <label>Jumlah</label><input id="billingAmount" required>
        <label>Periode</label><input id="billingPeriod" placeholder="2025-08" required>
        <button class="primary" type="submit">Simpan Billing</button>
      </form>
      <div class="card">
        <table id="billingTable">
          <thead>
            <tr><th>User</th><th>Jumlah</th><th>Periode</th><th>Status</th><th>Aksi</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyB-iBpZNC0YZBTAUzir7gJuU9kBQg82moc",
    authDomain: "dnt-network-7.firebaseapp.com",
    projectId: "dnt-network-7",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  function showSection(id,el){
    document.querySelectorAll('.section').forEach(s=>s.style.display="none");
    document.getElementById(id).style.display="block";
    document.querySelectorAll('.sidebar a').forEach(a=>a.classList.remove("active"));
    if(el) el.classList.add("active");
  }

  // Save Billing dengan cek tunggakan
  document.getElementById("billingForm").onsubmit=(e)=>{
    e.preventDefault();
    const id=document.getElementById("billingId").value;
    const user=document.getElementById("billingUser").value;
    const jumlah=parseFloat(document.getElementById("billingAmount").value);
    const periode=document.getElementById("billingPeriod").value;

    db.collection("billing").where("billingUser","==",user).where("status","==","Belum")
    .get().then(snap=>{
      let total=jumlah;
      let status="Lunas";
      if(!snap.empty){
        snap.forEach(doc=>{ total+=parseFloat(doc.data().billingAmount); });
        status="Belum";
      }
      let data={billingUser:user,billingAmount:total,billingPeriod:periode,status:status};
      if(id){ db.collection("billing").doc(id).update(data); }
      else{ db.collection("billing").add(data); }
      e.target.reset();
      document.getElementById("billingId").value="";
    });
  }

  // Render billing
  function renderBilling(){
    db.collection("billing").orderBy("billingPeriod","desc").onSnapshot(snap=>{
      let tbody=document.querySelector("#billingTable tbody");
      tbody.innerHTML="";
      let tunggakan=0;
      snap.forEach(doc=>{
        let d=doc.data();
        if(d.status==="Belum") tunggakan++;
        let tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${d.billingUser}</td>
          <td>${d.billingAmount}</td>
          <td>${d.billingPeriod}</td>
          <td style="color:${d.status==='Belum'?'red':'green'}">${d.status}</td>
          <td>
            <button class="success" onclick="editBilling('${doc.id}')">Edit</button>
            <button class="danger" onclick="deleteBilling('${doc.id}')">Hapus</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById("totalTunggakan").textContent=tunggakan;
    })
  }
  renderBilling();

  function editBilling(id){
    db.collection("billing").doc(id).get().then(doc=>{
      if(doc.exists){
        let d=doc.data();
        document.getElementById("billingUser").value=d.billingUser;
        document.getElementById("billingAmount").value=d.billingAmount;
        document.getElementById("billingPeriod").value=d.billingPeriod;
        document.getElementById("billingId").value=id;
      }
    })
  }
  function deleteBilling(id){ if(confirm("Yakin hapus?")) db.collection("billing").doc(id).delete(); }

  // Grafik Billing
  let chartCtx=document.getElementById("billingChart").getContext("2d");
  let billingChart=new Chart(chartCtx,{type:'bar',data:{labels:[],datasets:[{label:"Tagihan",data:[],backgroundColor:"#4f46e5"}]},options:{scales:{y:{beginAtZero:true}}}});

  function loadChart(){
    db.collection("billing").get().then(snap=>{
      let data={};
      snap.forEach(doc=>{
        let d=doc.data();
        if(!data[d.billingPeriod]) data[d.billingPeriod]=0;
        data[d.billingPeriod]+=parseFloat(d.billingAmount);
      });
      billingChart.data.labels=Object.keys(data).sort();
      billingChart.data.datasets[0].data=Object.keys(data).sort().map(k=>data[k]);
      billingChart.update();
    })
  }
  loadChart();
  setInterval(loadChart,5*60*1000); // refresh tiap 5 menit
</script>
</body>
</html>
