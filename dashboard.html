<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<title>Starnet ğŸ’« Manager â€” Final</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --primary:#007bff;
    --primary-dark:#0056b3;
    --bg:#f4f6f9;
    --card-bg:#ffffff;
    --rounded:14px;
    --soft-shadow: 0 8px 24px rgba(11,32,84,0.06);
    --muted:#6b7280;
  }

  /* Global */
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
  body{background:var(--bg);color:#0b1016;font-size:14px;-webkit-font-smoothing:antialiased;}
  a { color:inherit; text-decoration:none; }

  /* Sidebar */
  .sidebar{
    position:fixed; left:0; top:0; bottom:0;
    width:250px; background:linear-gradient(180deg,var(--primary),var(--primary-dark));
    color:white; padding:18px 12px; box-sizing:border-box; overflow:hidden;
    transition:width .28s ease;
    display:flex; flex-direction:column; gap:8px;
  }
  .sidebar.min { width:72px; }
  /* ISP header inside sidebar */
  .isp-header{display:flex;align-items:center;gap:10px;padding:6px;border-radius:10px;}
  .isp-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.08);font-weight:700;}
  .isp-title{font-weight:700;font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .isp-title .text{display:inline-block}
  .sidebar.min .isp-title .text{display:none}

  /* menu */
  .menu{margin-top:8px;display:flex;flex-direction:column;gap:6px;}
  .menu a{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;color:white;transition:background .15s;}
  .menu a:hover{background:rgba(255,255,255,0.08);}
  .menu .icon{width:30px;text-align:center;font-size:16px;}
  .menu .label{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .sidebar.min .menu .label{display:none}

  /* hamburger floating button (to toggle) */
  .hamburger{
    position:fixed; left:262px; top:18px; width:36px;height:36px;border-radius:8px;
    background:var(--primary-dark); color:white; display:flex;align-items:center;justify-content:center;
    cursor:pointer; box-shadow: var(--soft-shadow); transition:left .28s;
    z-index:50;
  }
  .sidebar.min + .hamburger{ left:86px; } /* shift when min */

  /* Main content */
  .main{margin-left:250px;padding:22px;transition:margin-left .28s;}
  .main.min{ margin-left:72px; }

  /* Cards */
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-bottom:18px;}
  .card{background:var(--card-bg);border-radius:var(--rounded);padding:18px;box-shadow:var(--soft-shadow);transition:transform .15s ease,box-shadow .15s;}
  .card:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(11,32,84,0.08);}

  .kpi{font-size:28px;font-weight:700;margin:6px 0;color:#0b1220;}
  .kpi-sub{color:var(--muted);font-size:12px;margin-top:6px;}

  /* Section titles */
  h2.section-title{margin:0 0 12px 0;font-size:20px}

  /* Tables - renderer "professional" */
  .table-pro-wrapper{overflow:auto;border-radius:10px}
  table.table-pro{width:100%;border-collapse:collapse;font-size:13px;background:white}
  table.table-pro thead th{
    position:sticky; top:0; background:linear-gradient(90deg,var(--primary),var(--primary-dark)); color:white; padding:12px 14px; text-align:left; font-weight:700; font-size:13px;
  }
  table.table-pro th, table.table-pro td{padding:12px 14px;border-bottom:1px solid #eef2f7;}
  table.table-pro tbody tr:nth-child(even){background:#fbfdff;}
  table.table-pro tbody tr:hover{background:#e9f2ff;}
  table.table-pro td:first-child{border-left:6px solid rgba(0,123,255,0.08);}

  /* Buttons & inputs */
  .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;background:var(--primary);color:white;border:none;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(0,0,0,0.06)}
  input,select,textarea{padding:8px 10px;border-radius:8px;border:1px solid #e6edf3;width:100%;box-sizing:border-box}

  /* small helper row under tables */
  .table-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}

  /* responsiveness */
  @media (max-width:900px){
    .sidebar{left:0;top:0;transform:translateX(0);position:fixed;z-index:60}
    .hamburger{left:86px}
  }
</style>
</head>
<body>
  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="isp-header">
      <div class="isp-icon">ğŸ’«</div>
      <div class="isp-title"><span class="text">Starnet</span></div>
    </div>

    <nav class="menu" aria-label="Main menu">
      <a href="#" data-section="dashboard"><span class="icon">ğŸ </span><span class="label">Dashboard</span></a>
      <a href="#" data-section="user"><span class="icon">ğŸ‘¤</span><span class="label">User</span></a>
      <a href="#" data-section="paket"><span class="icon">ğŸ“¦</span><span class="label">Paket</span></a>
      <a href="#" data-section="billing"><span class="icon">ğŸ’µ</span><span class="label">Billing</span></a>
      <a href="#" data-section="kas"><span class="icon">ğŸ¦</span><span class="label">Kas</span></a>
      <a href="#" data-section="teknisi"><span class="icon">ğŸ› ï¸</span><span class="label">Teknisi</span></a>
      <a href="#" data-section="gangguan"><span class="icon">âš ï¸</span><span class="label">Gangguan</span></a>
      <a href="#" data-section="odp"><span class="icon">ğŸ›°ï¸</span><span class="label">ODP</span></a>
      <a href="#" data-section="material"><span class="icon">ğŸ“‹</span><span class="label">Material</span></a>
      <a href="#" data-section="editisp"><span class="icon">âœï¸</span><span class="label">Edit ISP</span></a>
      <a href="#" id="logoutBtn"><span class="icon">ğŸ”“</span><span class="label">Logout</span></a>
    </nav>
  </div>

  <!-- Hamburger toggle -->
  <div class="hamburger" id="hamburger" title="Toggle sidebar">â˜°</div>

  <!-- MAIN -->
  <main class="main" id="main">
    <!-- DASHBOARD -->
    <section id="dashboard" class="section">
      <h2 class="section-title">Dashboard</h2>
      <div class="grid">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="color:var(--muted);font-size:12px">Total User</div>
              <div class="kpi" id="totalUser">0</div>
              <div class="kpi-sub">Pengguna terdaftar</div>
            </div>
            <div style="font-size:26px;opacity:.9">ğŸ‘¥</div>
          </div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="color:var(--muted);font-size:12px">Saldo Kas</div>
              <div class="kpi" id="saldoKas">0</div>
              <div class="kpi-sub">Saldo perusahaan</div>
            </div>
            <div style="font-size:26px;opacity:.9">ğŸ¦</div>
          </div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="color:var(--muted);font-size:12px">Tunggakan</div>
              <div class="kpi" id="totalTunggakan">0</div>
              <div class="kpi-sub">Tagihan belum dibayar</div>
            </div>
            <div style="font-size:26px;opacity:.9">ğŸ’¸</div>
          </div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="color:var(--muted);font-size:12px">Gangguan Aktif</div>
              <div class="kpi" id="totalGangguan">0</div>
              <div class="kpi-sub">Insiden jaringan sekarang</div>
            </div>
            <div style="font-size:26px;opacity:.9">âš ï¸</div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-bottom:18px">
        <canvas id="ispChart" height="90"></canvas>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Gangguan Terbaru</h3>
        <div class="table-pro-wrapper">
          <table class="table-pro" id="dashboardGangguan">
            <thead><tr><th>User</th><th>Indikasi</th><th>Waktu</th><th>TTR</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- USER -->
    <section id="user" class="section" style="display:none;">
      <h2 class="section-title">User</h2>

      <div class="card" style="margin-bottom:12px">
        <form id="userForm">
          <input type="hidden" id="userId" />
          <div style="display:flex;gap:12px;flex-wrap:wrap">
            <div style="flex:1;min-width:200px">
              <label>Nama</label><input id="userName" placeholder="Nama lengkap" required />
            </div>
            <div style="flex:1;min-width:200px">
              <label>Paket</label>
              <select id="planSelect"></select>
            </div>
            <div style="flex:1;min-width:160px">
              <label>Status Bayar</label>
              <select id="statusBayar"><option>Lunas</option><option>Belum</option></select>
            </div>
            <div style="display:flex;align-items:flex-end">
              <button class="btn" type="submit">Simpan User</button>
            </div>
          </div>
        </form>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <h3 style="margin:0">Daftar User</h3>
          <div class="table-actions">
            <input id="userSearch" placeholder="Cari user..." style="padding:8px;border-radius:8px;border:1px solid #e6edf3" />
          </div>
        </div>

        <div class="table-pro-wrapper">
          <table class="table-pro" id="userTable">
            <thead><tr><th>Nama</th><th>Paket</th><th>Status Bayar</th><th>Aksi</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- PAKET -->
    <section id="paket" class="section" style="display:none;">
      <h2 class="section-title">Paket</h2>

      <div class="card">
        <form id="paketForm">
          <input type="hidden" id="paketId" />
          <div style="display:flex;gap:12px;flex-wrap:wrap">
            <div style="flex:1;min-width:200px"><label>Nama Paket</label><input id="namaPaket" required/></div>
            <div style="flex:1;min-width:150px"><label>Bandwidth</label><input id="bandwidth" required/></div>
            <div style="flex:1;min-width:120px;display:flex;align-items:flex-end"><button class="btn" type="submit">Simpan Paket</button></div>
          </div>
        </form>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">Daftar Paket</h3>
        <div class="table-pro-wrapper">
          <table class="table-pro" id="paketTable">
            <thead><tr><th>Paket</th><th>Bandwidth</th><th>Aksi</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- BILLING -->
    <section id="billing" class="section" style="display:none;">
      <h2 class="section-title">Billing</h2>

      <div class="card" style="margin-bottom:12px">
        <form id="billingForm">
          <input type="hidden" id="billingId" />
          <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:end">
            <div style="flex:1;min-width:200px"><label>User</label><select id="billingUser" required></select></div>
            <div style="width:160px"><label>Jumlah</label><input id="billingAmount" type="number" required/></div>
            <div><button class="btn" type="submit">Simpan Billing</button></div>
            <div><button type="button" class="btn ghost" onclick="generateAllBilling()">Generate Tagihan Semua</button></div>
            <div><button type="button" class="btn ghost" onclick="exportBillingCSV()">Export CSV</button></div>
          </div>
        </form>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">Daftar Billing</h3>
        <div class="table-pro-wrapper">
          <table class="table-pro" id="billingTable">
            <thead><tr><th>User</th><th>Jumlah</th><th>Status</th><th>Tanggal</th><th>Aksi</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- KAS -->
    <section id="kas" class="section" style="display:none;">
      <h2 class="section-title">Kas</h2>

      <div class="card">
        <form id="kasForm">
          <input type="hidden" id="kasId" />
          <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:end">
            <div style="flex:1;min-width:200px"><label>Keterangan</label><input id="kasKet" required/></div>
            <div style="width:160px"><label>Jumlah (+/-)</label><input id="kasJumlah" type="number" required/></div>
            <div><button class="btn" type="submit">Simpan Transaksi</button></div>
          </div>
        </form>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">Riwayat Kas</h3>
        <div class="table-pro-wrapper">
          <table class="table-pro" id="kasTable">
            <thead><tr><th>Keterangan</th><th>Jumlah</th><th>Tanggal</th><th>Aksi</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- TEKNISI -->
    <section id="teknisi" class="section" style="display:none;">
      <h2 class="section-title">Teknisi</h2>
      <div class="card">
        <form id="teknisiForm">
          <input type="hidden" id="teknisiId" />
          <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:end">
            <div style="flex:1;min-width:200px"><label>Nama Teknisi</label><input id="namaTeknisi" required/></div>
            <div style="width:200px"><label>Kontak</label><input id="kontakTeknisi" required/></div>
            <div><button class="btn" type="submit">Simpan Teknisi</button></div>
          </div>
        </form>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">Daftar Teknisi</h3>
        <div class="table-pro-wrapper">
          <table class="table-pro" id="teknisiTable">
            <thead><tr><th>Nama</th><th>Kontak</th><th>Aksi</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- GANGGUAN -->
    <section id="gangguan" class="section" style="display:none;">
      <h2 class="section-title">Gangguan</h2>
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <button class="btn" onclick="simulateGangguan()">â• Tambah Gangguan Random</button>
        <button class="btn ghost" onclick="clearGangguan()">ğŸ—‘ï¸ Hapus Semua</button>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">Daftar Gangguan</h3>
        <div class="table-pro-wrapper">
          <table class="table-pro" id="gangguanTable">
            <thead><tr><th>User</th><th>Indikasi</th><th>Waktu</th><th>TTR</th><th>Status</th><th>Teknisi</th><th>Aksi</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ODP -->
    <section id="odp" class="section" style="display:none;">
      <h2 class="section-title">ODP</h2>
      <div class="card">
        <form id="odpForm">
          <input type="hidden" id="odpId" />
          <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:end">
            <div style="flex:1;min-width:160px"><label>Kode ODP</label><input id="odpKode" required/></div>
            <div style="flex:1;min-width:200px"><label>Lokasi</label><input id="odpLokasi" required/></div>
            <div style="width:120px"><label>Kapasitas</label><input id="odpKapasitas" type="number" required/></div>
            <div><button class="btn" type="submit">Simpan ODP</button></div>
          </div>
        </form>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">Daftar ODP</h3>
        <div class="table-pro-wrapper">
          <table class="table-pro" id="odpTable">
            <thead><tr><th>Kode</th><th>Lokasi</th><th>Kapasitas</th><th>Aksi</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- MATERIAL -->
    <section id="material" class="section" style="display:none;">
      <h2 class="section-title">Material</h2>
      <div class="card">
        <form id="materialForm">
          <input type="hidden" id="materialId" />
          <div style="display:flex;gap:12px;align-items:end">
            <div style="flex:1"><label>Nama Material</label><input id="namaMaterial" required/></div>
            <div style="width:140px"><label>Stok</label><input id="stokMaterial" type="number" required/></div>
            <div><button class="btn" type="submit">Simpan Material</button></div>
          </div>
        </form>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px 0">Daftar Material</h3>
        <div class="table-pro-wrapper">
          <table class="table-pro" id="materialTable">
            <thead><tr><th>Material</th><th>Stok</th><th>Aksi</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Edit ISP -->
    <section id="editisp" class="section" style="display:none;">
      <h2 class="section-title">Edit ISP</h2>
      <div class="card">
        <div style="display:flex;gap:12px;align-items:center">
          <input id="newISPName" placeholder="Nama ISP baru" style="flex:1" />
          <button class="btn" onclick="applyISPName()">Simpan</button>
        </div>
      </div>
    </section>
  </main>

<script>
/* =========================
   Firebase initialization
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyB-iBpZNC0YZBTAUzir7gJuU9kBQg82moc",
  authDomain: "dnt-network-7.firebaseapp.com",
  projectId: "dnt-network-7",
  storageBucket: "dnt-network-7.firebasestorage.app",
  messagingSenderId: "761179668371",
  appId: "1:761179668371:web:7d1468d0298041d4783266",
  measurementId: "G-CD3EQ350R4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* =========================
   UI: sidebar toggle + nav
   ========================= */
const sidebar = document.getElementById('sidebar');
const hamburger = document.getElementById('hamburger');
const main = document.getElementById('main');

function toggleSidebar(){
  sidebar.classList.toggle('min');
  main.classList.toggle('min');
}
hamburger.addEventListener('click', toggleSidebar);

// nav links
document.querySelectorAll('.menu a, .menu a').forEach(a=>{
  a.addEventListener('click', (e)=>{
    e.preventDefault();
    const section = a.getAttribute('data-section');
    if(section) showSection(section);
  })
});
document.getElementById('logoutBtn').addEventListener('click', (e)=>{ e.preventDefault(); alert('Logout sukses!'); });

function showSection(id){
  document.querySelectorAll('.section').forEach(s=>s.style.display='none');
  const el = document.getElementById(id);
  if(el) el.style.display='block';
  // scroll top
  window.scrollTo({top:0,behavior:'smooth'});
}

/* =========================
   Helpers & table renderer
   ========================= */

function createCell(text){ const td = document.createElement('td'); td.textContent = text ?? ''; return td; }

/* Table renderer function - professional rendering for main tables.
   Accepts: tableId (string), rows: array of objects, columns: [{key,label,render?}]
*/
function renderProfessionalTable(tableId, rows, columns){
  const tbody = document.querySelector(`#${tableId} tbody`);
  if(!tbody) return;
  // clear
  tbody.innerHTML = '';
  // render rows
  rows.forEach((row)=>{
    const tr = document.createElement('tr');
    columns.forEach(col=>{
      const td = document.createElement('td');
      if(typeof col.render === 'function'){
        // custom render returns DOM node or string
        const out = col.render(row);
        if(out instanceof Node) td.appendChild(out);
        else td.innerHTML = out ?? '';
      } else {
        td.textContent = row[col.key] ?? '';
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

/* Small utility for date formatting */
function formatISO(d){
  if(!d) return '';
  const dt = (typeof d === 'string') ? new Date(d) : d;
  return dt.toLocaleString();
}

/* =========================
   Dashboard chart (Chart.js)
   ========================= */
const ctx = document.getElementById('ispChart').getContext('2d');
const ispChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
    datasets: [
      { label:'Upload (Mbps)', data: Array(12).fill(0), borderColor:'#1f77b4', tension:0.3, fill:false },
      { label:'Download (Mbps)', data: Array(12).fill(0), borderColor:'#2ca02c', tension:0.3, fill:false }
    ]
  },
  options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} }
});

/* =========================
   Real-time listeners & CRUD binding
   ========================= */

/* ---------- PACKET: Paket ---------- */
const paketForm = document.getElementById('paketForm');
paketForm && paketForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id = document.getElementById('paketId').value;
  const nama = document.getElementById('namaPaket').value.trim();
  const bw = document.getElementById('bandwidth').value.trim();
  if(!nama) return alert('Isi nama paket');
  const payload = { namaPaket: nama, bandwidth: bw };
  if(id) await db.collection('paket').doc(id).update(payload);
  else await db.collection('paket').add(payload);
  paketForm.reset();
});

/* render paket table & populate planSelect */
db.collection('paket').onSnapshot(snapshot=>{
  const rows = [];
  snapshot.forEach(doc=> rows.push({ id:doc.id, ...doc.data() }));
  // render paket table
  renderProfessionalTable('paketTable', rows, [
    { key:'namaPaket', label:'Paket' },
    { key:'bandwidth', label:'Bandwidth' },
    { key:'id', label:'Aksi', render:(r)=>{
        return `<div style="display:flex;gap:6px">
          <button class="btn ghost" onclick="editPaket('${r.id}')">âœï¸</button>
          <button class="btn ghost" onclick="deleteDoc('paket','${r.id}')">ğŸ—‘ï¸</button>
        </div>`;
      }}
  ]);
  // populate planSelect and planSelect in user form
  const sel = document.getElementById('planSelect');
  if(sel){
    sel.innerHTML = '<option value="">--Pilih Paket--</option>';
    rows.forEach(r=>{
      const o = document.createElement('option'); o.value = r.namaPaket; o.textContent = `${r.namaPaket} (${r.bandwidth})`;
      sel.appendChild(o);
    });
  }
});

window.editPaket = async function(id){
  const doc = await db.collection('paket').doc(id).get();
  if(!doc.exists) return alert('Data tidak ditemukan');
  const d = doc.data();
  document.getElementById('paketId').value = id;
  document.getElementById('namaPaket').value = d.namaPaket || '';
  document.getElementById('bandwidth').value = d.bandwidth || '';
};

window.deleteDoc = function(collection, id){
  if(confirm('Yakin hapus?')) db.collection(collection).doc(id).delete();
};

/* ---------- USER ---------- */
const userForm = document.getElementById('userForm');
userForm && userForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id = document.getElementById('userId').value;
  const userName = document.getElementById('userName').value.trim();
  const planName = document.getElementById('planSelect').value;
  const statusBayar = document.getElementById('statusBayar').value;
  if(!userName) return alert('Isi nama user');
  const payload = { userName, planName, statusBayar, createdAt:new Date().toISOString() };
  if(id) await db.collection('user').doc(id).update(payload);
  else {
    await db.collection('user').add(payload);
    // Auto-generate billing for new user (monthly first invoice)
    await generateBillingForUser(userName);
  }
  userForm.reset();
});

/* render users */
db.collection('user').onSnapshot(snapshot=>{
  const rows = [];
  snapshot.forEach(doc=> rows.push({ id:doc.id, ...doc.data() }));
  renderProfessionalTable('userTable', rows, [
    { key:'userName', label:'Nama' },
    { key:'planName', label:'Paket' },
    { key:'statusBayar', label:'Status Bayar' },
    { key:'id', label:'Aksi', render:(r)=>`<div style="display:flex;gap:6px"><button class="btn ghost" onclick="editUser('${r.id}')">âœï¸</button><button class="btn ghost" onclick="deleteDoc('user','${r.id}')">ğŸ—‘ï¸</button></div>` }
  ]);
  document.getElementById('totalUser').textContent = rows.length;

  // populate billing user select
  const bsel = document.getElementById('billingUser');
  if(bsel){
    bsel.innerHTML = '<option value="">--Pilih User--</option>';
    rows.forEach(r=>{
      const o = document.createElement('option'); o.value=r.userName; o.textContent = r.userName; bsel.appendChild(o);
    });
  }
});

window.editUser = async function(id){
  const doc = await db.collection('user').doc(id).get();
  if(!doc.exists) return alert('User tidak ditemukan');
  const d = doc.data();
  document.getElementById('userId').value = id;
  document.getElementById('userName').value = d.userName || '';
  document.getElementById('planSelect').value = d.planName || '';
  document.getElementById('statusBayar').value = d.statusBayar || 'Lunas';
};

/* ---------- BILLING ---------- */
const billingForm = document.getElementById('billingForm');
billingForm && billingForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id = document.getElementById('billingId').value;
  const billingUser = document.getElementById('billingUser').value;
  const billingAmount = parseFloat(document.getElementById('billingAmount').value);
  if(!billingUser||!billingAmount) return alert('Isi user & jumlah');
  const payload = { billingUser, billingAmount, status:'Belum', createdAt:new Date().toISOString() };
  if(id) await db.collection('billing').doc(id).update(payload);
  else await db.collection('billing').add(payload);
  billingForm.reset();
});

/* render billing */
db.collection('billing').orderBy('createdAt','desc').onSnapshot(snapshot=>{
  const rows = [];
  snapshot.forEach(doc=> rows.push({ id:doc.id, ...doc.data() }));
  renderProfessionalTable('billingTable', rows, [
    { key:'billingUser', label:'User' },
    { key:'billingAmount', label:'Jumlah', render:(r)=>`Rp ${Number(r.billingAmount).toLocaleString('id-ID')}` },
    { key:'status', label:'Status' },
    { key:'createdAt', label:'Tanggal', render:(r)=> formatISO(r.createdAt) },
    { key:'id', label:'Aksi', render:(r)=>`<div style="display:flex;gap:6px"><button class="btn ghost" onclick="markPaid('${r.id}')">Lunas</button><button class="btn ghost" onclick="deleteDoc('billing','${r.id}')">ğŸ—‘ï¸</button></div>` }
  ]);

  // count tunggakan
  const tunggakan = rows.filter(x=>x.status === 'Belum').length;
  document.getElementById('totalTunggakan').textContent = tunggakan;
});

window.markPaid = (id) => db.collection('billing').doc(id).update({ status: 'Lunas', paidAt: new Date().toISOString() });

/* Generate billing for one user (used when creating user) */
async function generateBillingForUser(userName){
  // Attempt to fetch paket price if available (optional)
  // Default amount fallback
  const defaultAmount = 100000;
  // create billing doc
  await db.collection('billing').add({ billingUser: userName, billingAmount: defaultAmount, status:'Belum', createdAt: new Date().toISOString() });
}

/* Generate billing for all users (manual trigger) */
async function generateAllBilling(){
  const snap = await db.collection('user').get();
  const batchPromises = [];
  snap.forEach(doc=>{
    const u = doc.data();
    const amount = 100000; // default or derive from paket
    batchPromises.push(db.collection('billing').add({ billingUser: u.userName, billingAmount: amount, status:'Belum', createdAt: new Date().toISOString() }));
  });
  await Promise.all(batchPromises);
  alert('Tagihan semua user berhasil dibuat.');
}

/* Export Billing to CSV */
async function exportBillingCSV(){
  const snap = await db.collection('billing').orderBy('createdAt','desc').get();
  let csv = 'User,Amount,Status,Date\n';
  snap.forEach(doc=>{
    const d = doc.data();
    csv += `${d.billingUser || ''},${d.billingAmount || ''},${d.status || ''},${d.createdAt || ''}\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'billing.csv'; a.click();
}

/* ---------- KAS ---------- */
const kasForm = document.getElementById('kasForm');
kasForm && kasForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id = document.getElementById('kasId').value;
  const kasKet = document.getElementById('kasKet').value.trim();
  const kasJumlah = parseFloat(document.getElementById('kasJumlah').value);
  if(!kasKet || isNaN(kasJumlah)) return alert('Isi data kas');
  const payload = { kasKet, kasJumlah, createdAt:new Date().toISOString() };
  if(id) await db.collection('kas').doc(id).update(payload);
  else await db.collection('kas').add(payload);
  kasForm.reset();
});

/* render kas table */
db.collection('kas').orderBy('createdAt','desc').onSnapshot(snapshot=>{
  const rows = [];
  snapshot.forEach(doc=> rows.push({ id:doc.id, ...doc.data() }));
  renderProfessionalTable('kasTable', rows, [
    { key:'kasKet', label:'Keterangan' },
    { key:'kasJumlah', label:'Jumlah', render:(r)=> `Rp ${Number(r.kasJumlah).toLocaleString('id-ID')}` },
    { key:'createdAt', label:'Tanggal', render:(r)=> formatISO(r.createdAt) },
    { key:'id', label:'Aksi', render:(r)=>`<div style="display:flex;gap:6px"><button class="btn ghost" onclick="editKas('${r.id}')">âœï¸</button><button class="btn ghost" onclick="deleteDoc('kas','${r.id}')">ğŸ—‘ï¸</button></div>` }
  ]);
  // compute saldo
  const saldo = rows.reduce((s,x)=> s + (parseFloat(x.kasJumlah || 0)), 0);
  document.getElementById('saldoKas').textContent = `Rp ${saldo.toLocaleString('id-ID')}`;
});

window.editKas = async (id) => {
  const doc = await db.collection('kas').doc(id).get();
  if(!doc.exists) return alert('Data kas tidak ditemukan');
  const d = doc.data();
  document.getElementById('kasId').value = id;
  document.getElementById('kasKet').value = d.kasKet || '';
  document.getElementById('kasJumlah').value = d.kasJumlah || '';
};

/* ---------- TEKNISI ---------- */
const teknisiForm = document.getElementById('teknisiForm');
teknisiForm && teknisiForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id = document.getElementById('teknisiId').value;
  const namaTeknisi = document.getElementById('namaTeknisi').value.trim();
  const kontakTeknisi = document.getElementById('kontakTeknisi').value.trim();
  if(!namaTeknisi) return alert('Isi nama teknisi');
  const payload = { namaTeknisi, kontakTeknisi };
  if(id) await db.collection('teknisi').doc(id).update(payload);
  else await db.collection('teknisi').add(payload);
  teknisiForm.reset();
});

/* render teknisi */
db.collection('teknisi').onSnapshot(snapshot=>{
  const rows = []; snapshot.forEach(doc=> rows.push({ id:doc.id, ...doc.data() }));
  renderProfessionalTable('teknisiTable', rows, [
    { key:'namaTeknisi', label:'Nama' },
    { key:'kontakTeknisi', label:'Kontak' },
    { key:'id', label:'Aksi', render:(r)=>`<div style="display:flex;gap:6px"><button class="btn ghost" onclick="editTeknisi('${r.id}')">âœï¸</button><button class="btn ghost" onclick="deleteDoc('teknisi','${r.id}')">ğŸ—‘ï¸</button></div>` }
  ]);
});

window.editTeknisi = async (id) => {
  const doc = await db.collection('teknisi').doc(id).get();
  if(!doc.exists) return alert('Teknisi tidak ditemukan');
  const d = doc.data();
  document.getElementById('teknisiId').value = id;
  document.getElementById('namaTeknisi').value = d.namaTeknisi || '';
  document.getElementById('kontakTeknisi').value = d.kontakTeknisi || '';
};

/* ---------- GANGGUAN (TTR realtime + assign teknisi) ---------- */
async function loadGangguanList(){
  const snap = await db.collection('gangguan').orderBy('waktu','desc').limit(200).get();
  const rows = [];
  snap.forEach(doc=> rows.push({ id:doc.id, ...doc.data() }));
  // render gangguan table with action: close, assign teknisi
  renderProfessionalTable('gangguanTable', rows, [
    { key:'user', label:'User' },
    { key:'indikasi', label:'Indikasi' },
    { key:'waktu', label:'Waktu', render:(r)=> formatISO(r.waktu) },
    { key:'ttr', label:'TTR', render:(r)=> computeTTRDisplay(r) },
    { key:'status', label:'Status' },
    { key:'teknisi', label:'Teknisi', render:(r)=> r.teknisi || '-' },
    { key:'id', label:'Aksi', render:(r)=> {
        const btnClose = r.status === 'Aktif' ? `<button class="btn ghost" onclick="closeGangguan('${r.id}')">Close</button>` : '-';
        const assignBtn = `<button class="btn ghost" onclick="showAssignTeknisi('${r.id}')">Assign</button>`;
        return `<div style="display:flex;gap:6px">${btnClose}${assignBtn}</div>`;
    }}
  ]);
  // also for dashboard (latest 10)
  const dashRows = rows.slice(0,10);
  renderProfessionalTable('dashboardGangguan', dashRows, [
    { key:'user' }, { key:'indikasi' }, { key:'waktu', render:(r)=>formatISO(r.waktu) }, { key:'ttr', render:(r)=> computeTTRDisplay(r) }, { key:'status' }
  ]);
  const activeCount = rows.filter(r=> r.status === 'Aktif').length;
  document.getElementById('totalGangguan').textContent = activeCount;
}

function computeTTRDisplay(r){
  if(r.status !== 'Aktif' && r.ttr) return r.ttr;
  if(r.status === 'Aktif' && r.waktu){
    const diff = Date.now() - new Date(r.waktu).getTime();
    const hrs = Math.floor(diff/1000/3600);
    const mins = Math.floor((diff/1000/60)%60);
    const secs = Math.floor((diff/1000)%60);
    return `${String(hrs).padStart(2,'0')}:${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
  }
  return '00:00:00';
}

async function simulateGangguan(){
  const usersSnap = await db.collection('user').get();
  if(usersSnap.empty) return alert('Belum ada user tersimpan untuk simulasi');
  const users = []; usersSnap.forEach(d=> users.push(d.data().userName));
  const randomUser = users[Math.floor(Math.random()*users.length)];
  const doc = { user: randomUser, indikasi:'Koneksi putus', waktu: new Date().toISOString(), status:'Aktif' };
  await db.collection('gangguan').add(doc);
}

window.clearGangguan = async function(){
  if(!confirm('Yakin hapus semua gangguan?')) return;
  const snap = await db.collection('gangguan').get();
  const batch = db.batch();
  snap.forEach(doc => batch.delete(doc.ref));
  await batch.commit();
  await loadGangguanList();
}

window.closeGangguan = async function(id){
  const doc = await db.collection('gangguan').doc(id).get();
  if(!doc.exists) return;
  const d = doc.data();
  const diff = Date.now() - new Date(d.waktu).getTime();
  const hrs = Math.floor(diff/1000/3600);
  const mins = Math.floor((diff/1000/60)%60);
  const secs = Math.floor((diff/1000)%60);
  const ttr = `${String(hrs).padStart(2,'0')}:${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
  await db.collection('gangguan').doc(id).update({ status:'Selesai', ttr, resolvedAt:new Date().toISOString() });
  await loadGangguanList();
}

window.showAssignTeknisi = async function(gangguanId){
  // render small prompt to choose teknisi (simple prompt)
  const snap = await db.collection('teknisi').get();
  const teknisi = [];
  snap.forEach(d=> teknisi.push(d.data().namaTeknisi));
  const choice = prompt(`Masukkan nama teknisi untuk ditugaskan:\n${teknisi.join(', ')}`);
  if(choice){
    await db.collection('gangguan').doc(gangguanId).update({ teknisi: choice, status:'Sedang Ditangani' });
    await loadGangguanList();
  }
}

/* Setup listener for new gangguan to show browser alert (realtime) */
db.collection('gangguan').orderBy('waktu','desc').limit(1).onSnapshot(sn=>{
  sn.docChanges().forEach(change=>{
    if(change.type === 'added'){
      const d = change.doc.data();
      if(d && d.status === 'Aktif'){
        // browser alert (simple)
        console.info('New incident:', d);
        try { if(window.Notification && Notification.permission === "granted"){ new Notification("Gangguan baru", { body: `${d.user} â€” ${d.indikasi}` }); } } catch(e){}
        // also a simple alert fallback
        // alert('âš ï¸ Gangguan baru: ' + d.user + ' â€” ' + d.indikasi);
      }
    }
  });
});

/* Polling ttr update - refresh displayed TTRs every second for active incidents */
setInterval(async ()=>{ await loadGangguanList(); }, 1000);

/* ---------- ODP ---------- */
const odpForm = document.getElementById('odpForm');
odpForm && odpForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id = document.getElementById('odpId').value;
  const kode = document.getElementById('odpKode').value.trim();
  const lokasi = document.getElementById('odpLokasi').value.trim();
  const kapasitas = parseInt(document.getElementById('odpKapasitas').value) || 0;
  if(!kode) return alert('Isi kode ODP');
  const payload = { kode, lokasi, kapasitas, createdAt:new Date().toISOString() };
  if(id) await db.collection('odp').doc(id).update(payload);
  else await db.collection('odp').add(payload);
  odpForm.reset();
});
db.collection('odp').onSnapshot(snapshot=>{
  const rows = []; snapshot.forEach(doc=> rows.push({ id:doc.id, ...doc.data() }));
  renderProfessionalTable('odpTable', rows, [
    { key:'kode', label:'Kode' },
    { key:'lokasi', label:'Lokasi' },
    { key:'kapasitas', label:'Kapasitas' },
    { key:'id', label:'Aksi', render:(r)=>`<div style="display:flex;gap:6px"><button class="btn ghost" onclick="editODP('${r.id}')">âœï¸</button><button class="btn ghost" onclick="deleteDoc('odp','${r.id}')">ğŸ—‘ï¸</button></div>` }
  ]);
});
window.editODP = async (id) => {
  const doc = await db.collection('odp').doc(id).get();
  if(!doc.exists) return alert('ODP tidak ditemukan');
  const d = doc.data();
  document.getElementById('odpId').value = id;
  document.getElementById('odpKode').value = d.kode || '';
  document.getElementById('odpLokasi').value = d.lokasi || '';
  document.getElementById('odpKapasitas').value = d.kapasitas || '';
};

/* ---------- MATERIAL ---------- */
const materialForm = document.getElementById('materialForm');
materialForm && materialForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id = document.getElementById('materialId').value;
  const namaMaterial = document.getElementById('namaMaterial').value.trim();
  const stokMaterial = parseInt(document.getElementById('stokMaterial').value) || 0;
  if(!namaMaterial) return alert('Isi nama material');
  const payload = { namaMaterial, stokMaterial, updatedAt:new Date().toISOString() };
  if(id) await db.collection('material').doc(id).update(payload);
  else await db.collection('material').add(payload);
  materialForm.reset();
});
db.collection('material').onSnapshot(snapshot=>{
  const rows = []; snapshot.forEach(doc=> rows.push({ id:doc.id, ...doc.data() }));
  renderProfessionalTable('materialTable', rows, [
    { key:'namaMaterial', label:'Material' },
    { key:'stokMaterial', label:'Stok' },
    { key:'id', label:'Aksi', render:(r)=>`<div style="display:flex;gap:6px"><button class="btn ghost" onclick="editMaterial('${r.id}')">âœï¸</button><button class="btn ghost" onclick="deleteDoc('material','${r.id}')">ğŸ—‘ï¸</button></div>` }
  ]);
});
window.editMaterial = async (id) => {
  const doc = await db.collection('material').doc(id).get();
  if(!doc.exists) return alert('Material tidak ditemukan');
  const d = doc.data();
  document.getElementById('materialId').value = id;
  document.getElementById('namaMaterial').value = d.namaMaterial || '';
  document.getElementById('stokMaterial').value = d.stokMaterial || '';
};

/* ---------- UTIL: edit ISP name ---------- */
function applyISPName(){
  const v = document.getElementById('newISPName').value.trim();
  if(!v) return alert('Isi nama ISP');
  // update the sidebar header text only (do not persist unless desired)
  const el = document.querySelector('.isp-title .text');
  if(el) el.textContent = v;
  alert('Nama ISP diperbarui');
}

/* ---------- Small UI helpers (search) ---------- */
document.getElementById('userSearch')?.addEventListener('input', function(e){
  const q = e.target.value.toLowerCase();
  document.querySelectorAll('#userTable tbody tr').forEach(tr=>{
    tr.style.display = tr.innerText.toLowerCase().includes(q) ? '' : 'none';
  });
});

/* ---------- INITIAL LOAD ---------- */
/* Show dashboard by default */
showSection('dashboard');

/* initial data load calls */
loadGangguanList();

/* ---------- Utility functions ---------- */
function formatISO(d){ if(!d) return ''; const dt = (typeof d === 'string') ? new Date(d) : d; return dt.toLocaleString(); }

/* convenience delete wrapper already defined earlier as deleteDoc */

/* Expose some functions globally for inline onclicks */
window.generateAllBilling = generateAllBilling;
window.exportBillingCSV = exportBillingCSV;
window.simulateGangguan = simulateGangguan;
window.clearGangguan = window.clearGangguan;
window.deleteDoc = deleteDoc;
window.loadGangguanList = loadGangguanList;
window.applyISPName = applyISPName;

/* Request Notification permission for nicer alerts (optional) */
if("Notification" in window && Notification.permission !== "granted"){
  Notification.requestPermission().catch(()=>{});
}

/* End of script */
</script>
</body>
</html>

