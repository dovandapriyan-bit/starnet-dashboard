<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <title>Starnet Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
        :root {
            --bg: #f6f7fb; --card: #ffffff; --text: #1f2937; --muted: #6b7280;
            --primary: #6d28d9; --primary-600: #5b21b6; --primary-50: #ede9fe;
            --border: #e5e7eb; --success: #16a34a; --success-bg: #dcfce7;
            --danger: #dc2626; --danger-bg: #fee2e2; --warn: #f59e0b;
        }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: Inter, Segoe UI, Arial, sans-serif; background: var(--bg); color: var(--text); }
        .sidebar { position: fixed; inset: 0 auto 0 0; width: 260px; background: #2a1154; color: #fff; display: flex; flex-direction: column; transition: width 0.3s ease; z-index: 100; }
        .sidebar.collapsed { width: 80px; }
        .sidebar.collapsed .brand h1, .sidebar.collapsed nav a span { display: none; }
        .sidebar.collapsed .nav a { justify-content: center; }
        .brand { display: flex; align-items: center; justify-content: space-between; padding: 22px 18px; border-bottom: 1px solid rgba(255, 255, 255, 0.08); }
        .brand h1 { margin: 0; font-size: 18px; font-weight: 800; letter-spacing: 3px; white-space: nowrap; }
        .nav { padding: 10px; overflow-y: auto; flex-grow: 1; }
        .nav a { display: flex; align-items: center; gap: 10px; padding: 10px 12px; margin-bottom: 6px; color: #d6d3ff; text-decoration: none; border-radius: 12px; transition: .15s; white-space: nowrap; }
        .nav a i { font-size: 1.2rem; min-width: 24px; text-align: center; }
        .nav a:hover { background: rgba(255, 255, 255, 0.08); color: #fff; }
        .nav a.active { background: rgba(255, 255, 255, .16); color: #fff; }
        main { margin-left: 260px; padding: 24px; transition: margin-left 0.3s ease; }
        main.collapsed { margin-left: 80px; }
        .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 18px; }
        .header h2 { margin: 0; font-size: 22px; }
        .hamburger-btn { font-size: 24px; cursor: pointer; color: #fff; background: none; border: none; }
        .sidebar.collapsed .hamburger-btn { margin: 0 auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; box-shadow: 0 1px 3px rgba(0, 0, 0, .04); padding: 16px; margin-bottom: 16px; }
        .card h4 { margin-top:0; margin-bottom: 12px; color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 8px;}
        .stat { display: flex; flex-direction: column; }
        .stat span { font-weight: 800; font-size: 26px; }
        .stat small { color: var(--muted); }
        form .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
        label { font-size: 13px; color: var(--muted); margin-top: 6px; display: block; margin-bottom: 4px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 10px; background: #fff; font-family: inherit; font-size: 14px; }
        button { border: 0; border-radius: 10px; padding: 10px 14px; cursor: pointer; font-weight: 700; transition: .2s; }
        button:disabled { cursor: not-allowed; opacity: 0.7; }
        .btn.primary { background: var(--primary); color: #fff; }
        .btn.primary:hover:not(:disabled) { background: var(--primary-600); }
        .btn.success { background: var(--success); color: #fff; }
        .btn.danger { background: var(--danger); color: #fff; }
        .btn.ghost { background: transparent; color: var(--primary); }
        .btn.ghost.danger { color: var(--danger); }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 10px; border-bottom: 1px solid var(--border); font-size: 13.5px; vertical-align: middle; white-space: nowrap; }
        th { background: #f9fafb; text-align: left; font-weight: 600; color: var(--muted); }
        tr:hover { background: #faf5ff; }
        .spacer { height: 12px; }
        .section { display: none; }
        .section.active { display: block; }
        .hidden { display: none; }
        .badge { padding: 4px 10px; border-radius: 999px; font-weight: 700; font-size: 12px; text-transform: capitalize; }
        .badge.enabled { background: var(--success-bg); color: var(--success); }
        .badge.disabled { background: var(--danger-bg); color: var(--danger); }
        .badge.lunas { background: var(--success-bg); color: var(--success); }
        .badge.belum { background: var(--danger-bg); color: var(--danger); }
        .mini { font-size: 11px; padding: 4px 6px; }
        #seeding-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); color: white; display: flex; justify-content: center; align-items: center; text-align: center; z-index: 9999; flex-direction: column; }
        #seeding-overlay h2 { margin-bottom: 10px; }
        #seeding-overlay p { margin-top: 0; font-size: 1.1em; }
    </style>
</head>
<body>
    <div id="seeding-overlay" class="hidden">
        <div>
            <h2><i class="bi bi-database-add"></i> Sedang Membuat Data Dummy...</h2>
            <p>Sistem sedang diisi dengan 1000 pelanggan dan riwayat data. Proses ini hanya berjalan sekali.<br>Mohon tunggu sebentar, jangan tutup halaman ini.</p>
            <p id="seeding-progress">Mempersiapkan...</p>
        </div>
    </div>

    <aside class="sidebar" id="sidebar">
        <div class="brand">
            <h1 id="ispName">Starnet</h1>
            <button id="sidebar-toggle" class="hamburger-btn"><i class="bi bi-list"></i></button>
        </div>
        <nav class="nav">
            <a href="#" class="active" onclick="showSection('dashboard', this)"><i class="bi bi-speedometer2"></i><span>Dashboard</span></a>
            <a href="#" onclick="showSection('pasangbaru', this)"><i class="bi bi-person-plus-fill"></i><span>Pasang Baru</span></a>
            <a href="#" onclick="showSection('user', this)"><i class="bi bi-people-fill"></i><span>Data User</span></a>
            <a href="#" onclick="showSection('mikrotik', this)"><i class="bi bi-router-fill"></i><span>MikroTik</span></a>
            <a href="#" onclick="showSection('paket', this)"><i class="bi bi-wifi"></i><span>Paket</span></a>
            <a href="#" onclick="showSection('billing', this)"><i class="bi bi-receipt"></i><span>Billing</span></a>
            <a href="#" onclick="showSection('kas', this)"><i class="bi bi-bank"></i><span>Kas</span></a>
            <a href="#" onclick="showSection('teknisi', this)"><i class="bi bi-person-badge"></i><span>Teknisi</span></a>
            <a href="#" onclick="showSection('gangguan', this)"><i class="bi bi-exclamation-triangle-fill"></i><span>Gangguan</span></a>
            <a href="#" onclick="showSection('material', this)"><i class="bi bi-tools"></i><span>Material</span></a>
            <a href="#" onclick="showSection('odp', this)"><i class="bi bi-box-seam"></i><span>ODP</span></a>
            <a href="#" onclick="showSection('pengaturan', this)"><i class="bi bi-gear-fill"></i><span>Pengaturan</span></a>
            <a href="#" onclick="logout()"><i class="bi bi-box-arrow-right"></i><span>Logout</span></a>
        </nav>
    </aside>

    <main class="main" id="main-content">
        <!-- DASHBOARD -->
        <section id="dashboard" class="section active">
            <div class="header"><h2>Dashboard</h2></div>
            <div class="grid">
                <div class="card"><div class="stat"><span id="totalUser">0</span><small>Total User Aktif</small></div></div>
                <div class="card"><div class="stat"><span id="saldoKas">Rp 0</span><small>Saldo Kas</small></div></div>
                <div class="card"><div class="stat"><span id="totalTunggakan">0</span><small>User Menunggak</small></div></div>
                <div class="card"><div class="stat"><span id="totalGangguan">0</span><small>Gangguan Open</small></div></div>
            </div>
        </section>

        <!-- PASANG BARU -->
        <section id="pasangbaru" class="section">
            <div class="header"><h2>Pendaftaran Pasang Baru</h2></div>
            <div class="card">
                <form id="pasangBaruForm">
                    <input type="hidden" id="pasangbaruId" />
                    <div class="row">
                        <div><label>Nomor Internet</label><input id="pbInternetNo" required readonly /></div>
                        <div><label>Nama</label><input id="pbNama" required /></div>
                        <div><label>Alamat</label><textarea id="pbAlamat" required></textarea></div>
                        <div><label>No HP</label><input id="pbHP" required /></div>
                        <div><label>Paket</label><select id="pbPlan" required></select></div>
                        <div><label>SN ONT</label><input id="pbSN" /></div>
                        <div><label>ODP</label><input id="pbODP" /></div>
                    </div>
                    <div class="spacer"></div>
                    <button class="btn primary" type="submit">Simpan Pendaftaran</button>
                </form>
            </div>
            <div class="card">
                <div class="toolbar"><input id="pbSearch" placeholder="Cari (nomor / nama / ODP/SN)" class="w-100"></div>
                <div class="spacer"></div>
                <div class="table-wrapper">
                    <table id="pasangBaruTable">
                        <thead><tr><th>Nomor Internet</th><th>Nama</th><th>Alamat</th><th>HP</th><th>Paket</th><th>Aksi</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- USER -->
        <section id="user" class="section">
            <div class="header"><h2>Manajemen Data User</h2></div>
            <div class="card">
                <form id="userForm">
                    <input type="hidden" id="userId" />
                    <div class="row" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                        <div>
                            <h4>Data Pelanggan</h4>
                            <div><label>Nomor Internet</label><input id="internetNo" required /></div>
                            <div><label>Nama</label><input id="userName" required /></div>
                            <div><label>No HP</label><input id="noHp" required /></div>
                            <div><label>Alamat</label><textarea id="alamat" required></textarea></div>
                        </div>
                        <div>
                            <h4>Data Teknis & Jaringan</h4>
                            <div><label>Nama User PPPoE (di MikroTik)</label><input id="pppoeUser" placeholder="Harus sama persis" required /></div>
                            <div><label>Paket</label><select id="planName" required></select></div>
                            <div><label>SN ONT</label><input id="snOnt" /></div>
                            <div><label>ODP</label><input id="odpUser" /></div>
                            <div><label>Port ODP</label><input id="portOdp" type="number" /></div>
                            <div><label>Port OLT</label><input id="portOlt" /></div>
                            <div><label>Redaman ONT (dB)</label><input id="redamanOnt" /></div>
                        </div>
                        <div>
                            <h4>Lain-lain</h4>
                            <div><label>Tagging Lokasi</label><input id="geoTag" /></div>
                            <div><label>Status Awal Koneksi</label><select id="connectionStatus"><option value="enabled">Enabled</option><option value="disabled">Disabled</option></select></div>
                        </div>
                    </div>
                    <div class="spacer"></div>
                    <button class="btn primary" type="submit">Simpan User</button>
                </form>
            </div>
            <div class="card">
                <div class="toolbar"><input id="userSearch" placeholder="Cari (nama / user pppoe / no internet / ODP)" class="w-100"></div>
                <div class="spacer"></div>
                <div class="table-wrapper">
                    <table id="userTable">
                        <thead><tr><th>No Internet</th><th>Nama</th><th>User PPPoE</th><th>Paket</th><th>Alamat</th><th>HP</th><th>ODP</th><th>Aksi</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <!-- MIKROTIK -->
        <section id="mikrotik" class="section">
            <div class="header"><h2>Manajemen Koneksi MikroTik</h2></div>
            <div class="card">
                <p class="muted" style="font-size: 14px; margin-top: 0;">Gunakan halaman ini untuk enable/disable koneksi user PPPoE di router. Pastikan konfigurasi API sudah benar di menu <a href="#" onclick="showSection('pengaturan', document.querySelector('.nav a[onclick*=\'pengaturan\']'))">Pengaturan</a>.</p>
                <div class="toolbar"><input id="mikrotikUserSearch" placeholder="Cari user berdasarkan Nama atau User PPPoE..." class="w-100"></div>
                <div class="spacer"></div>
                 <div class="table-wrapper">
                    <table id="mikrotikUserTable">
                        <thead><tr><th>Status</th><th>Nama Pelanggan</th><th>User PPPoE</th><th>No Internet</th><th>Aksi</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- PAKET -->
        <section id="paket" class="section">
             <div class="header"><h2>Manajemen Paket</h2></div>
             <div class="card">
                <form id="paketForm">
                    <input type="hidden" id="paketId" />
                    <div class="row">
                        <div><label>Nama Paket</label><input id="namaPaket" required /></div>
                        <div><label>Bandwidth</label><input id="bandwidth" required /></div>
                        <div><label>Harga Paket (Rp)</label><input id="hargaPaket" type="number" min="0" step="1000" required /></div>
                    </div>
                    <div class="spacer"></div><button class="btn primary" type="submit">Simpan Paket</button>
                </form>
            </div>
            <div class="card">
                <div class="table-wrapper">
                    <table id="paketTable">
                        <thead><tr><th>Paket</th><th>Bandwidth</th><th>Harga</th><th>Aksi</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- BILLING -->
        <section id="billing" class="section">
             <div class="header"><h2>Billing</h2></div>
             <div class="card">
                <div class="toolbar">
                    <input id="billingSearch" placeholder="Cari (nomor / nama / periode)..." style="flex-grow:1">
                    <select id="billingStatusFilter"><option value="">Semua Status</option><option value="Lunas">Lunas</option><option value="Belum">Belum</option></select>
                    <button class="btn primary" onclick="generateBills()">Generate Bulan Ini</button>
                </div>
                <div class="spacer"></div>
                <div class="table-wrapper">
                    <table id="billingTable">
                        <thead><tr><th>No Internet</th><th>Nama</th><th>Periode</th><th>Jumlah</th><th>Status</th><th>Aksi</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
             </div>
        </section>
        
        <!-- KAS -->
        <section id="kas" class="section">
            <div class="header"><h2>Kas</h2></div>
            <div class="card">
                <form id="kasForm">
                    <input type="hidden" id="kasId" />
                    <div class="row">
                        <div><label>Tanggal</label><input id="kasTanggal" type="date" required /></div>
                        <div><label>Keterangan</label><input id="kasKet" required /></div>
                        <div><label>Tipe</label><select id="kasTipe"><option>Masuk</option><option>Keluar</option></select></div>
                        <div><label>Jumlah (Rp)</label><input id="kasJumlah" type="number" step="1000" required /></div>
                    </div>
                    <div class="spacer"></div><button class="btn primary" type="submit">Simpan Transaksi</button>
                </form>
            </div>
            <div class="card">
                <div class="toolbar"><input id="kasSearch" placeholder="Cari (keterangan)..." style="flex-grow:1"></div>
                <div class="spacer"></div>
                <div class="table-wrapper">
                    <table id="kasTable">
                        <thead><tr><th>Tanggal</th><th>Keterangan</th><th>Tipe</th><th>Jumlah</th><th>Aksi</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- TEKNISI -->
        <section id="teknisi" class="section">
            <div class="header"><h2>Teknisi</h2></div>
            <div class="card">
                <form id="teknisiForm">
                    <input type="hidden" id="teknisiId" />
                    <div class="row">
                        <div><label>Nama Teknisi</label><input id="namaTeknisi" required /></div>
                        <div><label>No HP</label><input id="kontakTeknisi" required /></div>
                    </div>
                    <div class="spacer"></div><button class="btn primary" type="submit">Simpan Teknisi</button>
                </form>
            </div>
            <div class="card">
                <div class="table-wrapper">
                    <table id="teknisiTable">
                        <thead><tr><th>Nama</th><th>Kontak</th><th>Aksi</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- GANGGUAN -->
        <section id="gangguan" class="section">
            <div class="header"><h2>Manajemen Gangguan</h2></div>
            <div class="card">
                <form id="gangguanForm">
                    <input type="hidden" id="gangguanId" />
                    <h4>Buka Tiket Gangguan Baru</h4>
                    <div class="row">
                        <div><label>Nomor Internet</label><input id="gtInternetNo" required onblur="autofillGangguanForm(this.value)" /></div>
                        <div><label>Nama</label><input id="gtNama" readonly /></div>
                        <div><label>Jenis Gangguan</label><select id="gtJenis"><option>LOS</option><option>Intermittent</option><option>Lambat</option><option>Lainnya</option></select></div>
                        <div><label>Keterangan</label><input id="gtKeterangan" placeholder="mis. kabel putus" required/></div>
                    </div>
                    <div class="spacer"></div><button class="btn primary" type="submit">Buka Tiket</button>
                </form>
            </div>
            <div class="card">
                <div class="toolbar">
                    <input id="gangguanSearch" placeholder="Cari (nomor / nama)..." style="flex-grow:1">
                    <select id="gangguanStatusFilter"><option value="">Semua Status</option><option value="Open">Open</option><option value="Closed">Closed</option></select>
                </div>
                <div class="spacer"></div>
                <div class="table-wrapper">
                    <table id="gangguanTable">
                        <thead><tr><th>No Tiket</th><th>No Internet</th><th>Nama</th><th>Jenis</th><th>Keterangan</th><th>Status</th><th>Aksi</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- MATERIAL -->
        <section id="material" class="section">
            <div class="header"><h2>Material</h2></div>
            <div class="card">
                <form id="materialForm">
                    <input type="hidden" id="materialId" />
                    <div class="row">
                        <div><label>Nama Material</label><input id="namaMaterial" required /></div>
                        <div><label>Satuan</label><input id="satuanMaterial" placeholder="mis. Pcs, Meter" /></div>
                        <div><label>Stok Awal</label><input id="stokAwal" type="number" value="0" /></div>
                        <div><label>Usage</label><input id="usage" type="number" value="0" readonly /></div>
                        <div><label>Stok Akhir</label><input id="stokAkhir" type="number" readonly /></div>
                    </div>
                    <div class="spacer"></div><button class="btn primary" type="submit">Simpan Material</button>
                </form>
            </div>
            <div class="card">
                <div class="table-wrapper">
                    <table id="materialTable">
                        <thead><tr><th>Nama</th><th>Satuan</th><th>Stok Awal</th><th>Usage</th><th>Stok Akhir</th><th>Aksi</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- ODP -->
        <section id="odp" class="section">
            <div class="header"><h2>ODP</h2></div>
            <div class="card">
                <form id="odpForm">
                    <input type="hidden" id="odpId" />
                    <div class="row">
                        <div><label>Nama ODP</label><input id="namaOdp" required /></div>
                        <div><label>Kapasitas Port</label><input id="kapasitasOdp" type="number" value="8" required /></div>
                        <div><label>Lokasi</label><input id="lokasiOdp" /></div>
                    </div>
                    <div class="spacer"></div><button class="btn primary" type="submit">Simpan ODP</button>
                </form>
            </div>
            <div class="card">
                <div class="toolbar"><input id="odpSearch" placeholder="Cari ODP..." class="w-100"></div>
                <div class="spacer"></div>
                <div class="table-wrapper">
                    <table id="odpTable">
                        <thead><tr><th>Nama</th><th>Kapasitas</th><th>Lokasi</th><th>Aksi</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- PENGATURAN -->
        <section id="pengaturan" class="section">
            <div class="header"><h2>Pengaturan & Konfigurasi</h2></div>
            <div class="card">
                <form id="editIspForm">
                    <h4>Profil ISP</h4>
                    <div class="row" style="align-items: flex-start;">
                        <div style="flex-grow: 1;">
                            <div><label>Nama ISP</label><input id="editIspName" required /></div>
                            <div><label>Alamat</label><textarea id="editIspAlamat"></textarea></div>
                            <div><label>Kontak</label><input id="editIspKontak" /></div>
                        </div>
                        <div>
                            <label>Logo ISP</label>
                            <img id="logoPreview" src="https://placehold.co/150x150/e2e8f0/e2e8f0?text=LOGO" alt="Logo Preview" style="width: 120px; height: 120px; border-radius: 12px; object-fit: cover; border: 1px solid var(--border); margin-bottom: 8px;">
                            <input type="file" id="editIspLogoFile" accept="image/*">
                            <input type="hidden" id="editIspLogoUrl">
                        </div>
                    </div>
                    <div class="spacer"></div>
                    <button class="btn primary" type="submit" id="saveIspButton"><span id="saveIspButtonText">Simpan Profil</span></button>
                </form>
            </div>
            <div class="card">
                 <form id="mikrotikConfigForm">
                    <h4>Konfigurasi MikroTik API</h4>
                    <p class="muted" style="font-size: 13px; margin-top: -10px;">Informasi ini dibutuhkan untuk enable/disable user.</p>
                    <div class="row">
                        <div><label>URL Skrip Perantara</label><input id="mikrotikApiUrl" placeholder="https://server-anda.com/mikrotik.php" /></div>
                        <div><label>IP Address Router</label><input id="mikrotikIp" placeholder="192.168.88.1" /></div>
                        <div><label>Username Router</label><input id="mikrotikUser" /></div>
                        <div><label>Password Router</label><input id="mikrotikPass" type="password" /></div>
                    </div>
                     <div class="spacer"></div>
                    <button class="btn primary" type="submit" id="saveMikrotikButton"><span id="saveMikrotikButtonText">Simpan Konfigurasi</span></button>
                 </form>
            </div>
        </section>

        <!-- Print Area -->
        <div id="printArea" class="hidden"></div>
    </main>

    <script>
        /* =================================================================
         * ========================= Firebase ==============================
         * ================================================================= */
        const firebaseConfig = {
            apiKey: "AIzaSyB-iBpZNC0YZBTAUzir7gJuU9kBQg82moc",
            authDomain: "dnt-network-7.firebaseapp.com",
            projectId: "dnt-network-7",
            storageBucket: "dnt-network-7.appspot.com",
            messagingSenderId: "761179668371",
            appId: "1:761179668371:web:7d1468d0298041d4783266",
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        /* =================================================================
         * ======================== Global Init ============================
         * ================================================================= */
        document.addEventListener('DOMContentLoaded', async () => {
            // Check if data seeding is needed
            await checkAndSeedDatabase();

            // Regular app initialization
            loadIspProfile();
            populatePaketDropdowns();
            setupDashboardListeners();
            setupAllRenderers();
            setupAllFormSubmissions();
            
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            document.getElementById('sidebar-toggle').addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('collapsed');
            });
        });
        
        function setupAllRenderers() {
            renderPasangBaruTable();
            renderUserTable();
            renderMikrotikTable();
            renderPaketTable();
            renderBillingTable();
            renderKasTable();
            renderTeknisiTable();
            renderGangguanTable();
            renderMaterialTable();
            renderOdpTable();
            document.getElementById('pbSearch').addEventListener('input', renderPasangBaruTable);
            document.getElementById('userSearch').addEventListener('input', renderUserTable);
            document.getElementById('mikrotikUserSearch').addEventListener('input', renderMikrotikTable);
            document.getElementById('billingSearch').addEventListener('input', renderBillingTable);
            document.getElementById('billingStatusFilter').addEventListener('change', renderBillingTable);
            document.getElementById('kasSearch').addEventListener('input', renderKasTable);
            document.getElementById('gangguanSearch').addEventListener('input', renderGangguanTable);
            document.getElementById('gangguanStatusFilter').addEventListener('change', renderGangguanTable);
            document.getElementById('odpSearch').addEventListener('input', renderOdpTable);
        }

        function setupAllFormSubmissions() {
            document.getElementById("pasangBaruForm").onsubmit = (e) => saveForm(e, "pasang_baru", "pasangbaruId", ["pbInternetNo", "pbNama", "pbAlamat", "pbHP", "pbPlan", "pbSN", "pbODP"]);
            document.getElementById("userForm").onsubmit = (e) => saveForm(e, "user", "userId", ["internetNo", "userName", "pppoeUser", "alamat", "noHp", "planName", "snOnt", "odpUser", "portOlt", "portOdp", "redamanOnt", "geoTag", "connectionStatus"]);
            document.getElementById("paketForm").onsubmit = (e) => saveForm(e, "paket", "paketId", ["namaPaket", "bandwidth", "hargaPaket"]);
            document.getElementById("kasForm").onsubmit = (e) => saveForm(e, "kas", "kasId", ["kasTanggal", "kasKet", "kasTipe", "kasJumlah"]);
            document.getElementById("teknisiForm").onsubmit = (e) => saveForm(e, "teknisi", "teknisiId", ["namaTeknisi", "kontakTeknisi"]);
            document.getElementById("gangguanForm").onsubmit = (e) => saveForm(e, "gangguan", "gangguanId", ["gtInternetNo", "gtNama", "gtJenis", "gtKeterangan", "ticketNo"], { status: 'Open' });
            document.getElementById("materialForm").onsubmit = (e) => saveForm(e, "material", "materialId", ["namaMaterial", "satuanMaterial", "stokAwal", "usage", "stokAkhir"]);
            document.getElementById("odpForm").onsubmit = (e) => saveForm(e, "odp", "odpId", ["namaOdp", "kapasitasOdp", "lokasiOdp"]);
            document.getElementById('editIspForm').onsubmit = saveIspProfile;
            document.getElementById('mikrotikConfigForm').onsubmit = saveMikrotikConfig;
            document.getElementById('editIspLogoFile').addEventListener('change', previewLogo);
            document.getElementById('stokAwal').addEventListener('input', calculateStock);
        }

        /* =================================================================
         * =========================== Helpers =============================
         * ================================================================= */
        function showSection(id, el) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
            if (el) el.classList.add('active');
            if (id === 'pasangbaru') generateNextInternetNo();
        }

        function logout() { if (confirm("Anda yakin ingin logout?")) { alert("Anda telah logout."); window.location.reload(); } }

        async function saveForm(e, collection, idField, fields, additionalData = {}) {
            e.preventDefault();
            const id = document.getElementById(idField).value;
            let data = { ...additionalData };
            fields.forEach(f => { if(document.getElementById(f)) data[f] = document.getElementById(f).value });
            try {
                if (id) await db.collection(collection).doc(id).update(data);
                else {
                    if (collection === 'gangguan') data.ticketNo = await getNextTicketNumber();
                    await db.collection(collection).add(data);
                }
                e.target.reset();
                document.getElementById(idField).value = "";
                if (collection === 'pasang_baru') generateNextInternetNo();
            } catch (error) { console.error("Error saving form:", error); alert("Gagal menyimpan data."); }
        }

        function editItem(collection, id, idField, fields) {
            db.collection(collection).doc(id).get().then(doc => {
                if (!doc.exists) return;
                const d = doc.data();
                fields.forEach(k => { if (document.getElementById(k)) document.getElementById(k).value = d[k] || ''; });
                document.getElementById(idField).value = id;
                showSection(collection, document.querySelector(`.nav a[onclick*="'${collection}'"]`));
                window.scrollTo(0, 0);
            });
        }

        function deleteItem(collection, id) { if (confirm('Anda yakin ingin menghapus item ini?')) db.collection(collection).doc(id).delete(); }
        
        function populatePaketDropdowns() {
            const selectors = ['#pbPlan', '#planName'];
            db.collection('paket').onSnapshot(snap => {
                selectors.forEach(selector => {
                    const sel = document.querySelector(selector);
                    if (!sel) return;
                    const currentVal = sel.value;
                    sel.innerHTML = "<option value=''>Pilih Paket</option>";
                    snap.forEach(doc => {
                        const p = doc.data();
                        sel.innerHTML += `<option value="${p.namaPaket}" data-harga="${p.hargaPaket}">${p.namaPaket} (${p.bandwidth})</option>`;
                    });
                    sel.value = currentVal;
                });
            });
        }

        /* =================================================================
         * ========================= DASHBOARD =============================
         * ================================================================= */
        function setupDashboardListeners() {
            const formatCurrency = (num) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);
            db.collection("user").onSnapshot(snap => { document.getElementById("totalUser").textContent = snap.size; });
            db.collection("kas").onSnapshot(snap => {
                let saldo = 0;
                snap.forEach(doc => {
                    const trx = doc.data();
                    const jumlah = parseFloat(trx.kasJumlah) || 0;
                    if (trx.kasTipe === 'Masuk') saldo += jumlah; else saldo -= jumlah;
                });
                document.getElementById("saldoKas").textContent = formatCurrency(saldo);
            });
            db.collection("billing").where("status", "==", "Belum").onSnapshot(snap => { document.getElementById("totalTunggakan").textContent = snap.size; });
            db.collection("gangguan").where("status", "==", "Open").onSnapshot(snap => { document.getElementById("totalGangguan").textContent = snap.size; });
        }

        /* =================================================================
         * ======================== ALL RENDERERS ==========================
         * ================================================================= */
        async function generateNextInternetNo() {
            const basePrefix = 1906140000;
            const query = db.collection("user").orderBy("internetNo", "desc").limit(1);
            try {
                const snapshot = await query.get();
                let lastNo = basePrefix;
                if (!snapshot.empty) lastNo = parseInt(snapshot.docs[0].data().internetNo, 10) || basePrefix;
                document.getElementById('pbInternetNo').value = lastNo + 1;
            } catch (error) { console.error("Error generating internet number: ", error); document.getElementById('pbInternetNo').value = basePrefix + 1; }
        }

        function renderPasangBaruTable() {
            const filterFn = (d) => { const q = document.getElementById('pbSearch').value.toLowerCase(); return !q || d.pbNama.toLowerCase().includes(q) || d.pbInternetNo.includes(q); };
            const customRow = (d) => `<tr><td>${d.pbInternetNo}</td><td>${d.pbNama}</td><td>${d.pbAlamat}</td><td>${d.pbHP}</td><td>${d.pbPlan}</td><td><button class="btn ghost mini" onclick="editItem('pasang_baru', '${d.id}', 'pasangbaruId', ['pbInternetNo', 'pbNama', 'pbAlamat', 'pbHP', 'pbPlan', 'pbSN', 'pbODP'])">Edit</button><button class="btn ghost danger mini" onclick="deleteItem('pasang_baru', '${d.id}')">Hapus</button></td></tr>`;
            db.collection("pasang_baru").onSnapshot(snap => {
                const tbody = document.querySelector("#pasangBaruTable tbody"); tbody.innerHTML = ""; let rows = [];
                snap.forEach(doc => rows.push({ id: doc.id, ...doc.data() }));
                rows.filter(filterFn).forEach(d => tbody.innerHTML += customRow(d));
            });
        }

        function renderUserTable() {
            const filterFn = (d) => { const q = document.getElementById('userSearch').value.toLowerCase(); return !q || d.userName.toLowerCase().includes(q) || d.internetNo.includes(q) || (d.pppoeUser && d.pppoeUser.toLowerCase().includes(q)); };
            const customRow = (d) => `<tr><td>${d.internetNo}</td><td>${d.userName}</td><td>${d.pppoeUser}</td><td>${d.planName}</td><td>${d.alamat}</td><td>${d.noHp}</td><td>${d.odpUser}</td><td><button class="btn ghost mini" onclick="editItem('user', '${d.id}', 'userId', userFormFields)">Edit</button><button class="btn ghost danger mini" onclick="deleteItem('user', '${d.id}')">Hapus</button></td></tr>`;
            const userFormFields = ["internetNo", "userName", "pppoeUser", "alamat", "noHp", "planName", "snOnt", "odpUser", "portOlt", "portOdp", "redamanOnt", "geoTag", "connectionStatus"];
            db.collection("user").onSnapshot(snap => {
                const tbody = document.querySelector("#userTable tbody"); tbody.innerHTML = ""; let rows = [];
                snap.forEach(doc => rows.push({ id: doc.id, ...doc.data() }));
                rows.filter(filterFn).forEach(d => tbody.innerHTML += customRow(d));
            });
        }
        
        function renderMikrotikTable() {
             const filterFn = (d) => { const q = document.getElementById('mikrotikUserSearch').value.toLowerCase(); return !q || d.userName.toLowerCase().includes(q) || (d.pppoeUser && d.pppoeUser.toLowerCase().includes(q)); };
            const customRow = (d) => {
                const status = d.connectionStatus || 'enabled'; const statusClass = status === 'enabled' ? 'enabled' : 'disabled';
                const actionButton = status === 'enabled' ? `<button class="btn danger mini" onclick="toggleUserConnection('${d.id}', '${d.pppoeUser}', 'disabled')">Disable</button>` : `<button class="btn success mini" onclick="toggleUserConnection('${d.id}', '${d.pppoeUser}', 'enabled')">Enable</button>`;
                return `<tr><td><span class="badge ${statusClass}">${status}</span></td><td>${d.userName}</td><td>${d.pppoeUser}</td><td>${d.internetNo}</td><td>${actionButton}</td></tr>`;
            };
            db.collection("user").onSnapshot(snap => {
                const tbody = document.querySelector("#mikrotikUserTable tbody"); tbody.innerHTML = ""; let rows = [];
                snap.forEach(doc => rows.push({ id: doc.id, ...doc.data() }));
                rows.filter(filterFn).forEach(d => tbody.innerHTML += customRow(d));
            });
        }
        
        async function toggleUserConnection(userId, pppoeUser, targetStatus) {
            if (!pppoeUser) { alert("Error: Nama User PPPoE tidak ditemukan."); return; }
            if (!confirm(`Yakin ingin ${targetStatus === 'enabled' ? 'ENABLE' : 'DISABLE'} koneksi untuk ${pppoeUser}?`)) return;
            try {
                const doc = await db.collection("isp_profile").doc("main").get();
                if (!doc.exists || !doc.data().mikrotikApiUrl) { alert("Konfigurasi MikroTik API belum diatur di menu Pengaturan."); return; }
                const config = doc.data();
                const response = await fetch(config.mikrotikApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ip: config.mikrotikIp, user: config.mikrotikUser, pass: config.mikrotikPass, action: targetStatus, pppoe_user: pppoeUser }) });
                const result = await response.json();
                if (result.status === 'success') {
                    await db.collection("user").doc(userId).update({ connectionStatus: targetStatus });
                    alert(`User ${pppoeUser} berhasil di-${targetStatus}.`);
                } else { alert(`Gagal: ${result.message || 'Terjadi kesalahan.'}`); }
            } catch (error) { console.error("Error toggling user connection:", error); alert("Gagal menghubungi skrip perantara."); }
        }

        function renderPaketTable() {
            const customRow = (d) => `<tr><td>${d.namaPaket}</td><td>${d.bandwidth}</td><td>${d.hargaPaket}</td><td><button class="btn ghost mini" onclick="editItem('paket', '${d.id}', 'paketId', ['namaPaket', 'bandwidth', 'hargaPaket'])">Edit</button><button class="btn ghost danger mini" onclick="deleteItem('paket', '${d.id}')">Hapus</button></td></tr>`;
            db.collection("paket").onSnapshot(snap => { const tbody = document.querySelector("#paketTable tbody"); tbody.innerHTML = ""; snap.forEach(doc => tbody.innerHTML += customRow({ id: doc.id, ...doc.data() })); });
        }

        function renderBillingTable() {
            const filterFn = (d) => { const q = document.getElementById('billingSearch').value.toLowerCase(); const status = document.getElementById('billingStatusFilter').value; const matchesSearch = !q || (d.nama && d.nama.toLowerCase().includes(q)) || d.internetNo.includes(q) || d.periode.includes(q); const matchesStatus = !status || d.status === status; return matchesSearch && matchesStatus; };
            const customRow = (d) => {
                const statusClass = d.status === 'Lunas' ? 'lunas' : 'belum';
                const actionButton = d.status === 'Belum' ? `<button class="btn success mini" onclick="updateBillStatus('${d.id}', '${d.internetNo}', '${d.nama}', ${d.jumlah})">Bayar</button>` : `<button class="btn ghost mini" onclick="printReceipt('${d.id}')">Cetak</button>`;
                return `<tr><td>${d.internetNo}</td><td>${d.nama}</td><td>${d.periode}</td><td>${d.jumlah}</td><td><span class="badge ${statusClass}">${d.status}</span></td><td>${actionButton} <button class="btn ghost danger mini" onclick="deleteItem('billing', '${d.id}')">Hapus</button></td></tr>`;
            };
            db.collection("billing").onSnapshot(snap => {
                const tbody = document.querySelector("#billingTable tbody"); tbody.innerHTML = ""; let rows = [];
                snap.forEach(doc => rows.push({ id: doc.id, ...doc.data() }));
                rows.filter(filterFn).forEach(d => tbody.innerHTML += customRow(d));
            });
        }

        async function generateBills() {
            if (!confirm("Yakin generate tagihan untuk semua user aktif bulan ini?")) return;
            const period = new Date().toISOString().slice(0, 7);
            const usersSnap = await db.collection("user").get();
            const paketsSnap = await db.collection("paket").get();
            const pakets = {}; paketsSnap.forEach(doc => pakets[doc.data().namaPaket] = doc.data().hargaPaket);
            let generatedCount = 0;
            for (const userDoc of usersSnap.docs) {
                const user = userDoc.data();
                const billQuery = await db.collection("billing").where("internetNo", "==", user.internetNo).where("periode", "==", period).get();
                if (billQuery.empty) {
                    const harga = pakets[user.planName] || 0;
                    if (harga > 0) {
                        await db.collection("billing").add({ internetNo: user.internetNo, nama: user.userName, periode: period, jumlah: harga, status: "Belum" });
                        generatedCount++;
                    }
                }
            }
            alert(`${generatedCount} tagihan baru berhasil digenerate untuk periode ${period}.`);
        }

        async function updateBillStatus(billId, internetNo, nama, jumlah) {
            if (!confirm(`Konfirmasi pembayaran untuk ${nama} sebesar Rp ${jumlah}?`)) return;
            await db.collection("billing").doc(billId).update({ status: "Lunas" });
            const today = new Date().toISOString().slice(0, 10);
            await db.collection("kas").add({ kasTanggal: today, kasKet: `Pembayaran billing ${nama} (${internetNo})`, kasTipe: "Masuk", kasJumlah: jumlah });
            alert("Pembayaran berhasil dikonfirmasi.");
        }
        function printReceipt(billId) { alert("Fungsi cetak struk belum diimplementasikan."); }

        function renderKasTable() {
            const filterFn = (d) => { const q = document.getElementById('kasSearch').value.toLowerCase(); return !q || d.kasKet.toLowerCase().includes(q); };
            const customRow = (d) => `<tr><td>${d.kasTanggal}</td><td>${d.kasKet}</td><td>${d.kasTipe}</td><td>${d.kasJumlah}</td><td><button class="btn ghost mini" onclick="editItem('kas', '${d.id}', 'kasId', ['kasTanggal', 'kasKet', 'kasTipe', 'kasJumlah'])">Edit</button><button class="btn ghost danger mini" onclick="deleteItem('kas', '${d.id}')">Hapus</button></td></tr>`;
            db.collection("kas").orderBy("kasTanggal", "desc").onSnapshot(snap => {
                const tbody = document.querySelector("#kasTable tbody"); tbody.innerHTML = ""; let rows = [];
                snap.forEach(doc => rows.push({ id: doc.id, ...doc.data() }));
                rows.filter(filterFn).forEach(d => tbody.innerHTML += customRow(d));
            });
        }
        
        function renderTeknisiTable() {
            const customRow = (d) => `<tr><td>${d.namaTeknisi}</td><td>${d.kontakTeknisi}</td><td><button class="btn ghost mini" onclick="editItem('teknisi', '${d.id}', 'teknisiId', ['namaTeknisi', 'kontakTeknisi'])">Edit</button><button class="btn ghost danger mini" onclick="deleteItem('teknisi', '${d.id}')">Hapus</button></td></tr>`;
            db.collection("teknisi").onSnapshot(snap => { const tbody = document.querySelector("#teknisiTable tbody"); tbody.innerHTML = ""; snap.forEach(doc => tbody.innerHTML += customRow({ id: doc.id, ...doc.data() })); });
        }
        
        async function autofillGangguanForm(internetNo) {
            const namaInput = document.getElementById('gtNama');
            namaInput.value = 'Mencari...';
            const userQuery = await db.collection("user").where("internetNo", "==", internetNo).limit(1).get();
            if (!userQuery.empty) namaInput.value = userQuery.docs[0].data().userName;
            else namaInput.value = 'User tidak ditemukan';
        }

        async function getNextTicketNumber() {
            const query = db.collection("gangguan").orderBy("ticketNo", "desc").limit(1);
            const snapshot = await query.get();
            if (snapshot.empty) return "TC00001";
            const lastTicket = snapshot.docs[0].data().ticketNo;
            const lastNum = parseInt(lastTicket.replace("TC", ""), 10);
            return "TC" + String(lastNum + 1).padStart(5, '0');
        }

        function renderGangguanTable() {
            const filterFn = (d) => { const q = document.getElementById('gangguanSearch').value.toLowerCase(); const status = document.getElementById('gangguanStatusFilter').value; const matchesSearch = !q || d.gtNama.toLowerCase().includes(q) || d.gtInternetNo.includes(q); const matchesStatus = !status || d.status === status; return matchesSearch && matchesStatus; };
            const customRow = (d) => {
                const actionButton = d.status === 'Open' ? `<button class="btn success mini" onclick="closeTicket('${d.id}')">Close Ticket</button>` : '';
                return `<tr><td>${d.ticketNo || '-'}</td><td>${d.gtInternetNo}</td><td>${d.gtNama}</td><td>${d.gtJenis}</td><td>${d.gtKeterangan}</td><td>${d.status}</td><td>${actionButton} <button class="btn ghost danger mini" onclick="deleteItem('gangguan', '${d.id}')">Hapus</button></td></tr>`;
            };
            db.collection("gangguan").onSnapshot(snap => {
                const tbody = document.querySelector("#gangguanTable tbody"); tbody.innerHTML = ""; let rows = [];
                snap.forEach(doc => rows.push({ id: doc.id, ...doc.data() }));
                rows.filter(filterFn).forEach(d => tbody.innerHTML += customRow(d));
            });
        }

        async function closeTicket(id) { if (confirm("Yakin menutup tiket gangguan ini?")) { await db.collection("gangguan").doc(id).update({ status: "Closed" }); alert("Tiket berhasil ditutup."); } }
        
        function calculateStock() { const stokAwal = parseFloat(document.getElementById('stokAwal').value) || 0; const usage = parseFloat(document.getElementById('usage').value) || 0; document.getElementById('stokAkhir').value = stokAwal - usage; }
        function renderMaterialTable() {
            const customRow = (d) => `<tr><td>${d.namaMaterial}</td><td>${d.satuanMaterial}</td><td>${d.stokAwal}</td><td>${d.usage}</td><td>${d.stokAkhir}</td><td><button class="btn ghost mini" onclick="editItem('material', '${d.id}', 'materialId', ['namaMaterial', 'satuanMaterial', 'stokAwal'])">Edit</button><button class="btn ghost danger mini" onclick="deleteItem('material', '${d.id}')">Hapus</button></td></tr>`;
            db.collection("material").onSnapshot(snap => {
                const tbody = document.querySelector("#materialTable tbody"); tbody.innerHTML = "";
                snap.forEach(doc => { const data = doc.data(); data.stokAkhir = (data.stokAwal || 0) - (data.usage || 0); tbody.innerHTML += customRow({ id: doc.id, ...data }); });
            });
        }
        
        function renderOdpTable() {
            const filterFn = (d) => { const q = document.getElementById('odpSearch').value.toLowerCase(); return !q || d.namaOdp.toLowerCase().includes(q); };
            const customRow = (d) => `<tr><td>${d.namaOdp}</td><td>${d.kapasitasOdp}</td><td>${d.lokasiOdp}</td><td><button class="btn ghost mini" onclick="editItem('odp', '${d.id}', 'odpId', ['namaOdp', 'kapasitasOdp', 'lokasiOdp'])">Edit</button><button class="btn ghost danger mini" onclick="deleteItem('odp', '${d.id}')">Hapus</button></td></tr>`;
            db.collection("odp").onSnapshot(snap => {
                const tbody = document.querySelector("#odpTable tbody"); tbody.innerHTML = ""; let rows = [];
                snap.forEach(doc => rows.push({ id: doc.id, ...doc.data() }));
                rows.filter(filterFn).forEach(d => tbody.innerHTML += customRow(d));
            });
        }

        /* =================================================================
         * ========================== PENGATURAN ===========================
         * ================================================================= */
        async function saveIspProfile(e) {
            e.preventDefault(); const btn = document.getElementById('saveIspButton'); btn.textContent = 'Menyimpan...'; btn.disabled = true;
            try {
                const file = document.getElementById('editIspLogoFile').files[0]; let logoUrl = document.getElementById('editIspLogoUrl').value;
                if (file) { const filePath = `isp_logos/${Date.now()}_${file.name}`; const task = await storage.ref(filePath).put(file); logoUrl = await task.ref.getDownloadURL(); }
                const data = { name: document.getElementById('editIspName').value, address: document.getElementById('editIspAlamat').value, contact: document.getElementById('editIspKontak').value, logoUrl: logoUrl };
                await db.collection("isp_profile").doc("main").set(data, { merge: true });
                alert('Profil ISP berhasil disimpan!'); loadIspProfile();
            } catch (error) { console.error("Error saving ISP profile:", error); alert('Gagal menyimpan profil ISP.'); } 
            finally { btn.textContent = 'Simpan Profil'; btn.disabled = false; }
        }

        async function saveMikrotikConfig(e) {
            e.preventDefault(); const btn = document.getElementById('saveMikrotikButton'); btn.textContent = 'Menyimpan...'; btn.disabled = true;
            const data = { mikrotikApiUrl: document.getElementById('mikrotikApiUrl').value, mikrotikIp: document.getElementById('mikrotikIp').value, mikrotikUser: document.getElementById('mikrotikUser').value, mikrotikPass: document.getElementById('mikrotikPass').value };
            try { await db.collection("isp_profile").doc("main").set(data, { merge: true }); alert('Konfigurasi MikroTik berhasil disimpan!'); } 
            catch (error) { console.error("Error saving MikroTik config:", error); alert('Gagal menyimpan konfigurasi.'); } 
            finally { btn.textContent = 'Simpan Konfigurasi'; btn.disabled = false; }
        }

        function loadIspProfile() {
            db.collection("isp_profile").doc("main").get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('ispName').innerText = data.name || 'Starnet';
                    document.getElementById('editIspName').value = data.name || '';
                    document.getElementById('editIspAlamat').value = data.address || '';
                    document.getElementById('editIspKontak').value = data.contact || '';
                    document.getElementById('editIspLogoUrl').value = data.logoUrl || '';
                    document.getElementById('logoPreview').src = data.logoUrl || 'https://placehold.co/150x150/e2e8f0/e2e8f0?text=LOGO';
                    document.getElementById('mikrotikApiUrl').value = data.mikrotikApiUrl || '';
                    document.getElementById('mikrotikIp').value = data.mikrotikIp || '';
                    document.getElementById('mikrotikUser').value = data.mikrotikUser || '';
                    document.getElementById('mikrotikPass').value = data.mikrotikPass || '';
                }
            });
        }
        
        function previewLogo(event) {
            const file = event.target.files[0];
            if (file) { const reader = new FileReader(); reader.onload = (e) => { document.getElementById('logoPreview').src = e.target.result; }; reader.readAsDataURL(file); }
        }

        /* =================================================================
         * ======================= DATA SEEDING SCRIPT =====================
         * ================================================================= */
        async function checkAndSeedDatabase() {
            const seedFlag = await db.collection('_system_config').doc('seed_flag').get();
            if (seedFlag.exists) {
                console.log("Database already seeded. Skipping.");
                return;
            }

            const overlay = document.getElementById('seeding-overlay');
            const progress = document.getElementById('seeding-progress');
            overlay.classList.remove('hidden');

            try {
                // --- Helper functions for random data ---
                const rand = (arr) => arr[Math.floor(Math.random() * arr.length)];
                const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
                const firstNames = ["Budi", "Adi", "Agus", "Dewi", "Eka", "Siti", "Joko", "Putri", "Rina", "Ahmad", "Nur", "Tri", "Indah", "Dian", "Bayu"];
                const lastNames = ["Santoso", "Wijaya", "Kusuma", "Lestari", "Pratama", "Nugroho", "Wahyuni", "Setiawan", "Hidayat", "Maulana"];
                const streets = ["Merdeka", "Sudirman", "Diponegoro", "Gajah Mada", "Imam Bonjol", "Pahlawan", "Kartini", "Veteran", "Kenanga", "Melati"];
                const cities = ["Surabaya", "Malang", "Jember", "Kediri", "Probolinggo", "Pasuruan", "Lumajang"];
                const gangguanJenis = ["LOS", "Intermittent", "Lambat", "Lainnya"];
                const gangguanKet = ["Kabel FO putus", "Redaman tinggi", "ONT mati", "Adaptor rusak", "Settingan error", "Port ODP kotor"];
                const teknisiList = [{nama: "Andi"}, {nama: "Bambang"}, {nama: "Candra"}];

                // --- 1. Seed Paket ---
                progress.textContent = "Membuat data paket...";
                const paketData = [
                    { namaPaket: 'Home', bandwidth: '25MB', hargaPaket: 100000 },
                    { namaPaket: 'Game', bandwidth: '50MB', hargaPaket: 150000 },
                    { namaPaket: 'Bisnis', bandwidth: '200MB', hargaPaket: 300000 }
                ];
                for (const paket of paketData) { await db.collection('paket').add(paket); }
                
                // --- 2. Seed Teknisi ---
                progress.textContent = "Membuat data teknisi...";
                for(const tek of teknisiList) { await db.collection('teknisi').add({namaTeknisi: tek.nama, kontakTeknisi: `0812${randInt(10000000,99999999)}`}); }

                // --- 3. Seed 1000 Users ---
                let users = [];
                for (let i = 0; i < 1000; i++) {
                    const firstName = rand(firstNames);
                    const lastName = rand(lastNames);
                    const fullName = `${firstName} ${lastName}`;
                    const pppoe = `${firstName.toLowerCase()}.${lastName.toLowerCase()}${i}`;
                    users.push({
                        internetNo: (1906140000 + i).toString(),
                        userName: fullName,
                        pppoeUser: pppoe,
                        alamat: `Jl. ${rand(streets)} No. ${randInt(1, 100)}, ${rand(cities)}`,
                        noHp: `08${randInt(100000000, 999999999)}`,
                        planName: rand(paketData).namaPaket,
                        connectionStatus: Math.random() < 0.05 ? 'disabled' : 'enabled', // 5% disabled
                        snOnt: `HWTC${randInt(10000000, 99999999)}`,
                        odpUser: `ODP-${rand(cities).substring(0,3).toUpperCase()}-${randInt(1,50)}`,
                        portOdp: randInt(1,8),
                        portOlt: `0/${randInt(1,4)}/${randInt(1,16)}`,
                        redamanOnt: `-${randInt(18, 25)} dB`,
                        geoTag: `-8.${randInt(100,200)}, 113.${randInt(100,300)}`
                    });
                }
                // Batch write users
                let userBatch = db.batch();
                for (let i = 0; i < users.length; i++) {
                    progress.textContent = `Membuat user ${i + 1} dari 1000...`;
                    const userRef = db.collection('user').doc();
                    userBatch.set(userRef, users[i]);
                    if ((i + 1) % 400 === 0) {
                        await userBatch.commit();
                        userBatch = db.batch();
                    }
                }
                await userBatch.commit();
                
                // --- 4. Seed Billing for last 12 months ---
                const allUsers = await db.collection('user').get();
                let billingBatch = db.batch();
                let billingCounter = 0;
                for (const userDoc of allUsers.docs) {
                    const user = userDoc.data();
                    const paket = paketData.find(p => p.namaPaket === user.planName);
                    if (!paket) continue;
                    
                    progress.textContent = `Membuat tagihan untuk ${user.userName}...`;
                    
                    for (let m = 0; m < 12; m++) {
                        let date = new Date();
                        date.setMonth(date.getMonth() - m);
                        const period = date.toISOString().slice(0, 7);
                        const isUnpaid = m < 2 && Math.random() < 0.2; // 20% unpaid in last 2 months
                        
                        const bill = {
                            internetNo: user.internetNo,
                            nama: user.userName,
                            periode: period,
                            jumlah: paket.hargaPaket,
                            status: isUnpaid ? "Belum" : "Lunas"
                        };
                        const billRef = db.collection('billing').doc();
                        billingBatch.set(billRef, bill);
                        billingCounter++;
                        if (billingCounter % 400 === 0) {
                            await billingBatch.commit();
                            billingBatch = db.batch();
                        }
                    }
                }
                await billingBatch.commit();

                // --- 5. Seed Gangguan ---
                let gangguanBatch = db.batch();
                let ticketCounter = 1;
                for (let i = 0; i < 300; i++) {
                    progress.textContent = `Membuat tiket gangguan ${i + 1} dari 300...`;
                    const randomUser = users[randInt(0, users.length - 1)];
                    const status = Math.random() < 0.1 ? 'Open' : 'Closed'; // 10% open
                    
                    const ticket = {
                        ticketNo: "TC" + String(ticketCounter).padStart(5, '0'),
                        gtInternetNo: randomUser.internetNo,
                        gtNama: randomUser.userName,
                        gtJenis: rand(gangguanJenis),
                        gtKeterangan: rand(gangguanKet),
                        status: status
                    };
                    const ticketRef = db.collection('gangguan').doc();
                    gangguanBatch.set(ticketRef, ticket);
                    ticketCounter++;
                     if (i % 400 === 0) {
                        await gangguanBatch.commit();
                        gangguanBatch = db.batch();
                    }
                }
                await gangguanBatch.commit();

                // --- Set seed flag ---
                progress.textContent = "Finalisasi...";
                await db.collection('_system_config').doc('seed_flag').set({ seeded: true, at: new Date() });
                
                alert("Pembuatan data dummy selesai! Halaman akan dimuat ulang.");
                window.location.reload();

            } catch (error) {
                console.error("FATAL: Data seeding failed:", error);
                progress.textContent = `ERROR: ${error.message}. Hapus koleksi di Firebase dan coba lagi.`;
            }
        }
    </script>
</body>
</html>
