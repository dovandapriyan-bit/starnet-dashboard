<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Starnet 💫 Manager</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{margin:0;font-family:Arial,sans-serif;background:#f4f6f9;}
.sidebar{width:250px;height:100%;position:fixed;top:0;left:0;background:linear-gradient(180deg,#007bff,#0056b3);color:#fff;padding-top:20px;overflow:auto;}
.sidebar h2{text-align:center;margin-bottom:20px;}
.sidebar a{display:block;color:white;padding:12px 20px;text-decoration:none;}
.sidebar a:hover{background:rgba(255,255,255,0.2);}
.main{margin-left:250px;padding:20px;}
.card{background:white;padding:15px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1);margin-bottom:20px;}
h3{margin-top:0;}
table{width:100%;border-collapse:collapse;}
th,td{padding:8px;border:1px solid #ddd;text-align:left;}
th{background:#007bff;color:white;}
input,select{padding:6px;margin:4px 0;width:100%;}
button{padding:6px 10px;margin:2px;border:none;background:#007bff;color:white;border-radius:4px;cursor:pointer;}
button:hover{background:#0056b3;}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px;}
#notif{position:fixed;top:10px;right:10px;background:#007bff;color:white;padding:10px;border-radius:5px;display:none;z-index:1000;}
</style>
</head>
<body>

<div class="sidebar">
<h2 id="ispName">Starnet 💫</h2>
<a href="#" onclick="showSection('dashboard')">Dashboard</a>
<a href="#" onclick="showSection('user')">User</a>
<a href="#" onclick="showSection('paket')">Paket</a>
<a href="#" onclick="showSection('billing')">Billing</a>
<a href="#" onclick="showSection('kas')">Kas</a>
<a href="#" onclick="showSection('teknisi')">Teknisi</a>
<a href="#" onclick="showSection('gangguan')">Gangguan</a>
<a href="#" onclick="showSection('material')">Material</a>
<a href="#" onclick="showSection('editisp')">Edit ISP</a>
<a href="#" onclick="logout()">Logout</a>
</div>

<div class="main">
<div id="dashboard" class="section">
<h2>Dashboard</h2>
<div class="grid">
<div class="card" onclick="showSection('user')" style="cursor:pointer;"><h3>Total User</h3><p id="totalUser">0</p></div>
<div class="card" onclick="showSection('kas')" style="cursor:pointer;"><h3>Saldo Kas</h3><p id="saldoKas">0</p></div>
<div class="card" onclick="showSection('billing')" style="cursor:pointer;"><h3>Tunggakan</h3><p id="totalTunggakan">0</p></div>
<div class="card" onclick="showSection('gangguan')" style="cursor:pointer;"><h3>Gangguan Aktif</h3><p id="totalGangguan">0</p></div>
</div>
<div class="card"><canvas id="ispChart"></canvas></div>
<div class="card">
<h3>Gangguan Terbaru</h3>
<table><thead><tr><th>User</th><th>Indikasi</th><th>Waktu</th><th>TTR</th><th>Status</th></tr></thead><tbody id="dashboardGangguan"></tbody></table>
</div>
</div>

<!-- User -->
<div id="user" class="section" style="display:none;">
<h2>User</h2>
<form id="userForm">
<input type="hidden" id="userId">
<label>Nama</label><input id="userName" required>
<label>No HP</label><input id="userHP" required>
<label>Alamat</label><input id="userAlamat" required>
<label>MAC/SN ONT</label><input id="userMAC" required>
<label>ODP</label><input id="userODP" required>
<label>Paket</label><select id="planName" required></select>
<label>Status Bayar</label><select id="statusBayar"><option>Lunas</option><option>Belum</option></select>
<button type="submit">Simpan User</button>
</form>
<div class="card"><table id="userTable"><thead><tr><th>Nama</th><th>HP</th><th>Alamat</th><th>MAC</th><th>ODP</th><th>Paket</th><th>Status</th><th>Aksi</th></tr></thead><tbody></tbody></table></div>
</div>

<!-- Paket -->
<div id="paket" class="section" style="display:none;">
<h2>Paket</h2>
<form id="paketForm">
<input type="hidden" id="paketId">
<label>Nama Paket</label><input id="namaPaket" required>
<label>Bandwidth</label><input id="bandwidth" required>
<label>Harga</label><input id="hargaPaket" required>
<label>Durasi (Bulan)</label><input id="durasiPaket" required>
<button type="submit">Simpan Paket</button>
</form>
<div class="card"><table id="paketTable"><thead><tr><th>Paket</th><th>Bandwidth</th><th>Harga</th><th>Durasi</th><th>Aksi</th></tr></thead><tbody></tbody></table></div>
</div>

<!-- Billing -->
<div id="billing" class="section" style="display:none;">
<h2>Billing</h2>
<button onclick="generateAllBilling()">🔄 Generate Billing Semua User</button>
<button onclick="exportBillingCSV()">📥 Export CSV</button>
<div class="card"><table id="billingTable"><thead><tr><th>User</th><th>Jumlah</th><th>Status</th><th>Aksi</th></tr></thead><tbody></tbody></table></div>
</div>

<!-- Kas -->
<div id="kas" class="section" style="display:none;">
<h2>Kas Perusahaan</h2>
<form id="kasForm">
<input type="hidden" id="kasId">
<label>Keterangan</label><input id="kasKet" required>
<label>Jumlah (+/-)</label><input id="kasJumlah" required>
<button type="submit">Simpan Transaksi</button>
</form>
<div class="card"><table id="kasTable"><thead><tr><th>Keterangan</th><th>Jumlah</th><th>Aksi</th></tr></thead><tbody></tbody></table></div>
</div>

<!-- Teknisi -->
<div id="teknisi" class="section" style="display:none;">
<h2>Teknisi</h2>
<form id="teknisiForm">
<input type="hidden" id="teknisiId">
<label>Nama Teknisi</label><input id="namaTeknisi" required>
<label>Kontak</label><input id="kontakTeknisi" required>
<button type="submit">Simpan Teknisi</button>
</form>
<div class="card"><table id="teknisiTable"><thead><tr><th>Nama</th><th>Kontak</th><th>Aksi</th></tr></thead><tbody></tbody></table></div>
</div>

<!-- Gangguan -->
<div id="gangguan" class="section" style="display:none;">
<h2>Gangguan</h2>
<button onclick="simulateGangguan()">➕ Tambah Gangguan Random</button>
<button onclick="clearGangguan()">🗑️ Hapus Semua Gangguan</button>
<div class="card"><table id="gangguanTable"><thead><tr><th>User</th><th>Indikasi</th><th>Waktu</th><th>TTR</th><th>Status</th><th>Teknisi</th><th>Aksi</th></tr></thead><tbody></tbody></table></div>
</div>

<!-- Material -->
<div id="material" class="section" style="display:none;">
<h2>Material</h2>
<form id="materialForm">
<input type="hidden" id="materialId">
<label>Nama Material</label><input id="namaMaterial" required>
<label>Stok</label><input type="number" id="stokMaterial" required>
<button type="submit">Simpan Material</button>
</form>
<div class="card"><table id="materialTable"><thead><tr><th>Material</th><th>Stok</th><th>Aksi</th></tr></thead><tbody></tbody></table></div>
</div>

<!-- Edit ISP -->
<div id="editisp" class="section" style="display:none;">
<h2>Edit Nama ISP</h2>
<input id="newISPName" placeholder="Nama ISP baru">
<button onclick="editISP()">Simpan</button>
</div>

<div id="notif"></div>
</div>

<script>
// Firebase Config
const firebaseConfig = {
apiKey:"AIzaSyB-iBpZNC0YZBTAUzir7gJuU9kBQg82moc",
authDomain:"dnt-network-7.firebaseapp.com",
projectId:"dnt-network-7",
storageBucket:"dnt-network-7.firebasestorage.app",
messagingSenderId:"761179668371",
appId:"1:761179668371:web:7d1468d0298041d4783266",
measurementId:"G-CD3EQ350R4"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

// ================= UI & Helpers =================
function showSection(id){document.querySelectorAll('.section').forEach(s=>s.style.display="none");document.getElementById(id).style.display="block";}
function logout(){alert("Logout sukses!");}
function editISP(){document.getElementById("ispName").innerText=document.getElementById("newISPName").value||"Starnet 💫";}
function showNotif(msg){let n=document.getElementById("notif");n.textContent=msg;n.style.display="block";setTimeout(()=>{n.style.display="none";},4000);}

// Load Paket ke dropdown User
function loadPaketSelect(){
const sel=document.getElementById("planName"); sel.innerHTML="<option value=''>--Pilih Paket--</option>";
db.collection("paket").get().then(snap=>{snap.forEach(doc=>{let d=doc.data(); let o=document.createElement("option"); o.value=d.namaPaket; o.textContent=d.namaPaket+" ("+d.bandwidth+")"; sel.appendChild(o);})})
}
document.addEventListener("DOMContentLoaded", loadPaketSelect);

// Chart Pendapatan
const ctx=document.getElementById("ispChart"); 
let ispChart=new Chart(ctx,{type:'line',data:{labels:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],datasets:[{label:"Pendapatan",data:new Array(12).fill(0),borderColor:"green",fill:false}]},options:{responsive:true}});

// ================= CRUD Generic =================
function renderTable(collection, tableId, fields){
db.collection(collection).onSnapshot(snap=>{
let tbody=document.querySelector(`#${tableId} tbody`);tbody.innerHTML="";
snap.forEach(doc=>{let d=doc.data();let tr=document.createElement("tr");fields.forEach(f=>{let td=document.createElement("td");td.textContent=d[f]||"";tr.appendChild(td);});
let td=document.createElement("td"); td.innerHTML=`<button onclick="editItem('${collection}','${doc.id}')">✏️</button><button onclick="deleteItem('${collection}','${doc.id}')">🗑️</button>`; tr.appendChild(td); tbody.appendChild(tr);})})
}
function saveForm(e, collection, idField, fields){
e.preventDefault();
const id=document.getElementById(idField).value; let data={};
fields.forEach(f=>data[f]=document.getElementById(f).value);
if(collection==='user'&&!id)data['createdAt']=new Date().toISOString();
if(id){db.collection(collection).doc(id).update(data);}else{db.collection(collection).add(data).then(doc=>{if(collection==='user') generateBilling(data.userName);});}
e.target.reset();document.getElementById(idField).value="";
}
function editItem(collection,id){db.collection(collection).doc(id).get().then(doc=>{if(doc.exists){let d=doc.data();Object.keys(d).forEach(k=>{if(document.getElementById(k))document.getElementById(k).value=d[k];});if(document.getElementById(collection+"Id"))document.getElementById(collection+"Id").value=id;}})}
function deleteItem(collection,id){if(confirm("Yakin hapus?"))db.collection(collection).doc(id).delete();}

// Bind forms
document.getElementById("userForm").onsubmit=e=>saveForm(e,"user","userId",["userName","userHP","userAlamat","userMAC","userODP","planName","statusBayar"]);
renderTable("user","userTable",["userName","userHP","userAlamat","userMAC","userODP","planName","statusBayar"]);

document.getElementById("paketForm").onsubmit=e=>saveForm(e,"paket","paketId",["namaPaket","bandwidth","hargaPaket","durasiPaket"]);
renderTable("paket","paketTable",["namaPaket","bandwidth","hargaPaket","durasiPaket"]);

document.getElementById("kasForm").onsubmit=e=>saveForm(e,"kas","kasId",["kasKet","kasJumlah"]);
renderTable("kas","kasTable",["kasKet","kasJumlah"]);

document.getElementById("teknisiForm").onsubmit=e=>saveForm(e,"teknisi","teknisiId",["namaTeknisi","kontakTeknisi"]);
renderTable("teknisi","teknisiTable",["namaTeknisi","kontakTeknisi"]);

document.getElementById("materialForm").onsubmit=e=>saveForm(e,"material","materialId",["namaMaterial","stokMaterial"]);
renderTable("material","materialTable",["namaMaterial","stokMaterial"]);

// ================= Dashboard Counts =================
db.collection("user").onSnapshot(snap=>{document.getElementById("totalUser").textContent=snap.size;
let tunggakan=0; snap.forEach(doc=>{if(doc.data().statusBayar==="Belum")tunggakan++;}); document.getElementById("totalTunggakan").textContent=tunggakan;});
db.collection("kas").onSnapshot(snap=>{let saldo=0; snap.forEach(doc=>{saldo+=parseFloat(doc.data().kasJumlah||0);}); document.getElementById("saldoKas").textContent=saldo;});

// ================= Gangguan & TTR + Assign Teknisi =================
function loadGangguan(){
db.collection("gangguan").orderBy("waktu","desc").get().then(snap=>{
let tbody=document.querySelector("#gangguanTable tbody");tbody.innerHTML="";
let dashboardTbody=document.querySelector("#dashboardGangguan tbody");dashboardTbody.innerHTML="";
let activeCount=0;
snap.forEach(doc=>{
let d=doc.data();
let tr=document.createElement("tr"); 
let ttr="00:00:00"; 
if(d.status==="Aktif"){let start=new Date(d.waktu);let now=new Date();let diff=now-start;let hrs=Math.floor(diff/1000/60/60);let mins=Math.floor((diff/1000/60)%60);let secs=Math.floor((diff/1000)%60); ttr=`${hrs.toString().padStart(2,'0')}:${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`; activeCount++;}
else if(d.ttr)ttr=d.ttr;

tr.innerHTML=`<td>${d.user||""}</td><td>${d.indikasi||""}</td><td>${d.waktu||""}</td><td>${ttr}</td><td>${d.status||"Aktif"}</td>`;

let tdTeknisi=document.createElement("td");
if(d.status==="Aktif"){let sel=document.createElement("select"); sel.innerHTML="<option value=''>--Pilih Teknisi--</option>"; db.collection("teknisi").get().then(snap2=>{snap2.forEach(doc2=>{let t=doc2.data(); let o=document.createElement("option"); o.value=t.namaTeknisi; o.textContent=t.namaTeknisi; sel.appendChild(o);}); sel.onchange=function(){db.collection("gangguan").doc(doc.id).update({teknisi:this.value,status:"Sedang Ditangani"}); showNotif("Teknisi "+this.value+" ditugaskan"); loadGangguan();};}); tdTeknisi.appendChild(sel);}
else tdTeknisi.textContent=d.teknisi||"-";
tr.appendChild(tdTeknisi);

let tdAction=document.createElement("td");
tdAction.innerHTML=d.status==="Aktif"?`<button onclick="closeGangguan('${doc.id}')">Close</button>`:"-";
tr.appendChild(tdAction);

tbody.appendChild(tr);

// Dashboard mini
let tr2=document.createElement("tr"); tr2.innerHTML=`<td>${d.user||""}</td><td>${d.indikasi||""}</td><td>${d.waktu||""}</td><td>${ttr}</td><td>${d.status||"Aktif"}</td>`; dashboardTbody.appendChild(tr2);
});
document.getElementById("totalGangguan").textContent=activeCount;
});}
loadGangguan(); setInterval(loadGangguan,60000);

function simulateGangguan(){db.collection("user").get().then(snap=>{if(!snap.empty){let users=[];snap.forEach(doc=>users.push(doc.data().userName)); let randomUser=users[Math.floor(Math.random()*users.length)]; db.collection("gangguan").add({user:randomUser,indikasi:"Koneksi putus",waktu:new Date().toISOString(),status:"Aktif"}).then(()=>loadGangguan());} else alert("Belum ada user!");})}
function closeGangguan(id){db.collection("gangguan").doc(id).get().then(doc=>{if(doc.exists){let d=doc.data();let start=new Date(d.waktu);let now=new Date();let diff=now-start;let hrs=Math.floor(diff/1000/60/60);let mins=Math.floor((diff/1000/60)%60);let secs=Math.floor((diff/1000)%60);let ttr=`${hrs.toString().padStart(2,'0')}:${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`; db.collection("gangguan").doc(id).update({status:"Selesai",ttr:ttr}).then(()=>loadGangguan());}})}
function clearGangguan(){if(confirm("Yakin hapus semua gangguan?")){db.collection("gangguan").get().then(snap=>{snap.forEach(doc=>db.collection("gangguan").doc(doc.id).delete());loadGangguan();});}}

// ================= Billing =================
function generateBilling(userName){db.collection("user").get().then(snap=>{snap.forEach(doc=>{let u=doc.data();if(!userName||userName===u.userName){let amount=parseFloat(Math.random()*200+50).toFixed(2);db.collection("billing").add({billingUser:u.userName,billingAmount:amount,status:"Belum",createdAt:new Date().toISOString()});}});renderBilling();});}
function generateAllBilling(){generateBilling();}
function renderBilling(){db.collection("billing").orderBy("createdAt","desc").get().then(snap=>{let tbody=document.querySelector("#billingTable tbody");tbody.innerHTML="";snap.forEach(doc=>{let d=doc.data();let tr=document.createElement("tr");tr.innerHTML=`<td>${d.billingUser}</td><td>${d.billingAmount}</td><td>${d.status}</td><td>${d.status==="Belum"?`<button onclick="markPaid('${doc.id}')">Lunas</button>`:"-"}</td>`;tbody.appendChild(tr);});});}
function markPaid(id){db.collection("billing").doc(id).update({status:"Lunas"}).then(()=>renderBilling());}
renderBilling();

// ================= Chart Pendapatan Otomatis =================
function updateCharts(){let months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]; let revenue=new Array(12).fill(0);
db.collection("billing").get().then(snap=>{snap.forEach(doc=>{let d=new Date(doc.data().createdAt); let m=d.getMonth(); if(doc.data().status==="Lunas") revenue[m]+=parseFloat(doc.data().billingAmount);}); ispChart.data.datasets=[{label:"Pendapatan",data:revenue,borderColor:"green",fill:false}]; ispChart.update();});}
setInterval(updateCharts,5000); updateCharts();

// ================= Export CSV Billing =================
function exportBillingCSV(){db.collection("billing").get().then(snap=>{let csv="User,Amount,Status,Date\n"; snap.forEach(doc=>{let d=doc.data(); csv+=`${d.billingUser},${d.billingAmount},${d.status},${d.createdAt}\n`;}); let blob=new Blob([csv],{type:"text/csv"}); let a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="billing.csv"; a.click();});
}
</script>
</body>
</html>
