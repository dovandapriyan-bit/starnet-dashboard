<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>ISP Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --primary:#6d28d9;      /* ungu */
      --primary-600:#5b21b6;
      --primary-50:#ede9fe;
      --border:#e5e7eb;
      --success:#16a34a;
      --danger:#ef4444;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text)}
    /* Sidebar */
    .sidebar{position:fixed;inset:0 auto 0 0;width:250px;background:#2a1154;color:#fff;display:flex;flex-direction:column}
    .brand{padding:22px 18px;border-bottom:1px solid rgba(255,255,255,.08)}
    .brand h1{margin:0;font-size:18px;font-weight:800;letter-spacing:.3px}
    .nav{padding:10px}
    .nav a{display:flex;align-items:center;gap:10px;padding:10px 12px;margin-bottom:6px;color:#d6d3ff;text-decoration:none;border-radius:12px;transition:.15s}
    .nav a:hover{background:rgba(255,255,255,.08);color:#fff}
    .nav a.active{background:rgba(255,255,255,.16);color:#fff}
    /* Main */
    .main{margin-left:250px;padding:24px}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .header h2{margin:0;font-size:22px}
    /* Cards */
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 1px 3px rgba(0,0,0,.04);padding:16px}
    .card.clickable{cursor:pointer;transition:.15s}
    .card.clickable:hover{box-shadow:0 6px 14px rgba(0,0,0,.08);transform:translateY(-1px)}
    .stat{display:flex;flex-direction:column}
    .stat span{font-weight:800;font-size:26px}
    .stat small{color:var(--muted)}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
    .pill.warn{background:var(--primary-50);color:var(--primary)}
    .pill.danger{background:#fee2e2;color:#991b1b}
    .pill.success{background:#dcfce7;color:#065f46}
    /* Forms & Table */
    form .row{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    label{font-size:13px;color:var(--muted);margin-top:6px;display:block}
    input,select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    button{border:0;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:700}
    .btn{background:#e5e7eb}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.primary:hover{background:var(--primary-600)}
    .btn.success{background:var(--success);color:#fff}
    .btn.danger{background:var(--danger);color:#fff}
    .btn.ghost{background:transparent;color:var(--primary)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;border-bottom:1px solid var(--border);font-size:14px}
    th{background:#fafafa;text-align:left}
    tr:hover{background:#faf5ff}
    /* Sections */
    .section{display:none}
    .section.active{display:block}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .spacer{height:12px}
    @media (max-width:900px){
      .sidebar{width:76px}
      .main{margin-left:76px}
      .brand h1{display:none}
      .nav a span{display:none}
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand"><h1 id="ispName">ISP Manager</h1></div>
    <nav class="nav">
      <a href="#" class="active" onclick="showSection('dashboard',this)">üìä <span>Dashboard</span></a>
      <a href="#" onclick="showSection('user',this)">üë• <span>User</span></a>
      <a href="#" onclick="showSection('paket',this)">üì¶ <span>Paket</span></a>
      <a href="#" onclick="showSection('billing',this)">üí≥ <span>Billing</span></a>
      <a href="#" onclick="showSection('kas',this)">üí∞ <span>Kas</span></a>
      <a href="#" onclick="showSection('teknisi',this)">üõ†Ô∏è <span>Teknisi</span></a>
      <a href="#" onclick="showSection('gangguan',this)">‚ö†Ô∏è <span>Gangguan</span></a>
      <a href="#" onclick="showSection('material',this)">üìë <span>Material</span></a>
      <a href="#" onclick="showSection('odp',this)">üåê <span>ODP</span></a>
      <a href="#" onclick="showSection('editisp',this)">‚öôÔ∏è <span>Edit ISP</span></a>
      <a href="#" onclick="logout()">üö™ <span>Logout</span></a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="main">
    <!-- DASHBOARD -->
    <section id="dashboard" class="section active">
      <div class="header"><h2>Dashboard</h2></div>
      <div class="grid">
        <div class="card clickable" onclick="showSection('user')">
          <div class="stat"><span id="totalUser">0</span><small>Total User</small></div>
        </div>
        <div class="card clickable" onclick="showSection('kas')">
          <div class="stat"><span id="saldoKas">0</span><small>Saldo Kas</small></div>
        </div>
        <div class="card clickable" onclick="showSection('billing')">
          <div class="stat"><span id="totalTunggakan">0</span><small>User berstatus ‚ÄúBelum‚Äù</small></div>
        </div>
        <div class="card clickable" onclick="showSection('gangguan')">
          <div class="stat"><span id="totalGangguan">0</span><small>Gangguan Aktif</small></div>
        </div>
      </div>
      <div class="spacer"></div>
      <div class="card">
        <div class="toolbar" style="justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:800">Grafik Tagihan per Periode</div>
          <div class="pill warn">Auto refresh 5 menit</div>
        </div>
        <canvas id="billingChart" height="120"></canvas>
      </div>
    </section>

    <!-- USER -->
    <section id="user" class="section">
      <div class="header"><h2>User</h2></div>
      <div class="card">
        <form id="userForm">
          <input type="hidden" id="userId" />
          <div class="row">
            <div><label>Nama</label><input id="userName" required /></div>
            <div><label>Paket</label><select id="planName" required></select></div>
            <div><label>Status Bayar</label>
              <select id="statusBayar"><option>Lunas</option><option>Belum</option></select>
            </div>
          </div>
          <div class="spacer"></div>
          <button class="btn primary" type="submit">Simpan User</button>
        </form>
      </div>
      <div class="card">
        <table id="userTable">
          <thead><tr><th>Nama</th><th>Paket</th><th>Status</th><th>Aksi</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- PAKET -->
    <section id="paket" class="section">
      <div class="header"><h2>Paket</h2></div>
      <div class="card">
        <form id="paketForm">
          <input type="hidden" id="paketId" />
          <div class="row">
            <div><label>Nama Paket</label><input id="namaPaket" required /></div>
            <div><label>Bandwidth</label><input id="bandwidth" required /></div>
          </div>
          <div class="spacer"></div>
          <button class="btn primary" type="submit">Simpan Paket</button>
        </form>
      </div>
      <div class="card">
        <table id="paketTable">
          <thead><tr><th>Paket</th><th>Bandwidth</th><th>Aksi</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- BILLING -->
    <section id="billing" class="section">
      <div class="header"><h2>Billing</h2></div>
      <div class="card">
        <form id="billingForm">
          <input type="hidden" id="billingId" />
          <div class="row">
            <div><label>User</label><input id="billingUser" placeholder="Nama user persis" required /></div>
            <div><label>Jumlah</label><input id="billingAmount" type="number" min="0" step="1000" required /></div>
            <div><label>Periode</label><input id="billingPeriod" placeholder="YYYY-MM" required /></div>
            <div style="display:flex;align-items:end"><button class="btn primary" type="submit">Simpan Billing</button></div>
          </div>
        </form>
      </div>
      <div class="card">
        <table id="billingTable">
          <thead>
            <tr><th>User</th><th>Jumlah</th><th>Periode</th><th>Status</th><th>Catatan</th><th>Aksi</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- KAS -->
    <section id="kas" class="section">
      <div class="header"><h2>Kas</h2></div>
      <div class="card">
        <form id="kasForm">
          <input type="hidden" id="kasId" />
          <div class="row">
            <div><label>Keterangan</label><input id="kasKet" required /></div>
            <div><label>Jumlah (+ / -)</label><input id="kasJumlah" type="number" step="1000" required /></div>
          </div>
          <div class="spacer"></div>
          <button class="btn primary" type="submit">Simpan Transaksi</button>
        </form>
      </div>
      <div class="card">
        <table id="kasTable">
          <thead><tr><th>Keterangan</th><th>Jumlah</th><th>Aksi</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- TEKNISI -->
    <section id="teknisi" class="section">
      <div class="header"><h2>Teknisi</h2></div>
      <div class="card">
        <form id="teknisiForm">
          <input type="hidden" id="teknisiId" />
          <div class="row">
            <div><label>Nama Teknisi</label><input id="namaTeknisi" required /></div>
            <div><label>Kontak</label><input id="kontakTeknisi" required /></div>
          </div>
          <div class="spacer"></div>
          <button class="btn primary" type="submit">Simpan Teknisi</button>
        </form>
      </div>
      <div class="card">
        <table id="teknisiTable">
          <thead><tr><th>Nama</th><th>Kontak</th><th>Aksi</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- GANGGUAN -->
    <section id="gangguan" class="section">
      <div class="header"><h2>Gangguan</h2></div>
      <div class="toolbar" style="margin-bottom:8px">
        <button class="btn primary" onclick="simulateGangguan()">‚ûï Tambah Gangguan Random</button>
        <button class="btn danger" onclick="clearGangguan()">üóëÔ∏è Hapus Semua Gangguan</button>
      </div>
      <div class="card">
        <table id="gangguanTable">
          <thead>
            <tr><th>User</th><th>Indikasi</th><th>Waktu</th><th>TTR</th><th>Status</th><th>Aksi</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- MATERIAL -->
    <section id="material" class="section">
      <div class="header"><h2>Material</h2></div>
      <div class="card">
        <form id="materialForm">
          <input type="hidden" id="materialId" />
          <div class="row">
            <div><label>Nama Material</label><input id="namaMaterial" required /></div>
            <div><label>Stok</label><input id="stokMaterial" type="number" min="0" required /></div>
          </div>
          <div class="spacer"></div>
          <button class="btn primary" type="submit">Simpan Material</button>
        </form>
      </div>
      <div class="card">
        <table id="materialTable">
          <thead><tr><th>Material</th><th>Stok</th><th>Aksi</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ODP -->
    <section id="odp" class="section">
      <div class="header"><h2>ODP</h2></div>
      <div class="card">
        <form id="odpForm">
          <input type="hidden" id="odpId" />
          <div class="row">
            <div><label>Nama ODP</label><input id="namaODP" required /></div>
            <div><label>Lokasi</label><input id="lokasiODP" required /></div>
            <div><label>Kapasitas Port</label><input id="kapasitasODP" type="number" min="0" required /></div>
            <div><label>Port Terpakai</label><input id="terpakaiODP" type="number" min="0" required /></div>
          </div>
          <div class="spacer"></div>
          <button class="btn primary" type="submit">Simpan ODP</button>
        </form>
      </div>
      <div class="card">
        <table id="odpTable">
          <thead><tr><th>Nama</th><th>Lokasi</th><th>Kapasitas</th><th>Terpakai</th><th>Aksi</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- EDIT ISP -->
    <section id="editisp" class="section">
      <div class="header"><h2>Edit Nama ISP</h2></div>
      <div class="card">
        <div class="row">
          <div><label>Nama ISP</label><input id="newISPName" placeholder="Nama ISP baru" /></div>
          <div style="display:flex;align-items:end"><button class="btn primary" onclick="editISP()">Simpan</button></div>
        </div>
      </div>
    </section>
  </main>

  <script>
    /* =============== Firebase =============== */
    const firebaseConfig = {
      apiKey: "AIzaSyB-iBpZNC0YZBTAUzir7gJuU9kBQg82moc",
      authDomain: "dnt-network-7.firebaseapp.com",
      projectId: "dnt-network-7",
      storageBucket: "dnt-network-7.firebasestorage.app",
      messagingSenderId: "761179668371",
      appId: "1:761179668371:web:7d1468d0298041d4783266",
      measurementId: "G-CD3EQ350R4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* =============== UI Helpers =============== */
    function showSection(id, el){
      document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.nav a').forEach(a=>a.classList.remove('active'));
      if(el) el.classList.add('active');
      window.scrollTo({top:0,behavior:'smooth'});
    }
    function logout(){ alert("Logout sukses!"); }
    function editISP(){
      const v = document.getElementById('newISPName').value.trim();
      document.getElementById('ispName').innerText = v || 'ISP Manager';
    }

    /* =============== Dropdown Paket untuk User =============== */
    function loadPaketSelect(){
      const sel = document.getElementById("planName");
      sel.innerHTML = "<option value=''>--Pilih Paket--</option>";
      db.collection("paket").get().then(snap=>{
        snap.forEach(doc=>{
          const d = doc.data();
          const o = document.createElement("option");
          o.value = d.namaPaket;
          o.textContent = d.namaPaket + (d.bandwidth?` (${d.bandwidth})`:"");
          sel.appendChild(o);
        });
      });
    }
    document.addEventListener("DOMContentLoaded", loadPaketSelect);

    /* =============== Chart Tagihan (auto 5 menit) =============== */
    const chartCtx = document.getElementById("billingChart").getContext("2d");
    const billingChart = new Chart(chartCtx, {
      type: 'bar',
      data: { labels: [], datasets: [{ label: 'Total Tagihan (Rp)', data: [] }] },
      options: { responsive:true, scales:{ y:{ beginAtZero:true } } }
    });

    function loadBillingChart(){
      db.collection("billing").get().then(snap=>{
        const agg = {};
        snap.forEach(doc=>{
          const d = doc.data();
          const p = d.billingPeriod || 'N/A';
          const v = parseFloat(d.billingAmount||0);
          agg[p] = (agg[p]||0) + v;
        });
        const labels = Object.keys(agg).sort();
        const data = labels.map(k=>agg[k]);
        billingChart.data.labels = labels;
        billingChart.data.datasets[0].data = data;
        billingChart.update();
      });
    }
    loadBillingChart();
    setInterval(loadBillingChart, 5*60*1000);

    /* =============== Generic CRUD Renderer =============== */
    function renderTable(collection, tableId, fields){
      db.collection(collection).onSnapshot(snap=>{
        const tbody = document.querySelector(`#${tableId} tbody`);
        tbody.innerHTML = "";
        snap.forEach(doc=>{
          const d = doc.data();
          const tr = document.createElement("tr");
          fields.forEach(f=>{
            const td = document.createElement("td");
            td.textContent = d[f] ?? "";
            tr.appendChild(td);
          });
          const tdAct = document.createElement("td");
          tdAct.innerHTML =
            `<button class="btn success" onclick="editItem('${collection}','${doc.id}')">Edit</button>
             <button class="btn danger" onclick="deleteItem('${collection}','${doc.id}')">Hapus</button>`;
          tr.appendChild(tdAct);
          tbody.appendChild(tr);
        });
      });
    }

    function saveForm(e, collection, idField, fields){
      e.preventDefault();
      const id = document.getElementById(idField).value;
      const data = {};
      fields.forEach(f=> data[f] = document.getElementById(f).value );
      if(id){
        db.collection(collection).doc(id).update(data);
      }else{
        db.collection(collection).add(data);
      }
      e.target.reset();
      document.getElementById(idField).value = "";
    }

    function editItem(collection, id){
      db.collection(collection).doc(id).get().then(doc=>{
        if(!doc.exists) return;
        const d = doc.data();
        Object.keys(d).forEach(k=>{
          if(document.getElementById(k)) document.getElementById(k).value = d[k];
        });
        if(document.getElementById(collection+"Id")) document.getElementById(collection+"Id").value = id;
        showSection(collection);
      });
    }

    function deleteItem(collection, id){
      if(confirm("Yakin hapus data ini?")) db.collection(collection).doc(id).delete();
    }

    /* =============== Bind Forms + Tables =============== */
    // User
    document.getElementById("userForm").onsubmit = (e)=>saveForm(e,"user","userId",["userName","planName","statusBayar"]);
    renderTable("user","userTable",["userName","planName","statusBayar"]);

    // Paket
    document.getElementById("paketForm").onsubmit = (e)=>saveForm(e,"paket","paketId",["namaPaket","bandwidth"]);
    renderTable("paket","paketTable",["namaPaket","bandwidth"]);

    // Kas
    document.getElementById("kasForm").onsubmit = (e)=>saveForm(e,"kas","kasId",["kasKet","kasJumlah"]);
    renderTable("kas","kasTable",["kasKet","kasJumlah"]);

    // Teknisi
    document.getElementById("teknisiForm").onsubmit = (e)=>saveForm(e,"teknisi","teknisiId",["namaTeknisi","kontakTeknisi"]);
    renderTable("teknisi","teknisiTable",["namaTeknisi","kontakTeknisi"]);

    // Material
    document.getElementById("materialForm").onsubmit = (e)=>saveForm(e,"material","materialId",["namaMaterial","stokMaterial"]);
    renderTable("material","materialTable",["namaMaterial","stokMaterial"]);

    // ODP
    document.getElementById("odpForm").onsubmit = (e)=>saveForm(e,"odp","odpId",["namaODP","lokasiODP","kapasitasODP","terpakaiODP"]);
    renderTable("odp","odpTable",["namaODP","lokasiODP","kapasitasODP","terpakaiODP"]);

    /* =============== Dashboard Counters =============== */
    db.collection("user").onSnapshot(snap=>{
      document.getElementById("totalUser").textContent = snap.size;
      let tunggakanUser = 0;
      snap.forEach(doc=>{ if((doc.data().statusBayar||"") === "Belum") tunggakanUser++; });
      document.getElementById("totalTunggakan").textContent = tunggakanUser;
    });

    db.collection("kas").onSnapshot(snap=>{
      let saldo = 0;
      snap.forEach(doc=>{ saldo += parseFloat(doc.data().kasJumlah||0); });
      document.getElementById("saldoKas").textContent = new Intl.NumberFormat('id-ID').format(saldo);
    });

    /* =============== BILLING (Periode + Carry-Over Tunggakan) =============== */
    function periodToNum(p){ // "YYYY-MM" -> number YYYYMM
      if(!p || !/^\d{4}-\d{2}$/.test(p)) return 0;
      const [y,m] = p.split('-').map(x=>parseInt(x,10));
      return y*100 + m;
    }

    document.getElementById("billingForm").onsubmit = (e)=>{
      e.preventDefault();
      const id = document.getElementById("billingId").value;
      const user = (document.getElementById("billingUser").value||"").trim();
      const amount = parseFloat(document.getElementById("billingAmount").value||"0");
      const period = (document.getElementById("billingPeriod").value||"").trim();
      if(!user || !period){ alert("User & Periode wajib diisi."); return; }

      // Cari semua billing "Belum" user dari periode SEBELUM periode input -> digabung
      db.collection("billing").where("billingUser","==",user).where("status","==","Belum").get().then(snap=>{
        let carry = 0;
        const fromPeriods = [];
        const toUpdate = [];
        const targetNum = periodToNum(period);

        snap.forEach(doc=>{
          const d = doc.data();
          const p = d.billingPeriod||"";
          if(periodToNum(p) < targetNum){ // hanya periode sebelumnya
            carry += parseFloat(d.billingAmount||0);
            if(p) fromPeriods.push(p);
            toUpdate.push(doc.ref);
          }
        });

        const data = {
          billingUser: user,
          billingAmount: amount + carry,
          billingPeriod: period,
          status: "Belum",
          catatan: carry>0 ? ("Gabung tunggakan dari: "+fromPeriods.join(", ")) : ""
        };

        const save = id ? db.collection("billing").doc(id).update(data) : db.collection("billing").add(data);
        return save.then(()=>{
          if(toUpdate.length===0) return;
          const batch = db.batch();
          toUpdate.forEach(ref=>{
            batch.update(ref, { catatan: "Digabung ke "+period });
          });
          return batch.commit();
        });
      }).finally(()=>{
        e.target.reset();
        document.getElementById("billingId").value = "";
        loadBillingChart();
      });
    };

    function renderBilling(){
      db.collection("billing").orderBy("billingPeriod","desc").onSnapshot(snap=>{
        const tbody = document.querySelector("#billingTable tbody");
        tbody.innerHTML = "";
        snap.forEach(doc=>{
          const d = doc.data();
          const tr = document.createElement("tr");
          const statusBadge = d.status==="Belum" ? `<span class="pill danger">Belum</span>` : `<span class="pill success">Lunas</span>`;
          tr.innerHTML = `
            <td>${d.billingUser||""}</td>
            <td>${new Intl.NumberFormat('id-ID').format(parseFloat(d.billingAmount||0))}</td>
            <td>${d.billingPeriod||""}</td>
            <td>${statusBadge}</td>
            <td>${d.catatan||""}</td>
            <td>
              <button class="btn success" onclick="editBilling('${doc.id}')">Edit</button>
              <button class="btn danger" onclick="deleteBilling('${doc.id}')">Hapus</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      });
    }
    renderBilling();

    function editBilling(id){
      db.collection("billing").doc(id).get().then(doc=>{
        if(!doc.exists) return;
        const d = doc.data();
        document.getElementById("billingUser").value = d.billingUser||"";
        document.getElementById("billingAmount").value = d.billingAmount||"";
        document.getElementById("billingPeriod").value = d.billingPeriod||"";
        document.getElementById("billingId").value = id;
        showSection('billing');
      });
    }
    function deleteBilling(id){
      if(confirm("Yakin hapus billing ini?")) db.collection("billing").doc(id).delete().then(loadBillingChart);
    }

    /* =============== GANGGUAN (Random, TTR berjalan, Close) =============== */
    function formatTTR(ms){
      const h = Math.floor(ms/3600000);
      const m = Math.floor((ms%3600000)/60000);
      const s = Math.floor((ms%60000)/1000);
      return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    function loadGangguan(){
      db.collection("gangguan").orderBy("waktu","desc").limit(50).get().then(snap=>{
        const tbody = document.querySelector("#gangguanTable tbody");
        tbody.innerHTML = "";
        let activeCount = 0;
        const now = Date.now();
        snap.forEach(doc=>{
          const d = doc.data();
          let ttr = "00:00:00";
          if((d.status||"Aktif")==="Aktif"){
            const start = new Date(d.waktu).getTime();
            ttr = formatTTR(now - start);
            activeCount++;
          }else if(d.ttr){ ttr = d.ttr; }

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d.user||""}</td>
            <td>${d.indikasi||""}</td>
            <td>${d.waktu ? new Date(d.waktu).toLocaleString() : ""}</td>
            <td class="ttr-cell" data-waktu="${d.waktu||""}" data-status="${d.status||"Aktif"}">${ttr}</td>
            <td>${d.status||"Aktif"}</td>
            <td>${(d.status||"Aktif")==="Aktif" ? `<button class="btn success" onclick="closeGangguan('${doc.id}')">Close</button>` : "-"}</td>
          `;
          tbody.appendChild(tr);
        });
        document.getElementById("totalGangguan").textContent = activeCount;
      });
    }
    loadGangguan();
    // Update TTR tampil tiap 1 detik tanpa reload Firestore
    setInterval(()=>{
      document.querySelectorAll('#gangguanTable .ttr-cell').forEach(td=>{
        if(td.dataset.status!=="Aktif") return;
        const w = td.dataset.waktu;
        if(!w) return;
        const ms = Date.now() - new Date(w).getTime();
        td.textContent = formatTTR(ms);
      });
    }, 1000);
    // Refresh data dari Firestore tiap 60 detik
    setInterval(loadGangguan, 60000);

    function simulateGangguan(){
      db.collection("user").get().then(snap=>{
        if(snap.empty){ alert("Belum ada user! Tambahkan user dulu."); return; }
        const users = [];
        snap.forEach(doc=>users.push(doc.data().userName));
        const randUser = users[Math.floor(Math.random()*users.length)];
        const indikasi = ["Koneksi putus","Sinyal lemah","Loss tinggi","OLT down"][Math.floor(Math.random()*4)];
        db.collection("gangguan").add({
          user: randUser,
          indikasi,
          waktu: new Date().toISOString(),
          status: "Aktif"
        }).then(loadGangguan);
      });
    }

    function closeGangguan(id){
      db.collection("gangguan").doc(id).get().then(doc=>{
        if(!doc.exists) return;
        const d = doc.data();
        const ms = Date.now() - new Date(d.waktu).getTime();
        const ttr = formatTTR(ms);
        db.collection("gangguan").doc(id).update({ status:"Selesai", ttr }).then(loadGangguan);
      });
    }

    function clearGangguan(){
      if(!confirm("Yakin hapus semua gangguan?")) return;
      db.collection("gangguan").get().then(snap=>{
        const batch = db.batch();
        snap.forEach(doc=> batch.delete(doc.ref) );
        return batch.commit();
      }).then(loadGangguan);
    }
  </script>
</body>
</html>
