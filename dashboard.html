<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Starnet üí´ Manager</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --pri:#6d28d9; --pri-d:#4c1d95; --bg:#f4f6f9; --card:#fff; --ink:#0f172a; --mut:#64748b;
    --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  /* TOPBAR + HAMBURGER (dirapikan) */
  .topbar{position:fixed;top:0;left:0;right:0;height:56px;background:var(--card);display:flex;align-items:center;gap:10px;padding:0 12px 0 8px;border-bottom:1px solid #e5e7eb;z-index:30}
  .hamburger{width:38px;height:38px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,.05);transition:transform .15s}
  .hamburger:hover{transform:scale(1.04)}
  .hamburger .bar{width:18px;height:2px;background:var(--pri);position:relative;border-radius:2px}
  .hamburger .bar::before,.hamburger .bar::after{content:"";position:absolute;left:0;width:18px;height:2px;background:var(--pri);border-radius:2px}
  .hamburger .bar::before{top:-6px}.hamburger .bar::after{top:6px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:700}
  .brand img{height:28px;width:28px;border-radius:6px;object-fit:cover;display:none}
  .brand span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:40vw}
  /* SIDEBAR (warna diubah) */
  .sidebar{position:fixed;top:56px;left:0;width:250px;bottom:0;background:linear-gradient(180deg,var(--pri),var(--pri-d));color:#fff;overflow:hidden;transition:width .25s;z-index:20}
  .sidebar.minimized{width:64px}
  .nav{padding:10px}
  .nav a{display:flex;align-items:center;gap:12px;color:#fff;text-decoration:none;padding:10px 12px;border-radius:12px;margin:4px 0;transition:background .2s}
  .nav a:hover{background:rgba(255,255,255,.18)}
  .nav .icon{width:28px;text-align:center;color:#ffdd00}
  .nav .text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .sidebar.minimized .text{display:none}
  /* MAIN */
  .main{margin-top:56px;margin-left:250px;padding:16px;transition:margin-left .25s}
  .main.sidebar-minimized{margin-left:64px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:14px}
  .card{background:var(--card);border-radius:16px;padding:18px;box-shadow:0 2px 10px rgba(0,0,0,.06);transition:transform .15s}
  .card:hover{transform:translateY(-2px)}
  h2{margin:8px 0 14px} h3{margin:0 0 8px} .muted{color:var(--mut);font-size:12px}
  /* tables */
  table{width:100%;border-collapse:collapse}
  .table{background:var(--card);border-radius:14px;overflow:hidden;box-shadow:0 1px 6px rgba(0,0,0,.05)}
  th,td{padding:10px;border-bottom:1px solid #eef2f7}
  thead th{background:var(--pri);color:#fff;text-align:left}
  tbody tr:hover{background:#f8fafc}
  /* forms */
  .form{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}
  .field{display:flex;flex-direction:column;gap:6px}
  .field input,.field select,.field textarea{padding:10px;border:1px solid #e5e7eb;border-radius:10px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button{padding:10px 12px;border:none;border-radius:12px;cursor:pointer}
  .btn{background:var(--pri);color:#fff} .btn:hover{background:var(--pri-d)}
  .btn-ghost{background:#fff;border:1px solid #e5e7eb}
  .btn-bad{background:var(--bad);color:#fff} .btn-ok{background:var(--ok);color:#fff}
  /* dashboard gangguan list */
  #dashboardGangguanContainer{max-height:260px;overflow-y:auto;margin-top:10px}
  #dashboardGangguan td,#dashboardGangguan th{text-align:center}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px}
  .pill.ok{background:#dcfce7;color:#166534}.pill.bad{background:#fee2e2;color:#991b1b}.pill.warn{background:#fef3c7;color:#92400e}
  /* modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:40}
  .modal .sheet{background:#fff;max-width:720px;width:95%;border-radius:16px;padding:16px;max-height:80vh;overflow:auto}
  /* layout helper */
  .split{display:grid;grid-template-columns:320px 1fr;gap:12px}
  @media (max-width:900px){.split{grid-template-columns:1fr}}
  /* tabs */
  .tabs{display:flex;gap:8px;margin-bottom:10px}
  .tab{padding:8px 12px;border-radius:999px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
  .tab.active{background:var(--pri);color:#fff;border-color:transparent}
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="hamburger" id="hamburger" title="Toggle menu"><div class="bar"></div></div>
  <div class="brand">
    <img id="brandLogo" alt="logo" />
    <span id="ispName">Starnet üí´</span>
  </div>
</div>

<!-- SIDEBAR (lengkap) -->
<div class="sidebar" id="sidebar">
  <nav class="nav">
    <a href="#" onclick="showSection('dashboard')"><span class="icon">üè†</span><span class="text">Dashboard</span></a>
    <a href="#" onclick="showSection('user')"><span class="icon">üë§</span><span class="text">User</span></a>
    <a href="#" onclick="showSection('odp')"><span class="icon">üóÇÔ∏è</span><span class="text">ODP</span></a>
    <a href="#" onclick="showSection('paket')"><span class="icon">üì¶</span><span class="text">Paket</span></a>
    <a href="#" onclick="showSection('billing')"><span class="icon">üíµ</span><span class="text">Billing</span></a>
    <a href="#" onclick="showSection('kas')"><span class="icon">üè¶</span><span class="text">Kas</span></a>
    <a href="#" onclick="showSection('teknisi')"><span class="icon">üõ†Ô∏è</span><span class="text">Teknisi</span></a>
    <a href="#" onclick="showSection('gangguan')"><span class="icon">‚ö†Ô∏è</span><span class="text">Gangguan</span></a>
    <a href="#" onclick="showSection('material')"><span class="icon">üìã</span><span class="text">Material</span></a>
    <a href="#" onclick="showSection('laporan')"><span class="icon">üìë</span><span class="text">Laporan (Pelanggan)</span></a>
    <a href="#" onclick="showSection('editisp')"><span class="icon">‚úèÔ∏è</span><span class="text">Edit ISP</span></a>
    <a href="#" onclick="logout()"><span class="icon">üîì</span><span class="text">Logout</span></a>
  </nav>
</div>

<!-- MAIN -->
<div class="main" id="mainContent">

  <!-- DASHBOARD -->
  <div id="dashboard" class="section">
    <h2>Dashboard</h2>
    <div class="grid">
      <div class="card"><h3>Total User</h3><div id="totalUser" class="muted">0</div></div>
      <div class="card"><h3>Saldo Kas</h3><div id="saldoKas" class="muted">0</div></div>
      <div class="card"><h3>Tunggakan</h3><div id="totalTunggakan" class="muted">0</div></div>
      <div class="card"><h3>Gangguan Aktif</h3><div id="totalGangguan" class="muted">0</div></div>
    </div>
    <div class="card">
      <h3>Grafik Traffic (Realtime)</h3>
      <canvas id="ispChart"></canvas>
      <div class="muted">Sumber: koleksi <code>grafik</code> (waktu, upload, download)</div>
    </div>
    <div class="card">
      <h3>Gangguan Terbaru</h3>
      <div id="dashboardGangguanContainer">
        <table id="dashboardGangguan" class="table">
          <thead><tr><th>User</th><th>Indikasi</th><th>Mulai</th><th>TTR</th><th>Status</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- USER -->
  <div id="user" class="section">
    <h2>Manajemen User</h2>
    <div class="card">
      <h3>Tambah / Edit User</h3>
      <div class="form">
        <div class="field"><label>Nama Lengkap</label><input id="u_namaLengkap" placeholder="Nama Lengkap"></div>
        <div class="field"><label>Username</label><input id="u_userName" placeholder="user.id"></div>
        <div class="field"><label>Alamat</label><input id="u_alamat" placeholder="Alamat"></div>
        <div class="field"><label>Telepon</label><input id="u_telp" placeholder="08xx"></div>
        <div class="field"><label>Paket</label><input id="u_paket" placeholder="10 Mbps"></div>
        <div class="field"><label>Jenis ONT</label><input id="u_jenisOnt" placeholder="ZTE/Huawei, dll"></div>
        <div class="field"><label>SN/MAC ONT</label><input id="u_snOnt" placeholder="SN/MAC"></div>
        <div class="field"><label>ODP</label><input id="u_odp" placeholder="ODP-01"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" id="userSaveBtn" onclick="saveUser()">Simpan</button>
        <button class="btn-ghost" onclick="resetUserForm()">Reset</button>
      </div>
      <div class="muted" id="userFormMode" style="margin-top:6px">Mode: Tambah</div>
    </div>
    <div class="card">
      <h3>Daftar User</h3>
      <table class="table" id="userTable">
        <thead><tr><th>Nama</th><th>Username</th><th>Telp</th><th>Paket</th><th>ONT (Jenis/SN)</th><th>ODP</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ODP -->
  <div id="odp" class="section">
    <h2>Manajemen ODP</h2>
    <div class="split">
      <div class="card">
        <h3>Tambah ODP</h3>
        <div class="row">
          <input id="odpNama" placeholder="Nama ODP (mis. ODP-01)" style="flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:10px">
          <button class="btn" onclick="addODP()">Tambah</button>
        </div>
        <div class="row" style="margin-top:10px">
          <input id="odpSearch" placeholder="Cari ODP..." oninput="filterODP()" style="flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:10px">
        </div>
        <div style="height:12px"></div>
        <h3>Daftar ODP</h3>
        <table class="table" id="odpTable">
          <thead><tr><th>Nama ODP</th><th>Jumlah Pelanggan</th><th>Aksi</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card">
        <h3>Detail ODP: <span id="detailODPName">-</span></h3>
        <table class="table" id="odpUserTable">
          <thead><tr><th>Nama</th><th>Username</th><th>Telp</th><th>Paket</th><th>Alamat</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- PAKET -->
  <div id="paket" class="section">
    <h2>Manajemen Paket</h2>
    <div class="card">
      <div class="form">
        <div class="field"><label>Nama Paket</label><input id="p_nama" placeholder="Home 10"></div>
        <div class="field"><label>Bandwidth</label><input id="p_bw" placeholder="10 Mbps"></div>
        <div class="field"><label>Harga</label><input id="p_harga" type="number" placeholder="150000"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="savePaket()">Simpan</button>
        <button class="btn-ghost" onclick="resetPaket()">Reset</button>
      </div>
    </div>
    <div class="card">
      <table class="table" id="paketTable"><thead><tr><th>Nama</th><th>Bandwidth</th><th>Harga</th><th>Aksi</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <!-- BILLING -->
  <div id="billing" class="section">
    <h2>Billing</h2>
    <div class="card">
      <div class="tabs">
        <div class="tab active" id="tabPeriode" onclick="switchBillingTab('periode')">Periode</div>
        <div class="tab" id="tabTunggakan" onclick="switchBillingTab('tunggakan')">Tunggakan</div>
      </div>
      <div class="row">
        <select id="billMonth" onchange="loadBillingTable()">
          <option value="">Bulan (semua)</option>
          <script>/* options injected later */</script>
        </select>
        <select id="billYear" onchange="loadBillingTable()">
          <option value="">Tahun (semua)</option>
        </select>
      </div>
    </div>
    <div class="card">
      <table class="table" id="billingTable"><thead><tr><th>Tanggal</th><th>User</th><th>Jumlah</th><th>Status</th><th>Aksi</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <!-- KAS -->
  <div id="kas" class="section">
    <h2>Kas</h2>
    <div class="card">
      <div class="form">
        <div class="field"><label>Tipe</label><select id="k_tipe"><option value="masuk">Masuk</option><option value="keluar">Keluar</option></select></div>
        <div class="field"><label>Jumlah</label><input id="k_jumlah" type="number" placeholder="0"></div>
        <div class="field"><label>Keterangan</label><input id="k_ket" placeholder="Deskripsi"></div>
      </div>
      <div class="row" style="margin-top:10px"><button class="btn" onclick="addKas()">Tambah</button></div>
    </div>
    <div class="card">
      <table class="table" id="kasTable"><thead><tr><th>Tanggal</th><th>Tipe</th><th>Jumlah</th><th>Keterangan</th><th>Aksi</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <!-- TEKNISI -->
  <div id="teknisi" class="section">
    <h2>Teknisi</h2>
    <div class="card">
      <div class="form">
        <div class="field"><label>Nama</label><input id="t_nama" placeholder="Nama teknisi"></div>
        <div class="field"><label>Telp</label><input id="t_telp" placeholder="08xx"></div>
        <div class="field"><label>Status</label>
          <select id="t_standby"><option value="true">Standby</option><option value="false">Off</option></select>
        </div>
      </div>
      <div class="row" style="margin-top:10px"><button class="btn" onclick="saveTeknisi()">Simpan</button><button class="btn-ghost" onclick="resetTeknisi()">Reset</button></div>
    </div>
    <div class="card">
      <table class="table" id="teknisiTable"><thead><tr><th>Nama</th><th>Telp</th><th>Standby</th><th>Aksi</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <!-- GANGGUAN -->
  <div id="gangguan" class="section">
    <h2>Gangguan</h2>
    <div class="card">
      <div class="row" style="margin-bottom:8px">
        <button class="btn" onclick="refreshGangguan()">Refresh</button>
      </div>
      <table class="table" id="gangguanTable">
        <thead><tr><th>User</th><th>Indikasi</th><th>Teknisi</th><th>Status</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="card">
      <h3>Progres Teknisi</h3>
      <div class="muted">Progres realtime dari field <code>progres</code> pada dokumen gangguan.</div>
      <div class="progress-bar-container" style="background:#e5e7eb;border-radius:12px;overflow:hidden;height:14px;margin-top:8px">
        <div class="progress-bar" id="progressBar" style="height:14px;background:var(--pri);width:0%"></div>
      </div>
      <div class="muted" id="progressLabel" style="margin-top:6px">0%</div>
    </div>
  </div>

  <!-- MATERIAL -->
  <div id="material" class="section">
    <h2>Material</h2>
    <div class="card">
      <div class="form">
        <div class="field"><label>Nama Material</label><input id="m_nama" placeholder="Dropcore 1F"></div>
        <div class="field"><label>Stok</label><input id="m_stok" type="number" placeholder="0"></div>
        <div class="field"><label>Satuan</label><input id="m_satuan" placeholder="meter, pcs, dll"></div>
      </div>
      <div class="row" style="margin-top:10px"><button class="btn" onclick="saveMaterial()">Simpan</button><button class="btn-ghost" onclick="resetMaterial()">Reset</button></div>
    </div>
    <div class="card">
      <table class="table" id="materialTable"><thead><tr><th>Nama</th><th>Stok</th><th>Satuan</th><th>Aksi</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <!-- LAPORAN -->
  <div id="laporan" class="section">
    <h2>Laporan Pelanggan</h2>
    <div class="card">
      <div class="row">
        <select id="lapUserSelect" style="flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:10px"></select>
        <button class="btn" onclick="loadLaporan()">Tampilkan</button>
      </div>
    </div>
    <div class="grid">
      <div class="card"><h3>Tagihan Belum Dibayar</h3><div id="lapUnpaid" class="muted">-</div></div>
      <div class="card"><h3>Total Tunggakan (Rp)</h3><div id="lapUnpaidSum" class="muted">-</div></div>
      <div class="card"><h3>Riwayat Gangguan</h3><div id="lapGangCount" class="muted">-</div></div>
      <div class="card"><h3>Rata-rata TTR</h3><div id="lapAvgTTR" class="muted">-</div></div>
    </div>
    <div class="card">
      <h3>Tagihan</h3>
      <table class="table" id="lapBillingTable"><thead><tr><th>Tanggal</th><th>Jumlah</th><th>Status</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="card">
      <h3>Gangguan</h3>
      <table class="table" id="lapGangTable"><thead><tr><th>Mulai</th><th>Selesai</th><th>TTR</th><th>Status</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <!-- EDIT ISP -->
  <div id="editisp" class="section">
    <h2>Edit ISP</h2>
    <div class="card">
      <div class="form">
        <div class="field"><label>Nama ISP</label><input id="newISPName" placeholder="Starnet üí´"></div>
        <div class="field"><label>Upload Logo</label><input type="file" id="ispLogo" accept="image/*"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="editISP()">Simpan</button>
        <button class="btn-ghost" onclick="clearLogo()">Hapus Logo</button>
      </div>
      <div id="logoPreview" style="margin-top:12px" class="muted">Belum ada logo.</div>
    </div>
  </div>

</div><!-- /main -->

<!-- MODAL LOG USER -->
<div class="modal" id="logModal">
  <div class="sheet">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3>Log Perubahan User</h3>
      <button class="btn-ghost" onclick="closeLog()">Tutup</button>
    </div>
    <table class="table" id="logTable"><thead><tr><th>Waktu</th><th>Aksi</th><th>Detail</th></tr></thead><tbody></tbody></table>
  </div>
</div>

<!-- MODAL ORDER TEKNISI -->
<div class="modal" id="orderModal">
  <div class="sheet">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3>Pilih Teknisi Standby</h3>
      <button class="btn-ghost" onclick="closeOrder()">Tutup</button>
    </div>
    <table class="table" id="orderTeknisiTable"><thead><tr><th>Nama</th><th>Telp</th><th>Aksi</th></tr></thead><tbody></tbody></table>
  </div>
</div>

<script>
/* ========= Firebase ========= */
const firebaseConfig={apiKey:"AIzaSyB-iBpZNC0YZBTAUzir7gJuU9kBQg82moc",authDomain:"dnt-network-7.firebaseapp.com",projectId:"dnt-network-7",storageBucket:"dnt-network-7.firebasestorage.app",messagingSenderId:"761179668371",appId:"1:761179668371:web:7d1468d0298041d4783266"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

/* ========= Helpers ========= */
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
function showSection(id){$$(".section").forEach(s=>s.style.display="none");$("#"+id).style.display="block"}
$("#hamburger").addEventListener("click",()=>{document.getElementById("sidebar").classList.toggle("minimized");document.getElementById("mainContent").classList.toggle("sidebar-minimized")});
function logout(){alert("Logout sukses!")}
function tsToDate(ts){ if(!ts) return null; if(ts.seconds) return new Date(ts.seconds*1000); if(typeof ts==="number") return new Date(ts); return null;}
function pad(n){return n<10?"0"+n:n}
function fmtDate(d){ if(!d) return "-"; return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}` }
function fmtRupiah(n){ if(n==null || isNaN(n)) return "-"; return new Intl.NumberFormat('id-ID').format(n)}
function durStr(ms){ if(ms==null || ms<0) return "-"; const m=Math.floor(ms/60000);const d=Math.floor(m/1440);const h=Math.floor((m%1440)/60);const mm=m%60; if(d>0) return `${d}h ${h}j ${mm}m`; if(h>0) return `${h}j ${mm}m`; return `${mm}m`; }

/* ========= Dashboard: cards + chart realtime + gangguan terbaru (running TTR) ========= */
let ispChart;
function initChart(){
  const ctx=document.getElementById("ispChart").getContext("2d");
  ispChart=new Chart(ctx,{type:'line',data:{labels:[],datasets:[
    {label:"Upload",data:[],borderColor:"blue"},
    {label:"Download",data:[],borderColor:"green"}
  ]},options:{responsive:true,animation:false,scales:{x:{display:true},y:{beginAtZero:true}}}});
}
function loadChartRealtime(){
  db.collection("grafik").orderBy("waktu","asc").onSnapshot(snap=>{
    const labels=[], up=[], down=[];
    snap.forEach(doc=>{const g=doc.data(); const d=tsToDate(g.waktu)||new Date(); labels.push(d.toLocaleTimeString()); up.push(g.upload||0); down.push(g.download||0)});
    ispChart.data.labels=labels; ispChart.data.datasets[0].data=up; ispChart.data.datasets[1].data=down; ispChart.update();
  });
}
function updateCards(){
  db.collection("user").get().then(s=>$("#totalUser").innerText=s.size);
  db.collection("kas").get().then(s=>{let saldo=0;s.forEach(d=>{const k=d.data(); saldo+=k.tipe==="masuk"?Number(k.jumlah||0):-Number(k.jumlah||0)}); $("#saldoKas").innerText=fmtRupiah(saldo)});
  db.collection("billing").where("status","==","unpaid").get().then(s=>$("#totalTunggakan").innerText=s.size);
  db.collection("gangguan").where("status","==","aktif").get().then(s=>$("#totalGangguan").innerText=s.size);
}
/* Gangguan terbaru + TTR berjalan */
let runningTTRRows=[]; // simpan elemen yang perlu diupdate
function loadDashboardGangguan(){
  const tbody=$("#dashboardGangguan tbody"); tbody.innerHTML="";
  runningTTRRows=[];
  db.collection("gangguan").orderBy("waktu","desc").limit(5).onSnapshot(snap=>{
    tbody.innerHTML=""; runningTTRRows=[];
    snap.forEach(doc=>{
      const g=doc.data(), id=doc.id;
      const start=tsToDate(g.waktu);
      const end=g.selesai?tsToDate(g.selesai):null;
      const badge = g.status==="selesai"?"ok": (g.status==="aktif"||g.status==="progres"?"warn":"bad");
      const tr=document.createElement("tr");
      const ttrSpan=document.createElement("span"); ttrSpan.className=`pill ${badge}`; ttrSpan.id=`ttr-${id}`;
      tr.innerHTML=`<td>${g.user||"-"}</td>
        <td>${g.indikasi||"-"}</td>
        <td>${fmtDate(start)}</td>
        <td id="ttrcell-${id}"></td>
        <td>${g.status||"-"}</td>`;
      tbody.appendChild(tr);
      document.getElementById(`ttrcell-${id}`).appendChild(ttrSpan);
      runningTTRRows.push({el:ttrSpan,start,end,status:g.status});
      // set teks awal
      if(end){ ttrSpan.textContent = durStr(end-start); } else { ttrSpan.textContent = durStr(Date.now()-start); }
    });
  });
}
setInterval(()=>{ // update running TTR setiap 30 detik
  runningTTRRows.forEach(r=>{
    if(!r.start) return;
    const val = r.end? (r.end - r.start) : (Date.now()-r.start);
    r.el.textContent = durStr(val);
  });
},30000);

/* ========= USER CRUD + Log ========= */
let editUserId=null;
function resetUserForm(){ editUserId=null; ["u_namaLengkap","u_userName","u_alamat","u_telp","u_paket","u_jenisOnt","u_snOnt","u_odp"].forEach(id=>$("#"+id).value=""); $("#userFormMode").innerText="Mode: Tambah"; $("#userSaveBtn").innerText="Simpan"; }
function saveUser(){
  const data={ namaLengkap:$("#u_namaLengkap").value.trim(), userName:$("#u_userName").value.trim(), alamat:$("#u_alamat").value.trim(), telp:$("#u_telp").value.trim(), paket:$("#u_paket").value.trim(), jenisOnt:$("#u_jenisOnt").value.trim(), snOnt:$("#u_snOnt").value.trim(), odp:$("#u_odp").value.trim() };
  if(!data.namaLengkap || !data.userName){alert("Nama & Username wajib diisi");return}
  if(editUserId){
    db.collection("user").doc(editUserId).get().then(doc=>{
      const before=doc.data()||{};
      db.collection("user").doc(editUserId).set(data,{merge:true}).then(()=>{
        db.collection("user").doc(editUserId).collection("logs").add({waktu:firebase.firestore.FieldValue.serverTimestamp(),aksi:"update",detail:JSON.stringify({before,after:data})});
        resetUserForm(); loadUserTable(); loadODPTable(); fillLaporanUserSelect();
      });
    });
  }else{
    db.collection("user").add(data).then(ref=>{
      db.collection("user").doc(ref.id).collection("logs").add({waktu:firebase.firestore.FieldValue.serverTimestamp(),aksi:"create",detail:JSON.stringify(data)});
      resetUserForm(); loadUserTable(); loadODPTable(); fillLaporanUserSelect();
    });
  }
}
function loadUserTable(){
  const tbody=$("#userTable tbody"); tbody.innerHTML="";
  db.collection("user").orderBy("namaLengkap","asc").get().then(snap=>{
    snap.forEach(doc=>{
      const u=doc.data(), id=doc.id;
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${u.namaLengkap||"-"}</td>
        <td>${u.userName||"-"}</td>
        <td>${u.telp||"-"}</td>
        <td>${u.paket||"-"}</td>
        <td>${u.jenisOnt||"-"} / ${u.snOnt||"-"}</td>
        <td>${u.odp||"-"}</td>
        <td class="row">
          <button class="btn" onclick="editUser('${id}')">Edit</button>
          <button class="btn-bad" onclick="deleteUser('${id}')">Hapus</button>
          <button class="btn-ghost" onclick="openLog('${id}')">Log</button>
        </td>`;
      tbody.appendChild(tr);
    });
  });
}
function editUser(id){
  db.collection("user").doc(id).get().then(doc=>{
    const u=doc.data(); editUserId=id;
    $("#u_namaLengkap").value=u.namaLengkap||""; $("#u_userName").value=u.userName||""; $("#u_alamat").value=u.alamat||"";
    $("#u_telp").value=u.telp||""; $("#u_paket").value=u.paket||""; $("#u_jenisOnt").value=u.jenisOnt||"";
    $("#u_snOnt").value=u.snOnt||""; $("#u_odp").value=u.odp||"";
    $("#userFormMode").innerText="Mode: Edit"; $("#userSaveBtn").innerText="Update";
    showSection('user');
  });
}
function deleteUser(id){ if(!confirm("Hapus user ini?"))return; db.collection("user").doc(id).delete().then(()=>{loadUserTable(); loadODPTable(); fillLaporanUserSelect()}); }
function openLog(userId){
  $("#logModal").style.display="flex";
  const tbody=$("#logTable tbody"); tbody.innerHTML="";
  db.collection("user").doc(userId).collection("logs").orderBy("waktu","desc").get().then(snap=>{
    snap.forEach(d=>{ const l=d.data(); const tr=document.createElement("tr"); tr.innerHTML=`<td>${fmtDate(tsToDate(l.waktu))}</td><td>${l.aksi}</td><td><pre style="white-space:pre-wrap;margin:0">${(l.detail||"")}</pre></td>`; tbody.appendChild(tr); });
  });
}
function closeLog(){ $("#logModal").style.display="none" }

/* ========= ODP ========= */
let odpCache=[]; // untuk search
function addODP(){ const nama=$("#odpNama").value.trim(); if(!nama){alert("Nama ODP wajib");return} db.collection("odp").add({nama}).then(()=>{$("#odpNama").value=""; loadODPTable()}); }
async function loadODPTable(){
  const tbody=$("#odpTable tbody"); tbody.innerHTML="";
  const snap=await db.collection("odp").orderBy("nama","asc").get(); odpCache=snap.docs.map(d=>({id:d.id,...d.data()}));
  for(const o of odpCache){
    const countSnap=await db.collection("user").where("odp","==",o.nama).get();
    const tr=document.createElement("tr");
    tr.dataset.name=o.nama.toLowerCase();
    tr.innerHTML=`<td>${o.nama}</td><td>${countSnap.size}</td>
      <td class="row"><button class="btn" onclick="showODPDetail('${o.nama}')">Lihat</button>
      <button class="btn-bad" onclick="deleteODP('${o.id}','${o.nama}')">Hapus</button></td>`;
    tbody.appendChild(tr);
  }
}
function filterODP(){
  const q=$("#odpSearch").value.trim().toLowerCase();
  $$("#odpTable tbody tr").forEach(tr=>{
    tr.style.display = (!q || tr.dataset.name.includes(q)) ? "" : "none";
  });
}
function showODPDetail(nama){
  $("#detailODPName").innerText=nama;
  const tbody=$("#odpUserTable tbody"); tbody.innerHTML="";
  db.collection("user").where("odp","==",nama).orderBy("namaLengkap","asc").get().then(snap=>{
    snap.forEach(d=>{ const u=d.data(); const tr=document.createElement("tr");
      tr.innerHTML=`<td>${u.namaLengkap||"-"}</td><td>${u.userName||"-"}</td><td>${u.telp||"-"}</td><td>${u.paket||"-"}</td><td>${u.alamat||"-"}</td>`;
      tbody.appendChild(tr);
    });
  });
}
function deleteODP(id,nama){
  if(!confirm("Hapus ODP ini? (data user tidak dihapus)"))return;
  db.collection("odp").doc(id).delete().then(()=>{loadODPTable(); if($("#detailODPName").innerText===nama){ $("#detailODPName").innerText="-"; $("#odpUserTable tbody").innerHTML="" }});
}

/* ========= Paket ========= */
let editPaketId=null;
function resetPaket(){ editPaketId=null; $("#p_nama").value=""; $("#p_bw").value=""; $("#p_harga").value=""; loadPaketTable(); }
function savePaket(){
  const data={namaPaket:$("#p_nama").value.trim(), bandwidth:$("#p_bw").value.trim(), harga:Number($("#p_harga").value||0)};
  if(!data.namaPaket){alert("Nama paket wajib");return}
  if(editPaketId){ db.collection("paket").doc(editPaketId).set(data,{merge:true}).then(resetPaket); }
  else{ db.collection("paket").add(data).then(resetPaket); }
}
function loadPaketTable(){
  const tbody=$("#paketTable tbody"); tbody.innerHTML="";
  db.collection("paket").orderBy("namaPaket","asc").get().then(snap=>{
    snap.forEach(d=>{ const p=d.data(), id=d.id; const tr=document.createElement("tr");
      tr.innerHTML=`<td>${p.namaPaket}</td><td>${p.bandwidth||"-"}</td><td>Rp ${fmtRupiah(p.harga)}</td>
      <td class="row"><button class="btn" onclick="editPaket('${id}')">Edit</button><button class="btn-bad" onclick="deleteDoc('paket','${id}',loadPaketTable)">Hapus</button></td>`;
      tbody.appendChild(tr);
    });
  });
}
function editPaket(id){ db.collection("paket").doc(id).get().then(doc=>{ const p=doc.data(); editPaketId=id; $("#p_nama").value=p.namaPaket||""; $("#p_bw").value=p.bandwidth||""; $("#p_harga").value=p.harga||0 })}

/* ========= Billing (Periode & Tunggakan) ========= */
let billingTab="periode";
function switchBillingTab(tab){ billingTab=tab; $("#tabPeriode").classList.toggle("active",tab==='periode'); $("#tabTunggakan").classList.toggle("active",tab==='tunggakan'); loadBillingTable(); }
function initBillingFilters(){
  const monthSel=$("#billMonth"), yearSel=$("#billYear");
  // bulan
  const months=["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];
  months.forEach((m,i)=>{ const opt=document.createElement("option"); opt.value=(i+1); opt.textContent=m; monthSel.appendChild(opt); });
  // tahun (5 thn ke belakang)
  const now=new Date().getFullYear();
  for(let y=now;y>=now-5;y--){ const opt=document.createElement("option"); opt.value=y; opt.textContent=y; yearSel.appendChild(opt); }
}
function loadBillingTable(){
  const tbody=$("#billingTable tbody"); tbody.innerHTML="";
  let q=db.collection("billing");
  if(billingTab==='tunggakan') q=q.where("status","==","unpaid");
  q.orderBy("waktu","desc").get().then(snap=>{
    const month=$("#billMonth").value, year=$("#billYear").value;
    snap.forEach(d=>{
      const b=d.data(); const dt=tsToDate(b.waktu); const m=dt?(""+(dt.getMonth()+1)):""; const y=dt?(""+dt.getFullYear()):"";
      if(month && m!==month) return;
      if(year && y!==year) return;
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${fmtDate(dt)}</td><td>${b.user}</td><td>Rp ${fmtRupiah(b.jumlah)}</td><td>${b.status}</td>
      <td class="row">${b.status==='unpaid'?`<button class="btn-ok" onclick="payBilling('${d.id}')">Bayar</button>`:""}<button class="btn-ghost" onclick="deleteDoc('billing','${d.id}',loadBillingTable)">Hapus</button></td>`;
      tbody.appendChild(tr);
    });
  });
}
function payBilling(id){ db.collection("billing").doc(id).update({status:"paid"}).then(()=>{loadBillingTable(); updateCards()}) }

/* ========= Kas ========= */
function addKas(){
  const data={tipe:$("#k_tipe").value, jumlah:Number($("#k_jumlah").value||0), keterangan:$("#k_ket").value.trim(), waktu:firebase.firestore.FieldValue.serverTimestamp()};
  db.collection("kas").add(data).then(()=>{ $("#k_jumlah").value=""; $("#k_ket").value=""; loadKasTable(); updateCards(); });
}
function loadKasTable(){
  const tbody=$("#kasTable tbody"); tbody.innerHTML="";
  db.collection("kas").orderBy("waktu","desc").get().then(snap=>{
    snap.forEach(d=>{
      const k=d.data(), tr=document.createElement("tr");
      tr.innerHTML=`<td>${fmtDate(tsToDate(k.waktu))}</td><td>${k.tipe}</td><td>Rp ${fmtRupiah(k.jumlah)}</td><td>${k.keterangan||"-"}</td>
      <td><button class="btn-ghost" onclick="deleteDoc('kas','${d.id}',loadKasTable)">Hapus</button></td>`;
      tbody.appendChild(tr);
    });
  });
}

/* ========= Teknisi ========= */
let editTeknisiId=null;
function resetTeknisi(){ editTeknisiId=null; $("#t_nama").value=""; $("#t_telp").value=""; $("#t_standby").value="true"; loadTeknisiTable(); }
function saveTeknisi(){
  const data={nama:$("#t_nama").value.trim(), telp:$("#t_telp").value.trim(), standby:$("#t_standby").value==="true"};
  if(!data.nama){alert("Nama teknisi wajib");return}
  if(editTeknisiId){ db.collection("teknisi").doc(editTeknisiId).set(data,{merge:true}).then(resetTeknisi); }
  else{ db.collection("teknisi").add(data).then(resetTeknisi); }
}
function loadTeknisiTable(){
  const tbody=$("#teknisiTable tbody"); tbody.innerHTML="";
  db.collection("teknisi").orderBy("nama","asc").get().then(snap=>{
    snap.forEach(d=>{
      const t=d.data(), id=d.id;
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${t.nama}</td><td>${t.telp||"-"}</td><td>${t.standby?"Standby":"Off"}</td>
      <td class="row"><button class="btn" onclick="editTeknisi('${id}')">Edit</button><button class="btn-bad" onclick="deleteDoc('teknisi','${id}',loadTeknisiTable)">Hapus</button></td>`;
      tbody.appendChild(tr);
    });
  });
}
function editTeknisi(id){ db.collection("teknisi").doc(id).get().then(doc=>{ const t=doc.data(); editTeknisiId=id; $("#t_nama").value=t.nama||""; $("#t_telp").value=t.telp||""; $("#t_standby").value=String(!!t.standby); showSection('teknisi') })}

/* ========= Gangguan (Order teknisi + progres) ========= */
let progUnsub=null, orderGangguanId=null;
function refreshGangguan(){ loadGangguan(); }
function loadGangguan(){
  const tbody=$("#gangguanTable tbody"); tbody.innerHTML="";
  db.collection("gangguan").orderBy("waktu","desc").get().then(snap=>{
    snap.forEach(d=>{
      const g=d.data(), id=d.id;
      const aksi = (g.status==="menunggu")
        ? `<button class="btn" onclick="openOrder('${id}')">Order</button>`
        : (g.status==="progres" ? `<span class="pill warn">progres</span>` : `<span class="pill ok">selesai</span>`);
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${g.user||"-"}</td><td>${g.indikasi||"-"}</td><td>${g.teknisi||"-"}</td><td>${g.status||"-"}</td>
        <td class="row">
          ${aksi}
          <button class="btn" onclick="showProgressRealtime('${id}')">Progres</button>
          <button class="btn-ghost" onclick="markSelesai('${id}')">Selesai</button>
          <button class="btn-bad" onclick="deleteDoc('gangguan','${id}',loadGangguan)">Hapus</button>
        </td>`;
      tbody.appendChild(tr);
    });
  });
}
function markSelesai(id){
  const now=firebase.firestore.FieldValue.serverTimestamp();
  db.collection("gangguan").doc(id).update({status:"selesai", selesai: now, progres:100}).then(()=>{loadGangguan(); updateCards();});
}
function showProgressRealtime(gangguanId){
  if(progUnsub) {progUnsub(); progUnsub=null}
  progUnsub = db.collection("gangguan").doc(gangguanId).onSnapshot(doc=>{
    const data=doc.data()||{}; const p = Number(data.progres||0);
    const bar=$("#progressBar"); const label=$("#progressLabel");
    bar.style.width = Math.max(0,Math.min(100,p))+"%";
    label.innerText = (Math.max(0,Math.min(100,p)))+"%";
  });
}
/* Order teknisi */
function openOrder(gangguanId){
  orderGangguanId=gangguanId;
  $("#orderModal").style.display="flex";
  const tbody=$("#orderTeknisiTable tbody"); tbody.innerHTML="";
  db.collection("teknisi").where("standby","==",true).orderBy("nama","asc").get().then(snap=>{
    if(snap.empty){ const tr=document.createElement("tr"); tr.innerHTML=`<td colspan="3">Tidak ada teknisi standby.</td>`; tbody.appendChild(tr); return }
    snap.forEach(d=>{
      const t=d.data(); const tr=document.createElement("tr");
      tr.innerHTML=`<td>${t.nama}</td><td>${t.telp||"-"}</td><td><button class="btn" onclick="assignTeknisi('${orderGangguanId}','${t.nama}')">Pilih</button></td>`;
      tbody.appendChild(tr);
    });
  });
}
function closeOrder(){ $("#orderModal").style.display="none"; orderGangguanId=null; }
function assignTeknisi(gangguanId, namaTeknisi){
  db.collection("gangguan").doc(gangguanId).update({teknisi:namaTeknisi, status:"progres"}).then(()=>{ closeOrder(); loadGangguan(); updateCards(); });
}

/* ========= Material ========= */
let editMaterialId=null;
function resetMaterial(){ editMaterialId=null; $("#m_nama").value=""; $("#m_stok").value=""; $("#m_satuan").value=""; loadMaterialTable(); }
function saveMaterial(){
  const data={nama:$("#m_nama").value.trim(), stok:Number($("#m_stok").value||0), satuan:$("#m_satuan").value.trim()};
  if(!data.nama){alert("Nama material wajib");return}
  if(editMaterialId){ db.collection("material").doc(editMaterialId).set(data,{merge:true}).then(resetMaterial); }
  else{ db.collection("material").add(data).then(resetMaterial); }
}
function loadMaterialTable(){
  const tbody=$("#materialTable tbody"); tbody.innerHTML="";
  db.collection("material").orderBy("nama","asc").get().then(snap=>{
    snap.forEach(d=>{
      const m=d.data(), id=d.id;
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${m.nama}</td><td>${m.stok}</td><td>${m.satuan||"-"}</td>
      <td class="row"><button class="btn" onclick="editMaterial('${id}')">Edit</button><button class="btn-bad" onclick="deleteDoc('material','${id}',loadMaterialTable)">Hapus</button></td>`;
      tbody.appendChild(tr);
    });
  });
}
function editMaterial(id){ db.collection("material").doc(id).get().then(doc=>{ const m=doc.data(); editMaterialId=id; $("#m_nama").value=m.nama||""; $("#m_stok").value=m.stok||0; $("#m_satuan").value=m.satuan||""; showSection('material') })}

/* ========= Laporan ========= */
function fillLaporanUserSelect(){
  const sel=$("#lapUserSelect"); sel.innerHTML="";
  db.collection("user").orderBy("namaLengkap","asc").get().then(snap=>{
    snap.forEach(d=>{ const u=d.data(); const opt=document.createElement("option"); opt.value=u.userName; opt.textContent=`${u.namaLengkap} (${u.userName})`; sel.appendChild(opt); });
  });
}
function loadLaporan(){
  const user=$("#lapUserSelect").value; if(!user){alert("Pilih user");return}
  db.collection("billing").where("user","==",user).orderBy("waktu","desc").get().then(snap=>{
    let unpaid=0,sum=0; const tbody=$("#lapBillingTable tbody"); tbody.innerHTML="";
    snap.forEach(d=>{ const b=d.data(); if(b.status==="unpaid"){unpaid++; sum+=Number(b.jumlah||0)} const tr=document.createElement("tr"); tr.innerHTML=`<td>${fmtDate(tsToDate(b.waktu))}</td><td>Rp ${fmtRupiah(b.jumlah)}</td><td>${b.status}</td>`; tbody.appendChild(tr); });
    $("#lapUnpaid").innerText=unpaid; $("#lapUnpaidSum").innerText="Rp "+fmtRupiah(sum);
  });
  db.collection("gangguan").where("user","==",user).orderBy("waktu","desc").get().then(snap=>{
    const tbody=$("#lapGangTable tbody"); tbody.innerHTML=""; let totalTTR=0,cnt=0;
    snap.forEach(d=>{ const g=d.data(); const st=tsToDate(g.waktu), en=g.selesai?tsToDate(g.selesai):null; const ttr=en?(en-st):null; if(ttr!=null){totalTTR+=ttr;cnt++}
      const tr=document.createElement("tr"); tr.innerHTML=`<td>${fmtDate(st)}</td><td>${fmtDate(en)}</td><td>${ttr==null?"‚Äî":durStr(ttr)}</td><td>${g.status||"-"}</td>`; tbody.appendChild(tr); });
    $("#lapGangCount").innerText=snap.size; $("#lapAvgTTR").innerText=cnt?durStr(Math.round(totalTTR/cnt)):"-";
  });
}

/* ========= Edit ISP ========= */
function editISP(){
  const name=$("#newISPName").value.trim(); if(name) $("#ispName").innerText=name;
  const f=$("#ispLogo").files[0];
  if(f){
    const reader=new FileReader();
    reader.onload=e=>{ const img=$("#brandLogo"); img.src=e.target.result; img.style.display="block"; $("#logoPreview").innerHTML=`<img src="${e.target.result}" style="height:56px;border-radius:10px">`;}
    reader.readAsDataURL(f);
  }
}
function clearLogo(){ $("#brandLogo").src=""; $("#brandLogo").style.display="none"; $("#logoPreview").innerHTML="Belum ada logo." }

/* ========= Generic ========= */
function deleteDoc(col,id,cb){ if(!confirm("Yakin hapus data ini?"))return; db.collection(col).doc(id).delete().then(()=>{ if(typeof cb==="function") cb(); updateCards(); }); }

/* ========= Bootstrap ========= */
document.addEventListener("DOMContentLoaded",()=>{
  showSection("dashboard");
  initChart(); loadChartRealtime();
  updateCards(); loadDashboardGangguan();
  // load semua tabel
  loadUserTable(); loadODPTable(); loadPaketTable(); loadBillingTable(); initBillingFilters(); loadKasTable(); loadTeknisiTable(); loadGangguan(); loadMaterialTable(); fillLaporanUserSelect();
});
</script>
</body>
</html>
