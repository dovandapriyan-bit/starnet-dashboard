<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Starnet💫 Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 flex">

  <!-- SIDEBAR -->
  <div id="sidebar" class="bg-gray-900 text-white w-64 min-h-screen transition-all duration-300">
    <div class="p-4 flex items-center justify-between">
      <h1 id="ispName" class="text-xl font-bold">Starnet💫</h1>
      <button onclick="toggleSidebar()" class="text-white">☰</button>
    </div>
    <ul class="mt-6 space-y-2 px-2">
      <li><button onclick="showPage('dashboard')" class="w-full text-left hover:bg-gray-700 p-2 rounded">📊 Dashboard</button></li>
      <li><button onclick="showPage('users')" class="w-full text-left hover:bg-gray-700 p-2 rounded">👥 User</button></li>
      <li><button onclick="showPage('packages')" class="w-full text-left hover:bg-gray-700 p-2 rounded">📦 Paket</button></li>
      <li><button onclick="showPage('billing')" class="w-full text-left hover:bg-gray-700 p-2 rounded">💳 Billing</button></li>
      <li><button onclick="showPage('kas')" class="w-full text-left hover:bg-gray-700 p-2 rounded">💰 Kas Perusahaan</button></li>
      <li><button onclick="showPage('troubles')" class="w-full text-left hover:bg-gray-700 p-2 rounded">🚨 Gangguan</button></li>
      <li><button onclick="showPage('technicians')" class="w-full text-left hover:bg-gray-700 p-2 rounded">🛠️ Teknisi</button></li>
      <li><button onclick="showPage('materials')" class="w-full text-left hover:bg-gray-700 p-2 rounded">📑 Material</button></li>
      <li><button onclick="showPage('settings')" class="w-full text-left hover:bg-gray-700 p-2 rounded">⚙️ Settings</button></li>
    </ul>
  </div>

  <!-- MAIN CONTENT -->
  <div class="flex-1 p-6" id="content">
    <!-- Dashboard -->
    <div id="page-dashboard" class="page">
      <h2 class="text-2xl font-bold mb-4">📊 Dashboard</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-white p-4 rounded shadow">👥 User Aktif: <span id="userCount">0</span></div>
        <div class="bg-white p-4 rounded shadow">💳 Tunggakan: Rp <span id="unpaid">0</span></div>
        <div class="bg-white p-4 rounded shadow">💰 Kas: Rp <span id="kasBalance">0</span></div>
      </div>
      <canvas id="trafficChart" class="mt-6"></canvas>
    </div>

    <!-- Users -->
    <div id="page-users" class="page hidden">
      <h2 class="text-2xl font-bold mb-4">👥 Manajemen User</h2>
      <form id="addUserForm" class="bg-white p-4 rounded shadow mb-4">
        <input id="name" class="border p-2 mr-2" placeholder="Nama">
        <input id="username" class="border p-2 mr-2" placeholder="Username">
        <input id="contact" class="border p-2 mr-2" placeholder="Kontak">
        <select id="planName" class="border p-2"></select>
        <button class="bg-blue-600 text-white px-4 py-2 rounded">Tambah</button>
      </form>
      <table class="w-full bg-white shadow rounded" id="userTable">
        <thead><tr class="bg-gray-200"><th>Nama</th><th>Username</th><th>Paket</th><th>Kontak</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Packages -->
    <div id="page-packages" class="page hidden">
      <h2 class="text-2xl font-bold mb-4">📦 Paket Internet</h2>
      <form id="addPackageForm" class="bg-white p-4 rounded shadow mb-4">
        <input id="pkgName" class="border p-2 mr-2" placeholder="Nama Paket">
        <input id="pkgPrice" class="border p-2 mr-2" placeholder="Harga">
        <button class="bg-green-600 text-white px-4 py-2 rounded">Tambah Paket</button>
      </form>
      <ul id="packageList" class="bg-white p-4 rounded shadow"></ul>
    </div>

    <!-- Kas -->
    <div id="page-kas" class="page hidden">
      <h2 class="text-2xl font-bold mb-4">💰 Kas Perusahaan</h2>
      <form id="kasForm" class="bg-white p-4 rounded shadow mb-4">
        <input id="kasDesc" class="border p-2 mr-2" placeholder="Deskripsi">
        <input id="kasAmount" class="border p-2 mr-2" placeholder="Jumlah">
        <button class="bg-purple-600 text-white px-4 py-2 rounded">Tambah Transaksi</button>
      </form>
      <ul id="kasList" class="bg-white p-4 rounded shadow"></ul>
    </div>

    <!-- Gangguan -->
    <div id="page-troubles" class="page hidden">
      <h2 class="text-2xl font-bold mb-4">🚨 Data Gangguan</h2>
      <ul id="troubleList" class="bg-white p-4 rounded shadow"></ul>
    </div>

    <!-- Settings -->
    <div id="page-settings" class="page hidden">
      <h2 class="text-2xl font-bold mb-4">⚙️ Pengaturan</h2>
      <form id="ispForm" class="bg-white p-4 rounded shadow">
        <input id="ispInput" class="border p-2 mr-2" placeholder="Nama ISP">
        <button class="bg-blue-600 text-white px-4 py-2 rounded">Update Nama ISP</button>
      </form>
    </div>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB-iBpZNC0YZBTAUzir7gJuU9kBQg82moc",
      authDomain: "dnt-network-7.firebaseapp.com",
      projectId: "dnt-network-7",
      storageBucket: "dnt-network-7.firebasestorage.app",
      messagingSenderId: "761179668371",
      appId: "1:761179668371:web:7d1468d0298041d4783266",
      measurementId: "G-CD3EQ350R4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // PAGE HANDLER
    function showPage(id) {
      document.querySelectorAll(".page").forEach(p => p.classList.add("hidden"));
      document.getElementById("page-" + id).classList.remove("hidden");
    }
    window.showPage = showPage;

    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("w-20");
    }
    window.toggleSidebar = toggleSidebar;

    // === CRUD USER ===
    const userTable = document.querySelector("#userTable tbody");
    document.getElementById("addUserForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        name: name.value,
        username: username.value,
        contact: contact.value,
        planName: planName.value,
        startDate: new Date().toISOString().split("T")[0],
        enabled: true
      };
      await addDoc(collection(db, "customers"), data);
      e.target.reset();
    });
    onSnapshot(collection(db, "customers"), snap => {
      userTable.innerHTML = "";
      document.getElementById("userCount").textContent = snap.size;
      snap.forEach(doc => {
        const u = doc.data();
        userTable.innerHTML += `<tr><td>${u.name}</td><td>${u.username}</td><td>${u.planName}</td><td>${u.contact}</td></tr>`;
      });
    });

    // === CRUD PAKET ===
    const planSelect = document.getElementById("planName");
    document.getElementById("addPackageForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      await addDoc(collection(db, "packages"), {
        name: pkgName.value, price: pkgPrice.value
      });
      e.target.reset();
    });
    onSnapshot(collection(db, "packages"), snap => {
      planSelect.innerHTML = "";
      packageList.innerHTML = "";
      snap.forEach(doc => {
        const p = doc.data();
        planSelect.innerHTML += `<option>${p.name}</option>`;
        packageList.innerHTML += `<li>${p.name} - Rp${p.price}</li>`;
      });
    });

    // === KAS ===
    document.getElementById("kasForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      await addDoc(collection(db, "kas"), {
        desc: kasDesc.value, amount: Number(kasAmount.value)
      });
      e.target.reset();
    });
    onSnapshot(collection(db, "kas"), snap => {
      let total = 0;
      kasList.innerHTML = "";
      snap.forEach(doc => {
        const k = doc.data();
        total += k.amount;
        kasList.innerHTML += `<li>${k.desc}: Rp${k.amount}</li>`;
      });
      document.getElementById("kasBalance").textContent = total;
    });

    // === ISP NAME ===
    document.getElementById("ispForm").addEventListener("submit", (e) => {
      e.preventDefault();
      document.getElementById("ispName").textContent = ispInput.value;
    });

    // === GANGGUAN AUTO ===
    async function checkTrouble() {
      const snap = await getDocs(collection(db, "customers"));
      snap.forEach(async doc => {
        const u = doc.data();
        // simulasi: random offline
        if (Math.random() < 0.2) {
          await addDoc(collection(db, "troubles"), {
            name: u.name, username: u.username, status: "offline", time: new Date().toISOString()
          });
        }
      });
    }
    setInterval(checkTrouble, 60000); // tiap 1 menit

    onSnapshot(collection(db, "troubles"), snap => {
      troubleList.innerHTML = "";
      snap.forEach(doc => {
        const t = doc.data();
        troubleList.innerHTML += `<li>${t.username} - ${t.status} (${t.time})</li>`;
      });
    });

    // === GRAFIK ISP (Dummy) ===
    const ctx = document.getElementById("trafficChart");
    new Chart(ctx, {
      type: "line",
      data: {
        labels: ["00:00","06:00","12:00","18:00","24:00"],
        datasets: [
          { label: "Upload", data: [5,10,6,8,4], borderColor: "blue" },
          { label: "Download", data: [15,20,18,25,10], borderColor: "green" }
        ]
      }
    });
  </script>
</body>
</html>
