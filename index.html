<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Starnet ‚Äî Full Final (All Menus + Settings Sidebar + Struk)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
:root{
  --bg:#f4f7fb; --card:#fff; --primary:#0b63d6; --muted:#6b7280;
  --shadow:0 12px 40px rgba(11,30,80,0.08);
}
*{box-sizing:border-box}
body{font-family:Inter, system-ui, Roboto, Arial; background:var(--bg); margin:0;color:#0b1220}
.container-app{max-width:1200px;margin:18px auto;padding:12px}
.header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--primary),#06b6d4);display:grid;place-items:center;color:#fff;font-weight:700}
.title{font-weight:800;font-size:18px}
.small-muted{color:var(--muted);font-size:13px}
.top-actions{margin-left:auto;display:flex;gap:8px;align-items:center}

/* main layout */
.main-card{background:var(--card);border-radius:12px;padding:12px;box-shadow:var(--shadow);}

/* sidebar settings */
.settings-panel{position:fixed;left:50%;top:60px;transform:translateX(-50%);width:95%;max-width:1100px;max-height:85vh;overflow:hidden;border-radius:12px;z-index:12000;display:none}
.settings-inner{display:flex;height:100%}
.settings-sidebar{width:240px;background:#f8fafc;border-right:1px solid #e6eef9;padding:12px;overflow:auto}
.settings-sidebar button{display:block;width:100%;text-align:left;border:none;background:none;padding:10px;border-radius:8px;color:#0b1220;margin-bottom:6px}
.settings-sidebar button.active{background:var(--primary);color:#fff}
.settings-body{flex:1;padding:16px;overflow:auto;background:#fff}

/* responsive modal modern */
.modal-modern{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:92%;max-width:880px;max-height:90vh;overflow:auto;z-index:13000;border-radius:12px;display:none}
.modal-modern .content{background:#fff;border-radius:12px;padding:14px;box-shadow:0 20px 50px rgba(11,30,80,0.12)}
.preview-struk{font-family:monospace;white-space:pre-wrap;background:#fff;padding:14px;border-radius:10px;border:1px solid #eef2ff}

/* table small tweaks */
.table-sm td, .table-sm th{vertical-align:middle}

/* responsive */
@media(max-width:800px){
  .settings-panel{left:50%;top:40px;transform:translateX(-50%);width:96%}
  .settings-sidebar{width:100%;display:flex;overflow-x:auto;gap:6px}
  .settings-sidebar button{flex:1;text-align:center}
  .header{flex-direction:column;align-items:flex-start}
}
</style>
</head>
<body>
<div class="container-app">
  <div class="header">
    <div class="brand"><div class="logo" id="logoBadge">SN</div>
      <div>
        <div class="title" id="ispTitle">Starnet üí´</div>
        <div class="small-muted" id="ispSub">ISP Management System</div>
      </div>
    </div>
    <div class="top-actions">
      <button class="btn btn-outline-secondary" id="btnReset">Reset DB</button>
      <button class="btn btn-outline-primary" onclick="openSNSettings()">‚öôÔ∏è Pengaturan</button>
      <button class="btn btn-success" onclick="openBulkSend()">üöÄ Kirim Semua Invoice (Sim)</button>
    </div>
  </div>

  <div class="main-card">
    <ul class="nav nav-tabs" id="mainMenu">
      <li class="nav-item"><a class="nav-link active" href="#" data-tab="billing" onclick="switchTab('billing')">Billing</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-tab="pelanggan" onclick="switchTab('pelanggan')">Pelanggan</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-tab="pasang" onclick="switchTab('pasang')">Pasang Baru</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-tab="gangguan" onclick="switchTab('gangguan')">Gangguan</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-tab="kas" onclick="switchTab('kas')">Kas</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-tab="odp" onclick="switchTab('odp')">ODP</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-tab="material" onclick="switchTab('material')">Material</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-tab="paket" onclick="switchTab('paket')">Paket</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-tab="mikrotik" onclick="switchTab('mikrotik')">Mikrotik</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-tab="shared" onclick="switchTab('shared')">Shared</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-tab="history" onclick="switchTab('history')">History</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-tab="feedback" onclick="switchTab('feedback')">Feedback</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-tab="portal" onclick="switchTab('portal')">Portal</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-tab="reports" onclick="switchTab('reports')">Reports</a></li>
      <li class="nav-item"><a class="nav-link" href="#" data-tab="users" onclick="switchTab('users')">Users</a></li>
    </ul>

    <!-- content pages -->
    <div id="pages" style="margin-top:12px">
      <!-- Billing -->
      <section id="page-billing">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <input id="searchBilling" class="form-control" placeholder="Cari pelanggan / no internet" style="max-width:360px">
          <button class="btn btn-light" onclick="loadBilling()">Refresh</button>
          <div style="margin-left:auto;display:flex;gap:8px">
            <button class="btn btn-brand" onclick="openBulkSend()">Kirim Semua (Sim)</button>
            <button class="btn btn-outline-primary" onclick="openSNSettings()">Pengaturan</button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead><tr><th>Nama</th><th>No Internet</th><th>Paket</th><th>Tagihan</th><th>Periode</th><th>Status</th><th>Aksi</th></tr></thead>
            <tbody id="tblBilling"></tbody>
          </table>
        </div>
      </section>

      <!-- Pelanggan -->
      <section id="page-pelanggan" class="d-none">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <input id="searchPelanggan" class="form-control" placeholder="Cari pelanggan..." style="max-width:320px">
          <button class="btn btn-light" onclick="loadPelanggan()">Refresh</button>
          <button class="btn btn-brand" onclick="openAddPelanggan()">Tambah Pelanggan</button>
        </div>
        <div id="pelList" class="row g-3"></div>
      </section>

      <!-- Pasang Baru -->
      <section id="page-pasang" class="d-none">
        <h5>Form Pasang Baru</h5>
        <div style="display:flex;gap:8px;align-items:center" class="mb-3">
          <input id="p_nama" class="form-control" placeholder="Nama pelanggan">
          <input id="p_hp" class="form-control" placeholder="No HP (628...)">
          <select id="p_paket" class="form-control" style="max-width:200px">
            <option value="Paket 10 Mbps">Paket 10 Mbps</option>
            <option value="Paket 20 Mbps">Paket 20 Mbps</option>
          </select>
          <button class="btn btn-brand" onclick="createPasang()">Daftar</button>
        </div>
        <div class="card p-2"><h6>Daftar Pasang</h6><div id="pasangList"></div></div>
      </section>

      <!-- Gangguan -->
      <section id="page-gangguan" class="d-none">
        <h5>Laporkan Gangguan</h5>
        <div style="display:flex;gap:8px;align-items:center" class="mb-3">
          <input id="g_no" class="form-control" placeholder="No Internet" style="max-width:180px">
          <input id="g_name" class="form-control" placeholder="Nama pelapor">
          <input id="g_hp" class="form-control" placeholder="No HP" style="max-width:180px">
          <select id="g_type" class="form-control" style="max-width:200px">
            <option>LOS Merah</option><option>Koneksi Lambat</option><option>Tidak Terhubung</option><option>Lainnya</option>
          </select>
          <button class="btn btn-brand" onclick="createGangguan()">Kirim</button>
        </div>
        <div class="card p-2"><h6>Daftar Gangguan</h6><div id="listGangguan"></div></div>
      </section>

      <!-- Kas -->
      <section id="page-kas" class="d-none">
        <h5>Kas</h5>
        <div id="kasList"></div>
      </section>

      <!-- ODP -->
      <section id="page-odp" class="d-none">
        <h5>ODP</h5>
        <div id="odpList"></div>
      </section>

      <!-- Material -->
      <section id="page-material" class="d-none">
        <h5>Material</h5>
        <div id="materialList"></div>
      </section>

      <!-- Paket -->
      <section id="page-paket" class="d-none">
        <h5>Paket</h5>
        <div id="paketList"></div>
      </section>

      <!-- Mikrotik -->
      <section id="page-mikrotik" class="d-none">
        <h5>Mikrotik</h5>
        <div id="mtList"></div>
      </section>

      <!-- Shared -->
      <section id="page-shared" class="d-none">
        <h5>Shared</h5>
        <div id="sharedList"></div>
      </section>

      <!-- History -->
      <section id="page-history" class="d-none">
        <h5>History</h5>
        <div id="historyList"></div>
      </section>

      <!-- Feedback -->
      <section id="page-feedback" class="d-none">
        <h5>Feedback</h5>
        <div id="feedbackList"></div>
      </section>

      <!-- Portal -->
      <section id="page-portal" class="d-none">
        <h5>Portal</h5>
        <div id="portalList"></div>
      </section>

      <!-- Reports -->
      <section id="page-reports" class="d-none">
        <h5>Reports</h5>
        <div id="reportsList"></div>
      </section>

      <!-- Users -->
      <section id="page-users" class="d-none">
        <h5>Users</h5>
        <div id="usersList"></div>
      </section>

    </div>
  </div>
</div>

<!-- Settings Panel & Injection (START) -->
<style>
/* Responsive modal & settings styles (injection) */
._sn_modal { position: fixed; left:50%; top:50%; transform:translate(-50%,-50%); width:92%; max-width:820px; max-height:90vh; overflow:auto; z-index:15000; border-radius:12px; display:none; }
._sn_modal ._sn_modal_inner{ background:#fff; padding:14px; border-radius:12px; box-shadow:0 20px 60px rgba(11,30,80,0.12); }
._sn_backdrop{ position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(2,6,23,0.45);z-index:14999;display:none; }
._sn_settings_panel{ position:fixed; left:50%; top:48px; transform:translateX(-50%); width:95%; max-width:1100px; max-height:86vh; border-radius:12px; z-index:15100; display:none; box-shadow:0 20px 50px rgba(11,30,80,0.12); background:#fff; overflow:hidden; }
._sn_settings_inner{ display:flex; height:100%; }
._sn_settings_menu{ width:240px; background:#f8fafc; padding:12px; border-right:1px solid #e6eef9; overflow:auto; }
._sn_settings_menu button{ display:block; width:100%; text-align:left; padding:10px; border-radius:8px; border:none; background:none; margin-bottom:6px; color:#0b1220; }
._sn_settings_menu button.active{ background:#0b63d6; color:#fff; }
._sn_settings_body{ flex:1; padding:14px; overflow:auto; }
@media(max-width:720px){ ._sn_settings_inner{ flex-direction:column } ._sn_settings_menu{ width:100%; display:flex; gap:6px; overflow-x:auto } ._sn_settings_menu button{ flex:1; text-align:center } }
</style>

<div id="_sn_backdrop" class="_sn_backdrop" onclick="snCloseAll()"></div>

<div id="_sn_settings_panel" class="_sn_settings_panel" aria-hidden="true">
  <div class="_sn_settings_inner">
    <div class="_sn_settings_menu" role="navigation" aria-label="Pengaturan">
      <button id="_sn_tab_profile" class="active" onclick="snShowTab('profile')">Profile ISP</button>
      <button id="_sn_tab_wa" onclick="snShowTab('wa')">API WhatsApp</button>
      <button id="_sn_tab_tg" onclick="snShowTab('tg')">API Telegram</button>
      <button id="_sn_tab_mk" onclick="snShowTab('mikrotik')">Mikrotik</button>
      <button id="_sn_tab_struk" onclick="snShowTab('struk')">Customize Struk</button>
      <button id="_sn_tab_billing" onclick="snShowTab('billing')">Billing</button>
      <div style="margin-top:12px"><button class="btn btn-sm btn-outline-secondary" onclick="snCloseAll()">Tutup</button></div>
    </div>

    <div class="_sn_settings_body">
      <!-- PROFILE -->
      <div id="_sn_panel_profile">
        <h5>Profile ISP</h5>
        <div class="mb-2 small-muted">Logo (URL), Nama, Alamat, Kontak</div>
        <input id="_sn_profile_logo" class="form-control mb-2" placeholder="https://.../logo.png">
        <input id="_sn_profile_name" class="form-control mb-2" placeholder="Nama ISP">
        <input id="_sn_profile_address" class="form-control mb-2" placeholder="Alamat">
        <div style="display:flex;gap:8px">
          <input id="_sn_profile_hp" class="form-control mb-2" placeholder="No HP (WhatsApp)">
          <input id="_sn_profile_telp" class="form-control mb-2" placeholder="Telp kantor">
          <input id="_sn_profile_email" class="form-control mb-2" placeholder="Email">
        </div>
        <div style="margin-top:10px"><button class="btn btn-primary" onclick="snSaveSettings()">Simpan Profile</button></div>
      </div>

      <!-- WA -->
      <div id="_sn_panel_wa" style="display:none">
        <h5>API WhatsApp</h5>
        <div class="small-muted mb-2">Cloud API: masukkan Access Token & Phone Number ID. Gateway: QR/Baileys (termux) - mode simulasi tersedia.</div>
        <input id="_sn_wa_token" class="form-control mb-2" placeholder="ACCESS_TOKEN">
        <input id="_sn_wa_phoneid" class="form-control mb-2" placeholder="PHONE_NUMBER_ID">
        <select id="_sn_wa_mode" class="form-control mb-2"><option value="cloud">Cloud API</option><option value="gateway">Gateway (QR/Baileys)</option><option value="none">Nonaktif</option></select>
        <div style="margin-top:10px"><button class="btn btn-primary" onclick="snSaveSettings()">Simpan WA</button></div>
      </div>

      <!-- Telegram -->
      <div id="_sn_panel_tg" style="display:none">
        <h5>API Telegram</h5>
        <input id="_sn_tg_token" class="form-control mb-2" placeholder="Bot Token (BotFather)">
        <input id="_sn_tg_chat" class="form-control mb-2" placeholder="Chat ID / Channel ID">
        <div style="margin-top:10px"><button class="btn btn-primary" onclick="snSaveSettings()">Simpan Telegram</button></div>
      </div>

      <!-- Mikrotik -->
      <div id="_sn_panel_mikrotik" style="display:none">
        <h5>Mikrotik</h5>
        <input id="_sn_mk_ip" class="form-control mb-2" placeholder="IP Router">
        <div style="display:flex;gap:8px">
          <input id="_sn_mk_user" class="form-control mb-2" placeholder="User">
          <input id="_sn_mk_pass" class="form-control mb-2" placeholder="Pass">
        </div>
        <div style="margin-top:10px"><button class="btn btn-primary" onclick="snSaveSettings()">Simpan Mikrotik</button></div>
      </div>

      <!-- Struk -->
      <div id="_sn_panel_struk" style="display:none">
        <h5>Customize Struk</h5>
        <div class="small-muted mb-2">Klik contoh tampilan untuk memilih template. Edit template di textarea (gunakan: {{isp_name}}, {{logo}}, {{nama}}, {{no_inet}}, {{paket}}, {{jumlah}}, {{periode}}, {{tanggal}} )</div>
        <div class="row mb-2">
          <div class="col-4"><img src="https://via.placeholder.com/320x200?text=Default" class="img-fluid mb-1" onclick="snSetTheme('default')"></div>
          <div class="col-4"><img src="https://via.placeholder.com/320x200?text=Kwitansi" class="img-fluid mb-1" onclick="snSetTheme('kwitansi')"></div>
          <div class="col-4"><img src="https://via.placeholder.com/320x200?text=Minimalis" class="img-fluid mb-1" onclick="snSetTheme('minimal')"></div>
        </div>
        <select id="_sn_struk_theme" class="form-control mb-2"><option value="default">Default</option><option value="kwitansi">Kwitansi</option><option value="minimal">Minimal</option></select>
        <textarea id="_sn_struk_template" rows="8" class="form-control mb-2"></textarea>
        <div style="display:flex;gap:8px"><button class="btn btn-primary" onclick="snSaveSettings()">Simpan Template</button><button class="btn btn-outline-secondary" onclick="snResetTemplate()">Reset</button></div>
      </div>

      <!-- Billing -->
      <div id="_sn_panel_billing" style="display:none">
        <h5>Billing</h5>
        <div class="small-muted mb-2">Mode transaksi default</div>
        <select id="_sn_billing_mode" class="form-control mb-2"><option value="prabayar">Prabayar</option><option value="pascabayar">Pascabayar</option></select>
        <div style="margin-top:10px"><button class="btn btn-primary" onclick="snSaveSettings()">Simpan Billing</button></div>
      </div>
    </div>
  </div>
</div>
<!-- Settings Panel & Injection (END) -->

<!-- Modals (global) -->
<div id="_sn_struk_modal" class="_sn_modal" aria-hidden="true">
  <div class="_sn_modal_inner">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><h5>Preview Struk</h5><div class="small-muted">Periksa sebelum cetak / kirim</div></div>
      <div style="display:flex;gap:8px"><button class="btn btn-light" onclick="snDownloadPDF()">üì• Download PDF</button><button class="btn btn-outline-secondary" onclick="snHideModal('_sn_struk_modal')">Tutup</button></div>
    </div>
    <div style="margin-top:12px"><div id="_sn_struk_preview" class="preview-struk"></div></div>
  </div>
</div>

<div id="_sn_pay_modal" class="_sn_modal" aria-hidden="true">
  <div class="_sn_modal_inner">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><h5>Bayar Tagihan (Pilihan Periode)</h5><div class="small-muted">Pilih tanggal mulai & akhir untuk periode pemakaian</div></div>
      <div><button class="btn btn-outline-secondary" onclick="snHideModal('_sn_pay_modal')">Tutup</button></div>
    </div>
    <div style="margin-top:10px">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <div style="flex:1"><label>Tgl Mulai</label><input id="_sn_pay_start" type="date" class="form-control"></div>
        <div style="flex:1"><label>Tgl Akhir</label><input id="_sn_pay_end" type="date" class="form-control"></div>
        <div style="width:200px"><label>Jumlah (Rp)</label><input id="_sn_pay_amount" class="form-control" readonly></div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn btn-outline-secondary" onclick="snHideModal('_sn_pay_modal')">Batal</button>
        <button class="btn btn-primary" onclick="snConfirmPay()">Konfirmasi & Cetak</button>
      </div>
    </div>
  </div>
</div>

<!-- html2pdf -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
/* =========================
   Core app + injection glue
   ========================= */

/* Local DB key and initial DB */
const LS_KEY = 'starnet_final_injected_v1';
let DB = JSON.parse(localStorage.getItem(LS_KEY) || 'null');
if(!DB){
  DB = {};
  // if original stored under other key, try to load it first (best-effort)
  const possible = ['starnet_final_v1','starnet_full_v2','starnet_final','starnet_v1','starnet'];
  for(const k of possible){
    try{
      const raw = localStorage.getItem(k);
      if(raw){ DB = JSON.parse(raw); window._originalLS = k; break; }
    }catch(e){}
  }
  // If still empty, create minimal structure
  if(!DB.pelanggan) DB.pelanggan = [];
  if(!DB.billing) DB.billing = {};
  if(!DB.settings) DB.settings = { profile:{ isp_name:'Starnet üí´', logo:'', address:'', hp:'', telp:'', email:'' }, wa:{ mode:'none', token:'', phoneid:'' }, telegram:{ token:'', chatid:'' }, mikrotik:{ ip:'', user:'', pass:'' }, struk:{ theme:'default', template:'' }, billing:{ mode:'prabayar' } };
  localStorage.setItem(LS_KEY, JSON.stringify(DB));
}

/* Render header from settings */
function renderHeader(){
  try{
    const p = DB.settings.profile || {};
    document.getElementById('ispTitle').innerText = p.isp_name || 'Starnet üí´';
    document.getElementById('ispSub').innerText = p.address || 'Sistem manajemen ISP';
    const badge = document.getElementById('logoBadge');
    if(p.logo) badge.innerHTML = `<img src="${p.logo}" style="height:40px;object-fit:contain"/>`; else badge.innerText = (p.isp_name||'SN').split(' ').map(s=>s[0]).slice(0,2).join('');
  }catch(e){}
}
renderHeader();

/* helpers */
function generateNoInet(){ const d=new Date(); return String(d.getFullYear()).slice(2)+String(d.getMonth()+1).padStart(2,'0')+Math.floor(Math.random()*9000+1000); }
function paketHarga(p){ return p && p.includes('20') ? 250000 : 150000; }

/* Seed dummy pelanggan only if none exist */
(function seedDummyIfEmpty(){
  try{
    const count = Array.isArray(DB.pelanggan) ? DB.pelanggan.length : Object.keys(DB.pelanggan||{}).length;
    if(count === 0){
      const dummy = ["Andi Saputra","Budi Santoso","Citra Dewi","Dedi Pratama","Eka Wijaya","Fajar Hadi","Gita Lestari","Hadi Pratama","Indra Kurnia","Joko Santoso"];
      for(let i=0;i<10;i++){
        const id = 'C'+(i+1);
        const noInet = generateNoInet() + String(100+i);
        const hp = '+6281336652986';
        const paket = (i%2===0)?'Paket 10 Mbps':'Paket 20 Mbps';
        if(Array.isArray(DB.pelanggan)){
          DB.pelanggan.push({ id, noInet, nama: dummy[i], hp, paket, status:'Belum', created: new Date().toISOString() });
        }else{
          DB.pelanggan[id] = { id, noInet, nama: dummy[i], hp, paket, status:'Belum', created: new Date().toISOString() };
        }
      }
      localStorage.setItem(LS_KEY, JSON.stringify(DB));
    }
  }catch(e){ console.warn('seed failed', e); }
})();

/* Load billing table */
function loadBilling(){
  const tbody = document.getElementById('tblBilling');
  tbody.innerHTML = '';
  const list = Array.isArray(DB.pelanggan) ? DB.pelanggan : Object.values(DB.pelanggan||{});
  list.forEach(p=>{
    const bill = DB.billing && DB.billing[p.id] ? DB.billing[p.id] : { jumlah: paketHarga(p.paket), periode:'-', status:'Belum' };
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.nama}</td><td>${p.noInet}</td><td>${p.paket}</td><td>Rp ${Number(bill.jumlah||0).toLocaleString('id-ID')}</td><td>${bill.periode||'-'}</td><td>${bill.status}</td>
      <td><div style="display:flex;gap:6px"><button class="btn btn-sm btn-success" onclick="openPay('${p.id}')">Bayar</button><button class="btn btn-sm btn-outline-secondary" onclick="previewStrukById('${p.id}')">Preview</button></div></td>`;
    tbody.appendChild(tr);
  });
}

/* load pelanggan cards */
function loadPelanggan(){
  const container = document.getElementById('pelList');
  container.innerHTML = '';
  const list = Array.isArray(DB.pelanggan) ? DB.pelanggan : Object.values(DB.pelanggan||{});
  list.forEach(p=>{
    const col = document.createElement('div'); col.className='col-md-4';
    col.innerHTML = `<div class="card p-2 mb-2"><div style="display:flex;align-items:center;gap:8px"><div style="width:46px;height:46px;border-radius:8px;background:#eef2ff;display:grid;place-items:center">${(p.nama||'')[0]}</div><div style="flex:1"><strong>${p.nama}</strong><div class="small-muted">${p.noInet} ‚Ä¢ ${p.hp}</div></div><div><button class="btn btn-sm btn-outline-primary" onclick="openPay('${p.id}')">Bayar</button></div></div></div>`;
    container.appendChild(col);
  });
}

/* pasang list and gangguan list */
function loadPasangList(){ const el = document.getElementById('pasangList'); el.innerHTML=''; const list = Array.isArray(DB.pelanggan)?DB.pelanggan:Object.values(DB.pelanggan||{}); list.forEach(p=>{ const div=document.createElement('div'); div.className='p-2 border-bottom'; div.innerHTML = `<strong>${p.nama}</strong><div class="small-muted">${p.noInet} ‚Ä¢ ${p.paket}</div>`; el.appendChild(div); }); }
function loadGangguan(){ const el = document.getElementById('listGangguan'); el.innerHTML=''; if(!DB.gangguan) DB.gangguan = {}; Object.values(DB.gangguan).forEach(g=>{ const d=document.createElement('div'); d.className='p-2 border-bottom'; d.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${g.nama}</strong><div class="small-muted">${g.noinet} ‚Ä¢ ${g.jenis}</div></div><div><span class="badge bg-danger">${g.status}</span></div></div>`; el.appendChild(d); }); }

/* switch tab */
function switchTab(tab){
  document.querySelectorAll('#pages section').forEach(s=>s.classList.add('d-none'));
  const el = document.getElementById('page-'+tab);
  if(el) el.classList.remove('d-none');
  document.querySelectorAll('#mainMenu .nav-link').forEach(n=>n.classList.remove('active'));
  document.querySelector(`#mainMenu .nav-link[data-tab="${tab}"]`)?.classList.add('active');
  if(tab==='billing') loadBilling();
  if(tab==='pelanggan') loadPelanggan();
  if(tab==='pasang') loadPasangList();
  if(tab==='gangguan') loadGangguan();
}

/* small CRUD */
function openAddPelanggan(){
  const nama = prompt('Nama pelanggan:'); if(!nama) return;
  const hp = prompt('No HP (contoh 62812...):'); if(!hp) return;
  const id = 'C'+( (Array.isArray(DB.pelanggan)?DB.pelanggan.length:Object.keys(DB.pelanggan||{}).length) + 1 );
  const noInet = generateNoInet();
  const rec = { id, noInet, nama, hp, paket:'Paket 10 Mbps', status:'Belum', created: new Date().toISOString() };
  if(Array.isArray(DB.pelanggan)) DB.pelanggan.push(rec); else DB.pelanggan[id] = rec;
  localStorage.setItem(LS_KEY, JSON.stringify(DB));
  loadPelanggan(); loadBilling();
}

/* create pasang & gangguan */
function createPasang(){
  const nama = document.getElementById('p_nama').value.trim();
  const hp = document.getElementById('p_hp').value.trim();
  const paket = document.getElementById('p_paket').value;
  if(!nama||!hp){ alert('Nama & HP harus diisi'); return; }
  const id = 'C' + (Array.isArray(DB.pelanggan)?DB.pelanggan.length+1:Object.keys(DB.pelanggan||{}).length+1);
  const rec = { id, noInet: generateNoInet(), nama, hp, paket, status:'Belum', created: new Date().toISOString() };
  if(Array.isArray(DB.pelanggan)) DB.pelanggan.push(rec); else DB.pelanggan[id]=rec;
  localStorage.setItem(LS_KEY, JSON.stringify(DB));
  document.getElementById('p_nama').value=''; document.getElementById('p_hp').value='';
  loadPasangList(); loadBilling(); loadPelanggan();
}

function createGangguan(){
  const no = document.getElementById('g_no').value.trim();
  const name = document.getElementById('g_name').value.trim();
  const hp = document.getElementById('g_hp').value.trim();
  const jenis = document.getElementById('g_type').value;
  if(!no||!name){ alert('No Internet & Nama pelapor harus diisi'); return; }
  if(!DB.gangguan) DB.gangguan = {};
  const id = 'G' + (Object.keys(DB.gangguan).length + 1);
  DB.gangguan[id] = { id, noinet:no, nama:name, hp, jenis, status:'Open', created: new Date().toISOString() };
  localStorage.setItem(LS_KEY, JSON.stringify(DB));
  loadGangguan();
}

/* reset DB button */
document.getElementById('btnReset').addEventListener('click', ()=>{ if(confirm('Reset semua data ke default?')){ localStorage.removeItem(LS_KEY); location.reload(); } });

/* Bulk send (sim) */
function openBulkSend(){
  if(!confirm('Kirim invoice ke semua pelanggan (simulasi)? Pastikan token WA terisi di Pengaturan jika ingin real-send.')) return;
  const list = Array.isArray(DB.pelanggan)?DB.pelanggan:Object.values(DB.pelanggan||{});
  list.forEach((p,i)=>{
    setTimeout(()=>{ console.log('Sim send invoice to', p.hp, ' (id=',p.id,')'); }, i*900);
  });
  alert('Simulasi pengiriman dijalankan (cek console).');
}

/* =========================
   INJECTION FUNCTIONS
   - snOpenSettings, snSaveSettings, snPreview, snPay override
   ========================= */

function snOpenSettings(){ document.getElementById('_sn_settings_panel').style.display='block'; document.getElementById('_sn_backdrop').style.display='block'; snLoadSettings(); snShowTab('profile'); window.scrollTo(0,0); }
function snCloseAll(){ document.getElementById('_sn_settings_panel').style.display='none'; document.getElementById('_sn_backdrop').style.display='none'; snHideModal('_sn_struk_modal'); snHideModal('_sn_pay_modal'); }
function snShowTab(tab){
  const tabs = ['profile','wa','tg','mikrotik','struk','billing'];
  tabs.forEach(t=>{
    const panel = document.getElementById('_sn_panel_'+t) || document.getElementById('_sn_panel_'+(t==='mikrotik'?'mikrotik':t));
    if(panel) panel.style.display = 'none';
    const btn = document.getElementById('_sn_tab_'+(t==='mikrotik'?'mk':t));
    if(btn) btn.classList.remove('active');
  });
  const id = (tab==='mikrotik') ? '_sn_panel_mikrotik' : '_sn_panel_'+tab;
  const btnid = (tab==='mikrotik') ? '_sn_tab_mk' : '_sn_tab_'+tab;
  if(document.getElementById(id)) document.getElementById(id).style.display = 'block';
  if(document.getElementById(btnid)) document.getElementById(btnid).classList.add('active');
}

function snLoadSettings(){
  const s = DB.settings || {};
  if(document.getElementById('_sn_profile_logo')) document.getElementById('_sn_profile_logo').value = s.profile.logo || '';
  if(document.getElementById('_sn_profile_name')) document.getElementById('_sn_profile_name').value = s.profile.isp_name || '';
  if(document.getElementById('_sn_profile_address')) document.getElementById('_sn_profile_address').value = s.profile.address || '';
  if(document.getElementById('_sn_profile_hp')) document.getElementById('_sn_profile_hp').value = s.profile.hp || '';
  if(document.getElementById('_sn_profile_telp')) document.getElementById('_sn_profile_telp').value = s.profile.telp || '';
  if(document.getElementById('_sn_profile_email')) document.getElementById('_sn_profile_email').value = s.profile.email || '';
  if(document.getElementById('_sn_wa_token')) document.getElementById('_sn_wa_token').value = s.wa.token || '';
  if(document.getElementById('_sn_wa_phoneid')) document.getElementById('_sn_wa_phoneid').value = s.wa.phoneid || '';
  if(document.getElementById('_sn_wa_mode')) document.getElementById('_sn_wa_mode').value = s.wa.mode || 'none';
  if(document.getElementById('_sn_tg_token')) document.getElementById('_sn_tg_token').value = s.telegram.token || '';
  if(document.getElementById('_sn_tg_chat')) document.getElementById('_sn_tg_chat').value = s.telegram.chatid || '';
  if(document.getElementById('_sn_mk_ip')) document.getElementById('_sn_mk_ip').value = s.mikrotik.ip || '';
  if(document.getElementById('_sn_mk_user')) document.getElementById('_sn_mk_user').value = s.mikrotik.user || '';
  if(document.getElementById('_sn_mk_pass')) document.getElementById('_sn_mk_pass').value = s.mikrotik.pass || '';
  if(document.getElementById('_sn_struk_theme')) document.getElementById('_sn_struk_theme').value = s.struk.theme || 'default';
  if(document.getElementById('_sn_struk_template')) document.getElementById('_sn_struk_template').value = s.struk.template || snDefaultTemplates()[s.struk.theme || 'default'];
  if(document.getElementById('_sn_billing_mode')) document.getElementById('_sn_billing_mode').value = s.billing.mode || 'prabayar';
  try{ renderHeader(); }catch(e){}
}

function snSaveSettings(){
  DB.settings.profile.logo = document.getElementById('_sn_profile_logo').value.trim();
  DB.settings.profile.isp_name = document.getElementById('_sn_profile_name').value.trim();
  DB.settings.profile.address = document.getElementById('_sn_profile_address').value.trim();
  DB.settings.profile.hp = document.getElementById('_sn_profile_hp').value.trim();
  DB.settings.profile.telp = document.getElementById('_sn_profile_telp').value.trim();
  DB.settings.profile.email = document.getElementById('_sn_profile_email').value.trim();
  DB.settings.wa.token = document.getElementById('_sn_wa_token').value.trim();
  DB.settings.wa.phoneid = document.getElementById('_sn_wa_phoneid').value.trim();
  DB.settings.wa.mode = document.getElementById('_sn_wa_mode').value;
  DB.settings.telegram.token = document.getElementById('_sn_tg_token').value.trim();
  DB.settings.telegram.chatid = document.getElementById('_sn_tg_chat').value.trim();
  DB.settings.mikrotik.ip = document.getElementById('_sn_mk_ip').value.trim();
  DB.settings.mikrotik.user = document.getElementById('_sn_mk_user').value.trim();
  DB.settings.mikrotik.pass = document.getElementById('_sn_mk_pass').value.trim();
  DB.settings.struk.theme = document.getElementById('_sn_struk_theme').value;
  DB.settings.struk.template = document.getElementById('_sn_struk_template').value;
  DB.settings.billing.mode = document.getElementById('_sn_billing_mode').value;
  localStorage.setItem(LS_KEY, JSON.stringify(DB));
  snLoadSettings();
  alert('Pengaturan tersimpan.');
  snCloseAll();
}

/* templates */
function snDefaultTemplates(){
  return {
    default: `===== STRUK PEMBAYARAN =====\nISP: {{isp_name}}\nNama: {{nama}}\nNo Internet: {{no_inet}}\nPaket: {{paket}}\nJumlah: Rp {{jumlah}}\nPeriode: {{periode}}\nTanggal: {{tanggal}}\n============================\nTerima kasih.`,
    kwitansi: `<div style="text-align:center"><img src='{{logo}}' style='height:56px'/><h3>{{isp_name}}</h3><div>{{address}}</div><hr/></div>\nNo: {{id}}\nNama: {{nama}}\nPaket: {{paket}}\nJumlah: Rp {{jumlah}}\nPeriode: {{periode}}\nTanggal: {{tanggal}}\n-----------------------\nTerima kasih.`,
    minimal: `{{isp_name}} - STRUK\n{{nama}} | {{paket}} | Rp {{jumlah}}\nPeriode: {{periode}}\nTanggal: {{tanggal}}`
  };
}

function snResetTemplate(){ const t = snDefaultTemplates(); const theme = DB.settings.struk.theme || 'default'; if(document.getElementById('_sn_struk_template')) document.getElementById('_sn_struk_template').value = t[theme]; }
function snSetTheme(n){ if(document.getElementById('_sn_struk_theme')) document.getElementById('_sn_struk_theme').value = n; if(document.getElementById('_sn_struk_template')) document.getElementById('_sn_struk_template').value = snDefaultTemplates()[n]; }

/* modal helpers */
function snShowModal(id){ document.getElementById('_sn_backdrop').style.display='block'; document.getElementById(id).style.display='block'; window.scrollTo(0,0); }
function snHideModal(id){ document.getElementById(id).style.display='none'; document.getElementById('_sn_backdrop').style.display='none'; }

/* Override / augment payment & preview functions */
(function(){
  const origOpenPay = (typeof openPay === 'function') ? openPay : null;
  const origConfirmPay = (typeof confirmPay === 'function') ? confirmPay : null;

  window.openPay = function(id){
    window._sn_pay_target = id;
    let p = null;
    const list = Array.isArray(DB.pelanggan)?DB.pelanggan:Object.values(DB.pelanggan||{});
    p = list.find(x=>x.id===id) || DB.pelanggan[id] || null;
    const amount = p ? (DB.billing && DB.billing[id] ? DB.billing[id].jumlah : paketHarga(p.paket)) : 0;
    if(document.getElementById('_sn_pay_amount')) document.getElementById('_sn_pay_amount').value = amount;
    snShowModal('_sn_pay_modal');
    if(origOpenPay) try{ origOpenPay(id); }catch(e){}
  };

  window.snConfirmPay = function(){
    const start = document.getElementById('_sn_pay_start').value;
    const end = document.getElementById('_sn_pay_end').value;
    if(!start || !end){ alert('Pilih tanggal mulai & akhir periode'); return; }
    const periode = snFormatDate(start)+ ' ‚Äì ' + snFormatDate(end);
    const id = window._sn_pay_target;
    if(!id){ alert('Target tidak ditemukan'); snHideModal('_sn_pay_modal'); return; }
    let pel = null;
    const list = Array.isArray(DB.pelanggan)?DB.pelanggan:Object.values(DB.pelanggan||{});
    pel = list.find(x=>x.id===id) || DB.pelanggan[id] || null;
    const jumlah = Number(document.getElementById('_sn_pay_amount').value) || (pel && pel.paket && pel.paket.includes('20')?250000:150000);
    if(!DB.billing) DB.billing = {};
    DB.billing[id] = { id, nama: pel?pel.nama:'Unknown', noInet: pel?(pel.noInet||pel.noInternet):'', paket: pel?pel.paket:'', jumlah, periode, status:'Lunas', tanggal: new Date().toLocaleString() };
    if(pel && pel.status) pel.status = 'Lunas';
    localStorage.setItem(LS_KEY, JSON.stringify(DB));
    snHideModal('_sn_pay_modal');
    snPreviewStrukById(id);
    if(origConfirmPay) try{ origConfirmPay(); }catch(e){}
  };

  window.snRenderStrukHtml = function(b){
    const s = DB.settings || {};
    const theme = s.struk && s.struk.theme ? s.struk.theme : 'default';
    let tpl = (s.struk && s.struk.template && s.struk.template.trim()) ? s.struk.template : snDefaultTemplates()[theme];
    tpl = tpl.replace(/{{logo}}/g, s.profile.logo || '')
             .replace(/{{isp_name}}/g, s.profile.isp_name || '')
             .replace(/{{address}}/g, s.profile.address || '')
             .replace(/{{nama}}/g, b.nama || '')
             .replace(/{{id}}/g, b.id || b.noInet || '')
             .replace(/{{no_inet}}/g, b.noInet || '')
             .replace(/{{paket}}/g, b.paket || '')
             .replace(/{{jumlah}}/g, (b.jumlah||0))
             .replace(/{{periode}}/g, b.periode || '-')
             .replace(/{{tanggal}}/g, b.tanggal || new Date().toLocaleString());
    if(theme==='kwitansi'){ return tpl; }
    return '<pre style="margin:0;font-family:monospace">'+snEscapeHtml(tpl)+'</pre>';
  };

  window.snPreviewStrukForBilling = function(b){
    document.getElementById('_sn_struk_preview').innerHTML = snRenderStrukHtml(b);
    snShowModal('_sn_struk_modal');
  };
  window.snPreviewStrukById = function(id){
    const b = (DB.billing && DB.billing[id]) ? DB.billing[id] : null;
    if(!b){ alert('Belum ada tagihan/rekaman billing untuk pelanggan ini'); return; }
    snPreviewStrukForBilling(b);
  };

  window.previewStrukById = window.snPreviewStrukById;
  window.previewStrukForBilling = window.snPreviewStrukForBilling;

  window.snDownloadPDF = function(){
    const el = document.getElementById('_sn_struk_preview');
    if(typeof html2pdf !== 'undefined'){
      try{
        const opt = { margin:0.3, filename: (DB.settings && DB.settings.profile && DB.settings.profile.isp_name ? DB.settings.profile.isp_name : 'struk') + '.pdf', html2canvas:{scale:2}, jsPDF:{unit:'in',format:'a5',orientation:'portrait'} };
        html2pdf().set(opt).from(el).save();
        return;
      }catch(e){ console.warn('html2pdf failed', e); }
    }
    const w = window.open('','_blank');
    w.document.write('<html><head><title>Struk</title></head><body>'+el.innerHTML+'</body></html>');
    w.document.close();
    w.print();
  };

  window.snEscapeHtml = function(s){ if(s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); };
  window.snFormatDate = function(d){ const dt=new Date(d); const months=['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des']; return dt.getDate()+' '+months[dt.getMonth()]+' '+dt.getFullYear(); };

})();

/* attach openSNSettings to any Pengaturan buttons present */
(function attachHooks(){
  try{
    const nodes = Array.from(document.querySelectorAll('button,a,div'));
    for(const n of nodes){
      if(n.innerText && n.innerText.trim().toLowerCase().includes('pengaturan')){
        n.onclick = function(e){ e.preventDefault(); snOpenSettings(); };
      }
    }
  }catch(e){}
})();

/* init UI load */
function initAll(){
  renderHeader();
  loadBilling();
  loadPelanggan();
  loadPasangList();
  loadGangguan();
}
initAll();

</script>

</body>
</html>
