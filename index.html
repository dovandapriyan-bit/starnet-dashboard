<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ISP Manager ‚Äî Full Final</title>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  /* --- Visual styles kept clean & consistent with your template --- */
  :root{--blue:#1f3b6f;--accent:#4b6cb7;--muted:#666}
  *{box-sizing:border-box}
  body{font-family:'Segoe UI',sans-serif;margin:0;background:#f0f2f5;color:#222}
  h1,h2{color:var(--blue);margin:0 0 8px 0}
  button{cursor:pointer;border:none;border-radius:6px;padding:6px 12px;transition:0.2s}
  button:active{transform:translateY(1px)}
  input,select,textarea{border-radius:6px;border:1px solid #ccc;padding:8px;outline:none}
  input:focus,select:focus,textarea:focus{border-color:var(--blue)}
  /* layout */
  #loginPage{display:flex;align-items:center;justify-content:center;height:100vh;background:linear-gradient(135deg,var(--blue),var(--accent))}
  #loginBox{background:#fff;padding:36px;border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,0.18);width:360px;text-align:center}
  #loginBox h2{margin-bottom:18px}
  #loginBox input{width:100%;margin-bottom:12px;font-size:14px}
  #loginBox button{width:100%;background:var(--blue);color:#fff;font-weight:700;margin-top:6px}
  #loginBox p.info{font-size:12px;color:var(--muted);margin-top:8px}

  #appPage{display:none;min-height:100vh;display:flex}
  #sidebar{width:220px;background:var(--blue);color:#fff;min-height:100vh;transition:width 0.2s;overflow:hidden}
  #sidebar.collapsed{width:64px}
  #sidebar h2{text-align:center;padding:14px 0;border-bottom:1px solid rgba(255,255,255,0.12);font-size:18px;margin:0}
  #sidebar ul{list-style:none;padding:0;margin:0}
  #sidebar ul li{padding:12px 16px;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:14px}
  #sidebar ul li:hover{background:#2b4b86}
  #mainContent{flex:1;padding:18px;overflow:auto}
  #topBar{display:flex;justify-content:space-between;align-items:center;background:#fff;padding:10px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-bottom:12px}
  #topBar .left{display:flex;align-items:center}
  #hamburger{font-size:20px;cursor:pointer;margin-right:8px}
  .btn-primary{background:var(--blue);color:#fff}
  .btn-success{background:#28a745;color:#fff}
  .btn-warning{background:#ffc107;color:#000}
  .btn-danger{background:#dc3545;color:#fff}
  table{width:100%;border-collapse:collapse;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.06);margin-top:10px}
  th,td{border:1px solid #e6e6e6;padding:10px;text-align:center;font-size:13px}
  th{background:var(--blue);color:#fff}
  tr:hover td{background:#f7fbff}
  form{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
  form input, form select, form textarea{flex:1;min-width:130px}
  .hidden{display:none}
  .small{font-size:12px;padding:6px 8px}
  .muted{color:#666;font-size:13px}
  .flex{display:flex;gap:8px;align-items:center}
  .flex-col{display:flex;flex-direction:column;gap:8px}
  .w200{width:200px}
  /* responsive */
  @media (max-width:800px){#sidebar{display:none} #appPage{flex-direction:column}}
</style>
</head>
<body>

<!-- ===== LOGIN ===== -->
<div id="loginPage">
  <div id="loginBox">
    <h2>Login Karyawan / Pelanggan</h2>
    <input id="nik" placeholder="NIK / ID Pelanggan" />
    <input id="password" type="password" placeholder="Password" />
    <button id="btnLogin" onclick="loginNIK()">Login</button>
    <p id="loginMsg" class="muted" style="color:crimson;margin-top:8px"></p>
    <p class="info">by Dnt Grup - Starnet üí´</p>
    <p class="info">Email: dnt.network.lmj@gmail.com</p>
  </div>
</div>

<!-- ===== APP ===== -->
<div id="appPage">
  <div id="sidebar">
    <h2>ISP üí´</h2>
    <ul>
      <li onclick="showPage('dashboard')">üìä Dashboard</li>
      <li onclick="showPage('gangguan')">‚ö†Ô∏è Gangguan</li>
      <li onclick="showPage('pasangBaru')">üÜï Pasang Baru</li>
      <li onclick="showPage('pelanggan')">üë• Pelanggan</li>
      <li onclick="showPage('billing')">üí≥ Billing</li>
      <li onclick="showPage('kas')">üí∞ Kas</li>
      <li onclick="showPage('odp')">üñß ODP / Mikrotik</li>
      <li onclick="showPage('material')">üì¶ Material</li>
      <li onclick="showPage('paket')">üì¶ Paket / Tarif</li>
      <li onclick="showPage('karyawan')">üëî Karyawan</li>
      <li onclick="showPage('webhook')">‚öôÔ∏è Webhook</li>
      <li onclick="showPage('history')">üóÇÔ∏è Arsip / History</li>
      <li onclick="showPage('portal')">üåê Portal Pelanggan</li>
      <li onclick="logout()">üö™ Logout</li>
    </ul>
  </div>

  <div id="mainContent">
    <div id="topBar">
      <div class="left">
        <span id="hamburger" onclick="toggleSidebar()">‚ò∞</span>
        <div>Halo, <strong id="userName">-</strong> (<span id="userRole">-</span>)</div>
      </div>
      <div><button class="btn-warning small" onclick="logout()">Logout</button></div>
    </div>

    <!-- ===== DASHBOARD ===== -->
    <div id="dashboardPage" class="">
      <h2>Dashboard</h2>
      <canvas id="chartDashboard" height="90"></canvas>
    </div>

    <!-- ===== GANGGUAN (with requested change) ===== -->
    <div id="gangguanPage" class="hidden">
      <h2>Gangguan / Tiket Pelanggan</h2>

      <!-- Form tambah gangguan -->
      <form id="formGangguan">
        <input id="g_pelanggan" placeholder="Nama Pelanggan" required />
        <input id="g_nohp" placeholder="No HP (opsional)" />
        <input id="g_alamat" placeholder="Alamat (opsional)" />
        <input id="g_masalah" placeholder="Ringkasan Masalah" required />
        <select id="g_prioritas" style="width:150px">
          <option value="Normal">Normal</option>
          <option value="Urgent">Urgent</option>
        </select>
        <button type="submit" class="btn-primary">Buat Tiket</button>
      </form>

      <!-- Tabel gangguan -->
      <table id="tblGangguan">
        <thead>
          <tr>
            <!-- PERMINTAAN: kolom "Kode" diubah jadi "Tiket Gangguan" -->
            <th>Tiket Gangguan</th>
            <th>Pelanggan</th>
            <th>No HP</th>
            <th>Masalah</th>
            <th>Status</th>
            <th>TTR</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:8px" class="flex">
        <button onclick="generateDummyGangguan()" class="btn-primary small">Generate Dummy Gangguan</button>
        <div class="muted" style="margin-left:8px">Prefix tetap <code>TC</code>. Reserved tiket: <code>TC0000</code></div>
      </div>
    </div>

    <!-- ===== PASANG BARU ===== -->
    <div id="pasangBaruPage" class="hidden">
      <h2>Pasang Baru</h2>
      <form id="formPasang">
        <input id="p_nama" placeholder="Nama" required />
        <input id="p_nohp" placeholder="No HP" required />
        <input id="p_alamat" placeholder="Alamat" required />
        <input id="p_paket" placeholder="Paket" required />
        <input id="p_sn" placeholder="SN ONT (opsional)" />
        <input id="p_odp" placeholder="ODP (opsional)" />
        <select id="p_status" style="width:140px">
          <option>Menunggu</option><option>Survey</option><option>Instalasi</option><option>Active</option>
        </select>
        <button type="submit" class="btn-primary">Daftar</button>
      </form>

      <table id="tblPasang">
        <thead>
          <tr>
            <th>No Internet</th><th>Nama</th><th>No HP</th><th>Alamat</th><th>Paket</th><th>SN ONT</th><th>ODP</th><th>Status</th><th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- ===== PELANGGAN (simple viewer & CRUD link to pasangBaru) ===== -->
    <div id="pelangganPage" class="hidden">
      <h2>Pelanggan</h2>
      <table id="tblPelanggan">
        <thead><tr><th>No Internet</th><th>Nama</th><th>Alamat</th><th>No HP</th><th>Paket</th><th>SN ONT</th><th>ODP</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- ===== BILLING ===== -->
    <div id="billingPage" class="hidden">
      <h2>Billing</h2>
      <div class="flex-col">
        <div class="flex">
          <button onclick="generateDummyBilling()" class="btn-primary small">Generate Billing Dummy</button>
          <div class="muted"> (dummy bills)</div>
        </div>
        <table id="tblBilling"><thead><tr><th>No</th><th>Pelanggan</th><th>Periode</th><th>Jumlah</th><th>Status</th><th>Aksi</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <!-- ===== KAS ===== -->
    <div id="kasPage" class="hidden"><h2>Kas / Keuangan</h2><table id="tblKas"><thead><tr><th>No</th><th>Deskripsi</th><th>Masuk</th><th>Keluar</th><th>Saldo</th></tr></thead><tbody></tbody></table></div>

    <!-- ===== ODP ===== -->
    <div id="odpPage" class="hidden"><h2>ODP / Mikrotik</h2><table id="tblODP"><thead><tr><th>ODP</th><th>SNONT</th><th>IP</th><th>Aksi</th></tr></thead><tbody></tbody></table></div>

    <!-- ===== MATERIAL ===== -->
    <div id="materialPage" class="hidden">
      <h2>Material / Inventory</h2>
      <form id="formMaterial">
        <input id="m_nama" placeholder="Nama Material" required />
        <input id="m_stok" type="number" placeholder="Stok Awal" required />
        <button type="submit" class="btn-primary">Tambah Material</button>
      </form>
      <table id="tblMaterial"><thead><tr><th>Nama</th><th>Stok</th><th>Aksi</th></tr></thead><tbody></tbody></table>
    </div>

    <!-- ===== PAKET ===== -->
    <div id="paketPage" class="hidden">
      <h2>Paket / Tarif</h2>
      <form id="formPaket">
        <input id="pkg_nama" placeholder="Nama Paket" required />
        <input id="pkg_harga" type="number" placeholder="Harga" required />
        <input id="pkg_speed" placeholder="Kecepatan" required />
        <button type="submit" class="btn-primary">Tambah Paket</button>
      </form>
      <table id="tblPaket"><thead><tr><th>Nama Paket</th><th>Harga</th><th>Kecepatan</th><th>Aksi</th></tr></thead><tbody></tbody></table>
    </div>

    <!-- ===== KARYAWAN ===== -->
    <div id="karyawanPage" class="hidden">
      <h2>Manajemen Karyawan</h2>
      <form id="formKaryawan">
        <input id="k_nik" placeholder="NIK" required />
        <input id="k_nama" placeholder="Nama" required />
        <input id="k_pass" placeholder="Password" required />
        <select id="k_role" style="width:140px"><option value="admin">Admin</option><option value="teknisi">Teknisi</option></select>
        <button type="submit" class="btn-primary">Tambah</button>
      </form>
      <table id="tblKaryawan"><thead><tr><th>NIK</th><th>Nama</th><th>Role</th><th>Aksi</th></tr></thead><tbody></tbody></table>
    </div>

    <!-- ===== WEBHOOK ===== -->
    <div id="webhookPage" class="hidden">
      <h2>Webhook</h2>
      <form id="formWebhook">
        <input id="wh_url" placeholder="URL Webhook WA" />
        <input id="wh_auth" placeholder="Auth Header (opsional)" />
        <button type="submit" class="btn-primary">Simpan</button>
      </form>
    </div>

    <!-- ===== HISTORY ===== -->
    <div id="historyPage" class="hidden">
      <h2>Arsip / History</h2>
      <p class="muted">Riwayat operasi akan tersimpan di koleksi <code>history</code> (CRUD otomatis menyimpan log)</p>
      <table id="tblHistory"><thead><tr><th>Waktu</th><th>Jenis</th><th>Item</th><th>Deskripsi</th></tr></thead><tbody></tbody></table>
    </div>

    <!-- ===== PORTAL PELANGGAN ===== -->
    <div id="portalPage" class="hidden">
      <h2>Portal Pelanggan</h2>
      <p class="muted">Pelanggan dapat melihat tagihan & tiket. (UI read-only demo)</p>
      <table id="tblPortalBilling"><thead><tr><th>No</th><th>Pelanggan</th><th>Periode</th><th>Jumlah</th><th>Status</th></tr></thead><tbody></tbody></table>
    </div>

  </div>
</div>

<script>
/* ================= FIREBASE SETUP ================= */
const firebaseConfig = {
  apiKey: "AIzaSyB-iBpZNC0YZBTAUzir7gJuU9kBQg82moc",
  authDomain: "dnt-network-7.firebaseapp.com",
  projectId: "dnt-network-7",
  storageBucket: "dnt-network-7.appspot.com",
  messagingSenderId: "761179668371",
  appId: "1:761179668371:web:7d1468d0298041d4783266",
  measurementId: "G-CD3EQ350R4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================ GLOBAL STATE ================ */
let currentUser = null;

/* ================ UTILITIES ================ */
function q(id){ return document.getElementById(id); }
function el(tag, attrs = {}){ const e = document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>e.setAttribute(k,v)); return e; }
function fmtNow(){ return new Date().toISOString(); }
async function logHistory(type, item, desc){
  // store a history record
  try { await db.collection('history').add({ts: firebase.firestore.FieldValue.serverTimestamp(), type, item, desc}); }
  catch(e){ console.warn('history log failed', e); }
}

/* ================ AUTH (simple doc-based) ================ */
async function loginNIK(){
  const nik = q('nik').value.trim().toLowerCase();
  const pass = q('password').value;
  q('loginMsg').innerText = '';
  if(!nik || !pass){ q('loginMsg').innerText = 'Isi NIK & password.'; return; }
  try{
    const doc = await db.collection('users').doc(nik).get();
    if(!doc.exists){ q('loginMsg').innerText = 'ID tidak ditemukan'; return; }
    const data = doc.data();
    if(data.password !== pass){ q('loginMsg').innerText = 'Password salah'; return; }
    currentUser = { nik, ...data };
    // show app
    q('loginPage').style.display = 'none';
    q('appPage').style.display = 'flex';
    q('userName').innerText = data.nama || nik;
    q('userRole').innerText = data.role || '-';
    // load data
    await prepareReservedTicket(); // ensure TC0000 exists
    await initAll();
  }catch(err){
    console.error(err); q('loginMsg').innerText = 'Login error, cek console';
  }
}
function logout(){
  currentUser = null;
  q('loginPage').style.display = 'flex';
  q('appPage').style.display = 'none';
  q('nik').value = ''; q('password').value = '';
}

/* ================ SIDEBAR / NAV ================ */
function showPage(page){
  const pages = ['dashboard','gangguan','pasangBaru','pelanggan','billing','kas','odp','material','paket','karyawan','webhook','history','portal'];
  pages.forEach(p => { const el = document.getElementById(p+'Page'); if(el) el.classList.add('hidden'); });
  const active = document.getElementById(page+'Page');
  if(active) active.classList.remove('hidden');
}
function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('collapsed'); }

/* ================ DASHBOARD ================ */
let chartDashboard = null;
function initDashboard(){
  const ctx = q('chartDashboard').getContext('2d');
  chartDashboard = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Gangguan','PasangBaru','Pelanggan','Billing'],
      datasets: [{ label: 'Jumlah (dummy)', data: [5, 12, 20, 8], backgroundColor: '#1f3b6f' }]
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });
}

/* ================ GANGGUAN (main requested change) ================ */

/*
 Requirements applied:
  - Column labeled "Tiket Gangguan"
  - Ticket codes generated TC0001, TC0002, ...
  - TC0000 reserved and created (if not exists) ‚Äî must not be auto-incremented/changed
  - All actions saved in Firestore (collection 'gangguan')
  - No other menu/function removed or altered
*/

// Ensure TC0000 reserved doc exists
async function prepareReservedTicket(){
  try{
    const docRef = db.collection('gangguan').doc('TC0000');
    const doc = await docRef.get();
    if(!doc.exists){
      await docRef.set({
        pelanggan: 'RESERVED',
        masalah: 'Reserved kode (TC0000) ‚Äî jangan ubah',
        status: 'Reserved',
        ttr: '--',
        reserved: true,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      console.log('TC0000 reserved created');
    }
  }catch(e){ console.warn('prepareReservedTicket error', e); }
}

// Helper: find next TC number by scanning existing 'gangguan' docs with TC prefix
async function getNextTicketCode(){
  // Query docs that start with TC and have numeric part >= 1, ignore TC0000
  try{
    const snap = await db.collection('gangguan').get();
    let max = 0;
    snap.forEach(doc => {
      const id = doc.id;
      if(!id.startsWith('TC')) return;
      if(id === 'TC0000') return;
      // parse numeric part
      const num = parseInt(id.slice(2), 10);
      if(!isNaN(num) && num > max) max = num;
    });
    const next = max + 1;
    const code = 'TC' + String(next).padStart(4, '0');
    return code;
  }catch(e){
    console.error('getNextTicketCode error', e);
    // fallback incremental local (shouldn't happen often)
    return 'TC0001';
  }
}

// Create new ticket from form
q('formGangguan').addEventListener('submit', async function(e){
  e.preventDefault();
  const pelanggan = q('g_pelanggan').value.trim();
  const nohp = q('g_nohp').value.trim();
  const alamat = q('g_alamat').value.trim();
  const masalah = q('g_masalah').value.trim();
  const prioritas = q('g_prioritas').value || 'Normal';
  if(!pelanggan || !masalah){ alert('isi pelanggan & masalah'); return; }

  try{
    const code = await getNextTicketCode(); // TC0001...
    await db.collection('gangguan').doc(code).set({
      tiket: code,
      pelanggan, nohp, alamat, masalah,
      prioritas,
      status: 'Menunggu',
      ttr: '--',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    await logHistory('gangguan.create', code, `Tiket dibuat oleh ${currentUser?.nama || currentUser?.nik || 'unknown'}`);
    q('formGangguan').reset();
    loadGangguan();
    alert('Tiket gangguan dibuat: ' + code);
  }catch(err){ console.error(err); alert('Gagal buat tiket'); }
});

// Load gangguan table
async function loadGangguan(){
  try{
    const snap = await db.collection('gangguan').orderBy('createdAt','desc').get();
    const tb = q('tblGangguan').querySelector('tbody'); tb.innerHTML = '';
    snap.forEach(doc => {
      const d = doc.data();
      // Only show documents that represent tickets (include TC0000 if you want, but reserved present)
      const id = doc.id;
      // Render row
      const tr = document.createElement('tr');

      // tiket gangguan column
      const tiketCell = `<td>${id}</td>`;
      const pelangganCell = `<td>${d.pelanggan||'-'}</td>`;
      const nohpCell = `<td>${d.nohp||'-'}</td>`;
      const masalahCell = `<td style="text-align:left">${(d.masalah||'-')}</td>`;
      const statusCell = `<td>${d.status||'-'}</td>`;
      const ttrCell = `<td>${d.ttr||'--'}</td>`;

      // aksi: show buttons depending on status
      let aksiHtml = '';
      if(d.reserved){
        aksiHtml = `<button class="small" disabled>Reserved</button>`;
      } else {
        if(d.status === 'Menunggu'){
          aksiHtml = `<button class="btn-success small" onclick="assignToTechnician('${id}')">Kirim ke Teknisi</button> <button class="btn-danger small" onclick="hapusGangguan('${id}')">Hapus</button>`;
        } else if(d.status === 'Progres' || d.status === 'Material Dicek'){
          aksiHtml = `<button class="btn-primary small" onclick="closeGangguan('${id}')">Tutup</button> <button class="btn-danger small" onclick="hapusGangguan('${id}')">Hapus</button>`;
        } else if(d.status === 'Selesai'){
          aksiHtml = `<button class="small" disabled>Closed</button>`;
        } else {
          aksiHtml = `<button class="btn-danger small" onclick="hapusGangguan('${id}')">Hapus</button>`;
        }
      }

      tr.innerHTML = tiketCell + pelangganCell + nohpCell + masalahCell + statusCell + ttrCell + `<td>${aksiHtml}</td>`;
      tb.appendChild(tr);
    });
  }catch(e){ console.error('loadGangguan error', e); }
}

// Actions: assign to technician (simulate WA send)
async function assignToTechnician(code){
  try{
    // update status to Progres
    await db.collection('gangguan').doc(code).update({ status: 'Progres', assignedAt: firebase.firestore.FieldValue.serverTimestamp() });
    await logHistory('gangguan.assign', code, `Assigned to technician by ${currentUser?.nama || currentUser?.nik}`);
    alert(`WA SIMULASI ‚Üí Admin mengirim tiket ${code} ke teknisi.`);
    // simulate technician verification delay then check material and reduce stock
    setTimeout(() => technicianVerify(code), 1500);
    loadGangguan();
  }catch(e){ console.error(e); alert('Gagal assign'); }
}

// technician verifies, checks material, reduces stock automatically
async function technicianVerify(code){
  try{
    // verify progress
    await db.collection('gangguan').doc(code).update({ status: 'Material Dicek' });
    await logHistory('gangguan.verify', code, 'Teknisi verifikasi progres');
    alert(`WA SIMULASI ‚Üí Teknisi verifikasi progres untuk ${code}. Mengecek material...`);

    // For demo: reduce one unit of first material if exists
    const matSnap = await db.collection('material').limit(1).get();
    if(!matSnap.empty){
      const matDoc = matSnap.docs[0];
      const matData = matDoc.data();
      const newStok = Math.max(0, (matData.stok||0) - 1);
      await db.collection('material').doc(matDoc.id).update({ stok: newStok });
      await logHistory('material.update', matDoc.id, `Stok dikurangi 1 karena penanganan ${code}`);
      alert(`Stok material '${matDoc.id}' dikurangi 1 (sisa ${newStok})`);
    } else {
      alert('Tidak ada material terdaftar untuk pengurangan stok (demo).');
    }

    // mark as finished after a short delay
    setTimeout(async () => {
      await db.collection('gangguan').doc(code).update({ status: 'Selesai', ttr: '1 jam' });
      await logHistory('gangguan.close', code, 'Tiket ditutup oleh teknisi');
      alert(`Tiket ${code} telah selesai (Selesai).`);
      loadGangguan();
    }, 1500);

  }catch(e){ console.error('technicianVerify error', e); }
}

// delete gangguan
async function hapusGangguan(id){
  if(!confirm('Hapus tiket ' + id + ' ?')) return;
  try{
    await db.collection('gangguan').doc(id).delete();
    await logHistory('gangguan.delete', id, 'Dihapus oleh ' + (currentUser?.nik || 'unknown'));
    loadGangguan();
  }catch(e){ console.error(e); alert('Gagal hapus'); }
}

// close gangguan manually
async function closeGangguan(id){
  if(!confirm('Tutup tiket ' + id + ' ?')) return;
  try{
    await db.collection('gangguan').doc(id).update({ status:'Selesai', ttr:'--', closedAt: firebase.firestore.FieldValue.serverTimestamp() });
    await logHistory('gangguan.close', id, 'Ditutup oleh ' + (currentUser?.nik || 'unknown'));
    loadGangguan();
  }catch(e){ console.error(e); alert('Gagal tutup'); }
}

/* ================ PASANG BARU (No Internet auto) ================ */
let nextNoInternetLocal = 1906140000; // fallback local counter
q('formPasang').addEventListener('submit', async function(e){
  e.preventDefault();
  const nama = q('p_nama').value.trim();
  const nohp = q('p_nohp').value.trim();
  const alamat = q('p_alamat').value.trim();
  const paket = q('p_paket').value.trim();
  const sn = q('p_sn').value.trim();
  const odp = q('p_odp').value.trim();
  const status = q('p_status').value || 'Menunggu';
  if(!nama || !nohp || !alamat || !paket){ alert('Isi semua field wajib'); return; }

  try{
    // generate next internet number by reading collection keys to avoid collision
    const snap = await db.collection('pasangBaru').get();
    let max = 0;
    snap.forEach(doc => {
      const id = doc.id;
      const num = parseInt(id,10);
      if(!isNaN(num) && num > max) max = num;
    });
    let nextNo = max > 0 ? max + 1 : nextNoInternetLocal++;
    // ensure string
    const idStr = String(nextNo);
    await db.collection('pasangBaru').doc(idStr).set({
      nama, nohp, alamat, paket, snOnt: sn, odp, status, createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    await logHistory('pasang.create', idStr, `Pasang baru oleh ${currentUser?.nik||'unknown'}`);
    q('formPasang').reset();
    loadPasangBaru();
    alert('Pasang baru terdaftar: ' + idStr);
  }catch(e){ console.error(e); alert('Gagal daftar pasang'); }
});

async function loadPasangBaru(){
  try{
    const snap = await db.collection('pasangBaru').orderBy('createdAt','desc').get();
    const tb = q('tblPasang').querySelector('tbody'); tb.innerHTML = '';
    snap.forEach(doc => {
      const d = doc.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${doc.id}</td><td>${d.nama||'-'}</td><td>${d.nohp||'-'}</td><td>${d.alamat||'-'}</td><td>${d.paket||'-'}</td><td>${d.snOnt||'-'}</td><td>${d.odp||'-'}</td><td>${d.status||'-'}</td><td><button class="btn-danger small" onclick="hapusPasang('${doc.id}')">Hapus</button></td>`;
      tb.appendChild(tr);
    });
  }catch(e){ console.error('loadPasangBaru error', e); }
}
async function hapusPasang(id){
  if(!confirm('Hapus pasang baru ' + id + ' ?')) return;
  try{
    await db.collection('pasangBaru').doc(id).delete();
    await logHistory('pasang.delete', id, 'Dihapus oleh ' + (currentUser?.nik || 'unknown'));
    loadPasangBaru();
  }catch(e){ console.error(e); }
}

/* ================ PELANGGAN VIEWER ================ */
async function loadPelanggan(){
  try{
    const snap = await db.collection('pasangBaru').orderBy('createdAt','desc').get();
    const tb = q('tblPelanggan').querySelector('tbody'); tb.innerHTML = '';
    snap.forEach(doc => {
      const d = doc.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${doc.id}</td><td>${d.nama||'-'}</td><td>${d.alamat||'-'}</td><td>${d.nohp||'-'}</td><td>${d.paket||'-'}</td><td>${d.snOnt||'-'}</td><td>${d.odp||'-'}</td><td><button class="btn-danger small" onclick="hapusPasang('${doc.id}')">Non-aktif</button></td>`;
      tb.appendChild(tr);
    });
  }catch(e){ console.error(e); }
}

/* ================ BILLING (dummy generator) ================ */
function generateDummyBilling(){
  (async ()=>{
    for(let i=1;i<=5;i++){
      const id = 'B' + String(i).padStart(3,'0');
      await db.collection('billing').doc(id).set({ pelanggan: 'Pelanggan' + i, periode: '2025-08', jumlah: 100000, status: 'Belum Lunas', createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      await logHistory('billing.create', id, 'Dummy billing generated');
    }
    loadBilling();
    alert('Dummy billing generated');
  })();
}
async function loadBilling(){
  try{
    const snap = await db.collection('billing').orderBy('createdAt','desc').get();
    const tb = q('tblBilling').querySelector('tbody'); tb.innerHTML = '';
    snap.forEach(doc => {
      const d = doc.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${doc.id}</td><td>${d.pelanggan||'-'}</td><td>${d.periode||'-'}</td><td>${d.jumlah||0}</td><td>${d.status||'-'}</td><td><button class="btn-danger small" onclick="hapusBilling('${doc.id}')">Hapus</button></td>`;
      tb.appendChild(tr);
    });
  }catch(e){ console.error(e); }
}
async function hapusBilling(id){ if(!confirm('Hapus billing '+id+'?')) return; await db.collection('billing').doc(id).delete(); loadBilling(); }

/* ================ MATERIAL CRUD ================ */
q('formMaterial')?.addEventListener('submit', async function(e){
  e.preventDefault();
  const nama = q('m_nama').value.trim();
  const stok = parseInt(q('m_stok').value,10) || 0;
  if(!nama){ alert('Nama material wajib'); return; }
  try{
    await db.collection('material').doc(nama).set({ stok });
    await logHistory('material.create', nama, `Material ${nama} set stok ${stok}`);
    q('formMaterial').reset();
    loadMaterial();
  }catch(e){ console.error(e); }
});
async function loadMaterial(){
  try{
    const snap = await db.collection('material').get();
    const tb = q('tblMaterial').querySelector('tbody'); tb.innerHTML = '';
    snap.forEach(doc => {
      const d = doc.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${doc.id}</td><td>${d.stok||0}</td><td><button class="btn-danger small" onclick="hapusMaterial('${doc.id}')">Hapus</button></td>`;
      tb.appendChild(tr);
    });
  }catch(e){ console.error(e); }
}
async function hapusMaterial(id){ if(!confirm('Hapus material '+id+'?')) return; await db.collection('material').doc(id).delete(); await logHistory('material.delete', id, 'dihapus'); loadMaterial(); }

/* ================ PAKET CRUD ================ */
q('formPaket')?.addEventListener('submit', async function(e){
  e.preventDefault();
  const nama = q('pkg_nama').value.trim();
  const harga = parseInt(q('pkg_harga').value,10) || 0;
  const speed = q('pkg_speed').value.trim();
  if(!nama){ alert('Nama paket wajib'); return; }
  await db.collection('paket').doc(nama).set({ harga, speed });
  await logHistory('paket.create', nama, `Paket ${nama} ${harga}/${speed}`);
  q('formPaket').reset();
  loadPaket();
});
async function loadPaket(){
  try{
    const snap = await db.collection('paket').get();
    const tb = q('tblPaket').querySelector('tbody'); tb.innerHTML = '';
    snap.forEach(doc => {
      const d = doc.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${doc.id}</td><td>${d.harga||0}</td><td>${d.speed||'-'}</td><td><button class="btn-danger small" onclick="hapusPaket('${doc.id}')">Hapus</button></td>`;
      tb.appendChild(tr);
    });
  }catch(e){ console.error(e); }
}
async function hapusPaket(id){ if(!confirm('Hapus paket '+id+'?')) return; await db.collection('paket').doc(id).delete(); loadPaket(); }

/* ================ KARYAWAN CRUD ================ */
q('formKaryawan')?.addEventListener('submit', async function(e){
  e.preventDefault();
  const nik = q('k_nik').value.trim().toLowerCase();
  const nama = q('k_nama').value.trim();
  const pass = q('k_pass').value;
  const role = q('k_role').value || 'teknisi';
  if(!nik || !nama || !pass){ alert('Lengkapi data karyawan'); return; }
  await db.collection('users').doc(nik).set({ nama, password: pass, role });
  await logHistory('user.create', nik, `Karyawan ${nama}`);
  q('formKaryawan').reset();
  loadKaryawan();
});
async function loadKaryawan(){
  try{
    const snap = await db.collection('users').get();
    const tb = q('tblKaryawan').querySelector('tbody'); tb.innerHTML = '';
    snap.forEach(doc => {
      const d = doc.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${doc.id}</td><td>${d.nama||'-'}</td><td>${d.role||'-'}</td><td><button class="btn-danger small" onclick="hapusKaryawan('${doc.id}')">Hapus</button></td>`;
      tb.appendChild(tr);
    });
  }catch(e){ console.error(e); }
}
async function hapusKaryawan(nik){ if(!confirm('Hapus karyawan '+nik+'?')) return; if(currentUser && currentUser.nik===nik){ alert('Tidak bisa menghapus diri sendiri'); return; } await db.collection('users').doc(nik).delete(); loadKaryawan(); }

/* ================ WEBHOOK SAVE ================ */
q('formWebhook')?.addEventListener('submit', async function(e){
  e.preventDefault();
  const url = q('wh_url').value.trim();
  const auth = q('wh_auth').value.trim();
  if(!url){ alert('URL wajib'); return; }
  await db.collection('webhook').doc('wa').set({ url, auth, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
  await logHistory('webhook.update','wa','Webhook WA updated');
  alert('Webhook WA disimpan');
});

/* ================ HISTORY VIEW ================ */
async function loadHistory(){
  try{
    const snap = await db.collection('history').orderBy('ts','desc').limit(200).get();
    const tb = q('tblHistory').querySelector('tbody'); tb.innerHTML = '';
    snap.forEach(doc => {
      const d = doc.data();
      const date = d.ts ? (d.ts.toDate()).toLocaleString() : '-';
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${date}</td><td>${d.type||'-'}</td><td>${d.item||'-'}</td><td style="text-align:left">${d.desc||'-'}</td>`;
      tb.appendChild(tr);
    });
  }catch(e){ console.error(e); }
}

/* ================ SIMPLE LOADERS (billing, kas, odp) ================ */
async function loadBilling(){ try{ const snap = await db.collection('billing').orderBy('createdAt','desc').get(); const tb = q('tblBilling').querySelector('tbody'); tb.innerHTML=''; snap.forEach(doc=>{const d=doc.data(); const tr=document.createElement('tr'); tr.innerHTML=`<td>${doc.id}</td><td>${d.pelanggan||'-'}</td><td>${d.periode||'-'}</td><td>${d.jumlah||0}</td><td>${d.status||'-'}</td><td><button class="btn-danger small" onclick="hapusBilling('${doc.id}')">Hapus</button></td>`; tb.appendChild(tr); }); }catch(e){console.error(e);} }
async function loadKas(){ const snap = await db.collection('kas').orderBy('ts','desc').get(); const tb = q('tblKas').querySelector('tbody'); tb.innerHTML=''; snap.forEach(doc=>{const d=doc.data(); const tr=document.createElement('tr'); tr.innerHTML=`<td>${doc.id}</td><td>${d.desc||'-'}</td><td>${d.masuk||0}</td><td>${d.keluar||0}</td><td>${d.saldo||0}</td>`; tb.appendChild(tr); }); }
async function loadODP(){ const snap = await db.collection('odp').get(); const tb = q('tblODP').querySelector('tbody'); tb.innerHTML=''; snap.forEach(doc=>{const d=doc.data(); const tr=document.createElement('tr'); tr.innerHTML=`<td>${doc.id}</td><td>${d.sn||'-'}</td><td>${d.ip||'-'}</td><td><button class="btn-danger small" onclick="hapusODP('${doc.id}')">Hapus</button></td>`; tb.appendChild(tr); }); }
async function hapusODP(id){ if(!confirm('Hapus ODP '+id+'?')) return; await db.collection('odp').doc(id).delete(); loadODP(); }

/* ================ INIT ALL ================ */
async function initAll(){
  initDashboard();
  await Promise.all([
    loadGangguan(),
    loadPasangBaru(),
    loadPelanggan(),
    loadBilling(),
    loadMaterial(),
    loadPaket(),
    loadKaryawan(),
    loadHistory(),
    loadODP(),
    loadKas()
  ]);
  showPage('dashboard');
}

/* ================ ONLOAD minimal (ensure UI present) ================ */
window.addEventListener('load', () => {
  // keep login visible unless user logs in
  q('appPage').style.display = 'none';
  q('loginPage').style.display = 'flex';
});

</script>
</body>
</html>
