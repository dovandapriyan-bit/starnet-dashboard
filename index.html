<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Starnet 💫 — Full</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg: #f3f7fb; --card: #fff; --muted: #6b7280; --sidebar: #072a4a; --accent: #06b6d4;
            --primary: #2563eb; --radius: 12px;
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
        body { background: var(--bg); color: #0b1220; }

        .login-root { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 24px; }
        .login-card { width: 100%; max-width: 680px; border-radius: 16px; padding: 22px; 
                     background: linear-gradient(180deg, #ffffff, #fbfdff); 
                     box-shadow: 0 30px 80px rgba(20,40,80,0.08); border: 1px solid rgba(15,23,42,0.04); }
        .logo-row { display: flex; align-items: center; gap: 12px; }
        .logo-badge { width: 56px; height: 56px; border-radius: 12px; display: grid; place-items: center;
                     background: linear-gradient(135deg, var(--primary), var(--accent)); color: #fff; font-weight: 800; }
        .small-muted { color: var(--muted); font-size: 13px; }
        .app-grid { display: grid; grid-template-columns: 260px 1fr; grid-template-rows: 64px 1fr; height: 100vh; }
        .topbar { height: 64px; background: #fff; display: flex; align-items: center; padding: 0 18px;
                 border-bottom: 1px solid rgba(15,23,42,0.06); box-shadow: 0 4px 20px rgba(16,24,40,0.03); z-index: 20; }
        .sidebar { background: linear-gradient(180deg, var(--sidebar), #0f4a83); color: #e9f0ff; padding: 16px; overflow: auto; }
        .brand { display: flex; align-items: center; gap: 10px; font-weight: 800; }
        .nav-link { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 8px; 
                   color: #e9f0ff; text-decoration: none; margin-bottom: 6px; cursor: pointer; }
        .nav-link:hover { background: rgba(255,255,255,0.04); }
        .nav-link.active { background: rgba(255,255,255,0.06); }
        .main { padding: 18px; overflow: auto; }
        .card-modern { background: var(--card); border-radius: 12px; padding: 14px; margin-bottom: 14px;
                      box-shadow: 0 10px 30px rgba(15,23,42,0.04); }
        .btn-xs { padding: 6px 8px; font-size: 13px; border-radius: 8px; }
        .hidden { display: none; }
        @media (max-width: 1000px) {
            .app-grid { grid-template-columns: 1fr; grid-template-rows: 64px auto 1fr; }
            .sidebar { position: fixed; left: -320px; top: 64px; height: calc(100vh - 64px); 
                      width: 260px; transition: left .2s; z-index: 50; }
            .sidebar.show { left: 0; }
            .main-content { margin-left: 0 !important; }
        }
        pre { white-space: pre-wrap; }
        .map-container { height: 200px; margin-top: 10px; border-radius: 8px; overflow: hidden; }
    </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginRoot" class="login-root">
    <div class="login-card">
        <div class="logo-row">
            <div class="logo-badge" aria-hidden>
                <svg width="34" height="34" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2l2.39 6.96H22l-5.45 3.96 2.1 6.96L12 16.9l-6.65 3.98 2.1-6.96L2 8.96h7.61z" fill="#FFD166"/>
                    <circle cx="18" cy="4" r="1.6" fill="#fff" opacity="0.95"/>
                </svg>
            </div>
            <div>
                <div style="font-weight:800;font-size:18px">Starnet <span> </span></div>
                <div class="small-muted">Login menggunakan NIK — Mobile & Desktop</div>
            </div>
            <div style="margin-left:auto;text-align:right" class="small-muted">VSN4 • Dnt Grup</div>
        </div>

        <form id="loginForm" style="margin-top:16px">
            <div class="mb-3">
                <label class="form-label small-muted">NIK</label>
                <input id="username" class="form-control form-control-lg" placeholder="Masukkan NIK" autofocus>
            </div>
            <div class="mb-3">
                <label class="form-label small-muted">Password</label>
                <input id="password" type="password" class="form-control form-control-lg" placeholder="Kata sandi">
            </div>
            <div style="display:flex;gap:8px">
                <button id="btnLogin" class="btn btn-primary btn-lg flex-fill">Masuk</button>
                <button id="btnDemo" type="button" class="btn btn-outline-primary btn-lg">Isi Demo</button>
            </div>

            <div style="display:flex;gap:8px;margin-top:8px">
                <button id="btnSelfTest" type="button" class="btn btn-secondary btn-sm flex-fill">Cek Fungsional</button>
                <button id="btnResetDB" type="button" class="btn btn-outline-danger btn-sm flex-fill">Reset DB</button>
            </div>

            <div id="loginMsg" style="color:#b91c1c;margin-top:8px"></div>
            <div style="margin-top:12px" class="small-muted text-center">by Dnt Grup — <a href="mailto:dnt.network.lmj@gmail.com">dnt.network.lmj@gmail.com</a></div>
        </form>
    </div>
</div>

<!-- APP -->
<div id="appShell" class="app-grid hidden" role="application" aria-hidden="true">
    <div class="topbar">
        <div style="display:flex;align-items:center;gap:12px">
            <div id="hambBtn" style="cursor:pointer;font-size:20px">≡</div>
            <div style="font-weight:800">Starnet💫 <span>◇</span></div>
        </div>
        <div style="margin-left:auto;display:flex;align-items:center;gap:12px">
            <div id="timeNow" class="small-muted"></div>
            <div id="whoami" class="small-muted">Belum login</div>
            <button id="btnLogout" class="btn btn-outline-danger btn-sm" style="display:none">Logout</button>
        </div>
    </div>

    <aside class="sidebar" id="sidebar">
        <div class="brand">
            <div class="logo-badge" style="width:36px;height:36px">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2l2.39 6.96H22l-5.45 3.96 2.1 6.96L12 16.9l-6.65 3.98 2.1-6.96L2 8.96h7.61z" fill="#FFD166"/>
                </svg>
            </div>
            <div style="margin-left:8px">Starnet💫</span></div>
        </div>
        <div style="height:10px"></div>
        
        <!-- Sidebar links (match original script menus) -->
        <div class="nav-link" data-page="dashboard" onclick="openPage('dashboard')">📊 Dashboard</div>
        <div class="nav-link" data-page="pasang" onclick="openPage('pasang')">🆕 Pasang Baru</div>
        <div class="nav-link" data-page="gangguan" onclick="openPage('gangguan')">⚠️ Gangguan</div>
        <div class="nav-link" data-page="pelanggan" onclick="openPage('pelanggan')">👥 Pelanggan</div>
        <div class="nav-link" data-page="billing" onclick="openPage('billing')">💳 Billing</div>
        <div class="nav-link" data-page="kas" onclick="openPage('kas')">💰 Kas</div>
        <div class="nav-link" data-page="odp" onclick="openPage('odp')">📌 ODP</div>
        <div class="nav-link" data-page="material" onclick="openPage('material')">📦 Material</div>
        <div class="nav-link" data-page="paket" onclick="openPage('paket')">📡 Paket</div>
        <div class="nav-link" data-page="mikrotik" onclick="openPage('mikrotik')">🛠️ Mikrotik</div>
        <div class="nav-link" data-page="shared" onclick="openPage('shared')">📤 Shared Orders</div>
        <div class="nav-link" data-page="history" onclick="openPage('history')">📜 History</div>
        <div class="nav-link" data-page="feedback" onclick="openPage('feedback')">💬 Feedback</div>
        <div class="nav-link" data-page="portal" onclick="openPage('portal')">🌐 Portal Pelanggan</div>
        <div class="nav-link" data-page="reports" onclick="openPage('reports')">📈 Reports</div>
        <div class="nav-link" data-page="users" onclick="openPage('users')">👤 User Management</div>
        
        <div style="margin-top:14px">
            <button id="btnAddUserOpen" class="btn btn-light btn-sm w-100">+ Tambah User</button>
        </div>
        <div style="margin-top:14px;color:#cfe3ff;font-size:13px">VSN4 — by Dnt Grup</div>
    </aside>
    
    <main class="main" id="mainContent" tabindex="0">
        <!-- DASHBOARD -->
        <section id="dashboard" class="card-modern">
            <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                    <h4 style="margin:0">Dashboard</h4>
                    <div class="small-muted">Ringkasan sistem</div>
                </div>
                <div><span id="kpiUser" class="badge bg-light text-dark"></span></div>
            </div>

            <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap">
                <div class="card-modern" style="flex:1;min-width:180px">
                    <div class="small-muted">Jumlah Pelanggan</div>
                    <div id="kpiPelanggan" style="font-weight:700;font-size:22px"></div>
                </div>
                <div class="card-modern" style="flex:1;min-width:180px">
                    <div class="small-muted">Gangguan Aktif</div>
                    <div id="kpiGangguan" style="font-weight:700;font-size:22px"></div>
                </div>
                <div class="card-modern" style="flex:1;min-width:180px">
                    <div class="small-muted">Pendapatan</div>
                    <div id="kpiPendapatan" style="font-weight:700;font-size:22px"></div>
                </div>
                <div class="card-modern" style="flex:1;min-width:180px">
                    <div class="small-muted">Kas</div>
                    <div id="kpiKas" style="font-weight:700;font-size:22px"></div>
                </div>
            </div>

            <div style="margin-top:16px" class="card-modern">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div><strong>Tren Bulanan</strong><div class="small-muted">Tagihan vs Pendapatan</div></div>
                    <div class="small-muted">Data realtime (lokal)</div>
                </div>
                <canvas id="chartMain" style="max-height:320px;margin-top:12px"></canvas>
            </div>

            <div style="margin-top:16px;display:flex;gap:16px;flex-wrap:wrap">
                <div class="card-modern" style="flex:1;min-width:300px">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div><strong>Gangguan per Bulan</strong></div>
                    </div>
                    <canvas id="chartGangguan" style="max-height:280px;margin-top:12px"></canvas>
                </div>
                <div class="card-modern" style="flex:1;min-width:300px">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div><strong>Status Koneksi ISP</strong></div>
                    </div>
                    <canvas id="chartKoneksi" style="max-height:280px;margin-top:12px"></canvas>
                </div>
            </div>
        </section>

        <!-- PASANG BARU -->
        <section id="page-pasang" class="card-modern hidden">
            <h4>Pasang Baru</h4>
            <div class="card-modern mb-2">
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                    <input id="p_inputer" class="form-control" placeholder="Inputer (otomatis username)" readonly style="max-width:220px">
                    <input id="p_nama" class="form-control" placeholder="Nama pelanggan">
                    <input id="p_alamat" class="form-control" placeholder="Alamat">
                    <input id="p_hp" class="form-control" type="number" placeholder="No HP" style="max-width:220px">
                    <input id="p_tgl_pasang" class="form-control" type="date" style="max-width:220px">
                    <input id="p_tagging" class="form-control" placeholder="Tagging Lokasi" style="max-width:220px">
                    <button type="button" class="btn btn-outline-secondary" onclick="setLocation()">Set Lokasi</button>
                    <select id="p_paket" class="form-control" style="max-width:240px"></select>
                    <button class="btn btn-primary" onclick="createPasang()">Daftar</button>
                </div>
                <div id="mapContainer" class="map-container hidden">
                    <div style="padding:10px;text-align:center;background:#f8f9fa;">
                        <div class="small-muted">Fitur maps akan diimplementasikan kemudian</div>
                        <button type="button" class="btn btn-sm btn-primary mt-2" onclick="document.getElementById('p_tagging').value = 'Lokasi: -6.123456, 106.789012'; document.getElementById('mapContainer').classList.add('hidden');">Simpan Koordinat</button>
                    </div>
                </div>
            </div>

            <div class="card-modern">
                <h6>Daftar Pasang</h6>
                <div style="overflow:auto">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>No Internet</th><th>Inputer</th><th>Nama</th><th>Alamat</th><th>Tagging</th><th>Paket</th>
                                <th>No HP</th><th>Status</th><th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tblPasang"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- GANGGUAN -->
        <section id="page-gangguan" class="card-modern hidden">
            <h4>Gangguan</h4>
            <div class="card-modern mb-2">
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                    <input id="g_noinet" class="form-control" placeholder="No Internet" style="max-width:220px" 
                           <?php echo $currentUser && $currentUser->role === 'pelanggan' ? 'readonly' : ''; ?>>
                    <input id="g_name" class="form-control" placeholder="Nama Pelanggan / Pelapor">
                    <input id="g_nohp" class="form-control" type="number" placeholder="No HP" style="max-width:220px">
                    <input id="g_alamat" class="form-control" placeholder="Alamat">
                    <input id="g_odp" class="form-control" placeholder="ODP" style="max-width:120px">
                    <select id="g_jenis" class="form-control" style="max-width:240px">
                        <option value="">-- Jenis Gangguan --</option>
                        <option>LOS Merah</option>
                        <option>Koneksi Lambat</option>
                        <option>Tidak Terhubung</option>
                        <option>Lainnya</option>
                    </select>
                    <select id="g_status" class="form-control" style="max-width:160px">
                        <option>Open</option>
                        <option>Progress</option>
                        <option>Pending</option>
                        <option>Close</option>
                    </select>
                    <input id="g_pending_until" class="form-control" type="datetime-local" placeholder="Jika Pending" style="max-width:220px">
                    <button class="btn btn-primary" onclick="createGangguan()">Buat Tiket</button>
                </div>
            </div>
            <div class="card-modern">
                <h6>Daftar Gangguan</h6>
                <div style="overflow:auto">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Tiket</th><th>No Internet</th><th>Pelapor</th><th>No HP</th><th>Alamat</th><th>ODP</th>
                                <th>Masalah</th><th>Status</th><th>TTR</th><th>Progres</th><th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tblGangguan"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- PELANGGAN -->
        <section id="page-pelanggan" class="card-modern hidden">
            <h4>Pelanggan</h4>
            <div class="mb-2" style="display:flex;gap:8px;flex-wrap:wrap">
                <input id="searchPelanggan" class="form-control" placeholder="Cari berdasarkan No Internet / SN / ODP" style="max-width:320px">
                <button class="btn btn-primary" onclick="searchPelanggan()">Cari</button>
            </div>
            <div class="card-modern">
                <div style="overflow:auto">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>No Internet</th><th>Nama</th><th>Status Koneksi</th><th>ODP</th><th>SN ONT</th>
                                <th>Tgl Pasang</th><th>Durasi</th><th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tblPelanggan"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- BILLING -->
        <section id="page-billing" class="card-modern hidden">
            <h4>Billing</h4>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
                <input id="searchBilling" class="form-control" placeholder="Search by No Internet / SN ONT" style="max-width:320px">
                <button class="btn btn-primary" onclick="searchBilling()">Cari</button>
                <button class="btn btn-secondary" onclick="bulkGenerateBilling()">Bulk</button>
                <button class="btn btn-success" onclick="generateForSelected()">Selected</button>
            </div>
            <div class="card-modern mt-2">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th><input type="checkbox" onchange="toggleAllBills(this)"></th>
                            <th>No Internet</th><th>Pelanggan</th><th>Periode</th><th>Jumlah</th>
                            <th>Status</th><th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tblBilling"></tbody>
                </table>
            </div>
        </section>

        <!-- KAS -->
        <section id="page-kas" class="card-modern hidden">
            <h4>Kas</h4>
            <div class="card-modern mb-2">
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                    <input id="kas_tanggal" class="form-control" type="date" style="max-width:180px">
                    <input id="kas_desc" class="form-control" placeholder="Deskripsi" style="max-width:320px">
                    <input id="kas_qty" class="form-control" type="number" placeholder="Qty" style="max-width:120px">
                    <input id="kas_satuan" class="form-control" placeholder="Satuan" style="max-width:120px">
                    <input id="kas_masuk" class="form-control" placeholder="Masuk (angka)" style="max-width:180px">
                    <input id="kas_keluar" class="form-control" placeholder="Keluar (angka)" style="max-width:180px">
                    <button class="btn btn-primary" onclick="addKas()">Tambah</button>
                </div>
            </div>
            <div class="card-modern mt-2">
                <table class="table table-sm">
                    <thead>
                        <tr><th>No</th><th>Tanggal</th><th>Deskripsi</th><th>Qty</th><th>Satuan</th><th>Masuk</th><th>Keluar</th><th>Saldo</th></tr>
                    </thead>
                    <tbody id="tblKas"></tbody>
                </table>
            </div>
        </section>

        <!-- ODP -->
        <section id="page-odp" class="card-modern hidden">
            <h4>ODP</h4>
            <div class="card-modern mb-2">
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                    <input id="odp_name" class="form-control" placeholder="NAMA ODP" style="max-width:220px">
                    <input id="odp_kapasitas" class="form-control" placeholder="KAPASITAS" style="max-width:160px">
                    <input id="odp_distribusi" class="form-control" placeholder="DISTRIBUSI" style="max-width:220px">
                    <input id="odp_feeder" class="form-control" placeholder="FEEDER" style="max-width:220px">
                    <input id="odp_tagging" class="form-control" placeholder="TAGGING LOKASI" style="max-width:220px">
                    <button class="btn btn-primary" onclick="createODP()">Tambah</button>
                </div>
            </div>
            <div class="card-modern mt-2">
                <table class="table table-sm">
                    <thead>
                        <tr><th>Nama ODP</th><th>Kapasitas</th><th>Distribusi</th><th>Feeder</th><th>Tagging</th><th>Aksi</th></tr>
                    </thead>
                    <tbody id="tblODP"></tbody>
                </table>
            </div>
        </section>

        <!-- MATERIAL -->
        <section id="page-material" class="card-modern hidden">
            <h4>Material</h4>
            <div class="card-modern mb-2">
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                    <input id="m_jenis" class="form-control" placeholder="Jenis" style="max-width:260px">
                    <input id="m_qty" class="form-control" type="number" placeholder="Qty" style="max-width:120px">
                    <select id="m_satuan" class="form-control" style="max-width:120px">
                        <option>mt</option><option>pcs</option><option>roll</option>
                    </select>
                    <button class="btn btn-primary" onclick="createMaterial()">Tambah</button>
                </div>
            </div>
            <div class="card-modern mt-2">
                <table class="table table-sm">
                    <thead>
                        <tr><th>Jenis</th><th>Qty</th><th>Satuan</th><th>Aksi</th></tr>
                    </thead>
                    <tbody id="tblMaterial"></tbody>
                </table>
            </div>
        </section>

        <!-- PAKET -->
        <section id="page-paket" class="card-modern hidden">
            <h4>Paket</h4>
            <div class="card-modern mb-2">
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                    <input id="pkg_name" class="form-control" placeholder="Nama Paket" style="max-width:260px">
                    <input id="pkg_bandwidth" class="form-control" placeholder="Bandwidth (Mbps)" style="max-width:160px">
                    <input id="pkg_price" class="form-control" placeholder="Harga" style="max-width:160px">
                    <input id="pkg_desc" class="form-control" placeholder="Deskripsi Paket">
                    <button class="btn btn-primary" onclick="createPaket()">Tambah Paket</button>
                </div>
            </div>
            <div class="card-modern mt-2">
                <table class="table table-sm">
                    <thead>
                        <tr><th>Nama</th><th>Bandwidth</th><th>Harga</th><th>Deskripsi</th><th>Aksi</th></tr>
                    </thead>
                    <tbody id="tblPaket"></tbody>
                </table>
            </div>
        </section>

        <!-- MIKROTIK -->
        <section id="page-mikrotik" class="card-modern hidden">
            <h4>Mikrotik</h4>
            <div class="card-modern mb-2">
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                    <input id="mk_name" class="form-control" placeholder="Nama Perangkat" style="max-width:260px">
                    <input id="mk_ip" class="form-control" placeholder="IP/Hostname" style="max-width:160px">
                    <button class="btn btn-primary" onclick="createMikrotik()">Tambah</button>
                </div>
            </div>
            <div class="card-modern mt-2">
                <table class="table table-sm">
                    <thead>
                        <tr><th>Nama</th><th>IP</th><th>Aksi</th></tr>
                    </thead>
                    <tbody id="tblMikrotik"></tbody>
                </table>
            </div>
        </section>

        <!-- SHARED ORDERS -->
        <section id="page-shared" class="card-modern hidden">
            <h4>Shared Orders (Simulasi WA)</h4>
            <div id="sharedOrdersList" class="small-muted"></div>
        </section>

        <!-- HISTORY -->
        <section id="page-history" class="card-modern hidden">
            <h4>History</h4>
            <div id="historyList" class="small-muted"></div>
        </section>

        <!-- FEEDBACK -->
        <section id="page-feedback" class="card-modern hidden">
            <h4>Feedback</h4>
            <div id="feedbackList" class="small-muted"></div>
        </section>

        <!-- USERS -->
        <section id="page-users" class="card-modern hidden">
            <h4>User Management</h4>
            <div style="margin-bottom:8px">
                <button class="btn btn-primary" onclick="openAddUserModal()">+ Tambah User</button>
            </div>
            <div class="card-modern mt-2">
                <table class="table table-sm">
                    <thead>
                        <tr><th>NIK</th><th>Nama</th><th>Email</th><th>No WA</th><th>Telegram</th><th>Role</th><th>Aksi</th></tr>
                    </thead>
                    <tbody id="tblUsers"></tbody>
                </table>
            </div>
        </section>

        <!-- PORTAL -->
        <section id="page-portal" class="card-modern hidden">
            <h4>Portal Pelanggan</h4>
            <div class="card-modern">
                <div id="portalInfo" class="small-muted">Hanya menampilkan gangguan & billing milik pelanggan.</div>
                
                <div style="margin-top:20px;padding:15px;background:#f8f9fa;border-radius:8px;">
                    <h5>Lapor Gangguan</h5>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
                        <input id="portal_no_inet" class="form-control" placeholder="No Internet" style="max-width:200px" readonly>
                        <input id="portal_nama" class="form-control" placeholder="Nama Pelapor" style="max-width:200px">
                        <select id="portal_jenis_gangguan" class="form-control" style="max-width:200px">
                            <option value="">-- Jenis Gangguan --</option>
                            <option>LOS Merah</option>
                            <option>Koneksi Lambat</option>
                            <option>Tidak Terhubung</option>
                            <option>Lainnya</option>
                        </select>
                        <textarea id="portal_deskripsi" class="form-control" placeholder="Deskripsi Gangguan" rows="2"></textarea>
                        <button class="btn btn-primary" onclick="laporkanGangguan()">Laporkan</button>
                    </div>
                </div>
                
                <div style="margin-top:20px">
                    <h6>Tagihan (10 terakhir)</h6>
                    <div id="portalBillingList"></div>
                    
                    <h6 class="mt-4">Gangguan (10 terakhir)</h6>
                    <div id="portalGangguanList"></div>
                    
                    <div style="margin-top:20px;display:flex;justify-content:center;align-items:center;gap:10px">
                        <button class="btn btn-outline-secondary" onclick="portalPrev()">←</button>
                        <span id="portalPage" style="padding:8px">1</span>
                        <button class="btn btn-outline-secondary" onclick="portalNext()">→</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- REPORTS -->
        <section id="page-reports" class="card-modern hidden">
            <h4>Reports</h4>
            <div class="card-modern">
                <button class="btn btn-outline-secondary" onclick="exportCSV()">Export CSV (Pelanggan/Billing)</button>
            </div>
            <div class="card-modern mt-2">
                <div id="reportContent" class="small-muted"></div>
            </div>
        </section>
    </main>
</div>

<!-- MODALS -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Tambah User Baru</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="mb-2">
                        <label class="form-label">NIK</label>
                        <input id="u_nik" class="form-control" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Nama</label>
                        <input id="u_nama" class="form-control" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Email</label>
                        <input id="u_email" class="form-control" type="email" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">No WhatsApp</label>
                        <input id="u_wa" class="form-control" type="number" placeholder="628xxxx">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">ID Telegram</label>
                        <input id="u_telegram" class="form-control" placeholder="@username">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Password</label>
                        <input id="u_password" class="form-control" type="password" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Role</label>
                        <select id="u_role" class="form-control">
                            <option value="admin">Admin</option>
                            <option value="teknisi">Teknisi</option>
                            <option value="cs">CS</option>
                            <option value="pelanggan">Pelanggan</option>
                        </select>
                    </div>
                    <div id="userFormMsg" class="small-muted"></div>
                    <div style="text-align:right">
                        <button type="submit" class="btn btn-primary">Buat User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Material Update -->
<div class="modal fade" id="materialModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Material</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <label class="form-label">Jumlah ONT (pcs)</label>
                    <input id="mat_ont" class="form-control" type="number" value="1">
                </div>
                <div class="mb-2">
                    <label class="form-label">Kabel (meter)</label>
                    <input id="mat_kabel" class="form-control" type="number" value="10">
                </div>
                <div class="mb-2">
                    <label class="form-label">PS (pcs)</label>
                    <input id="mat_ps" class="form-control" type="number" value="1">
                </div>
                <div class="mb-2">
                    <label class="form-label">PC (pcs)</label>
                    <input id="mat_pc" class="form-control" type="number" value="0">
                </div>
                <div class="mb-2">
                    <label class="form-label">Adaptor (pcs)</label>
                    <input id="mat_adaptor" class="form-control" type="number" value="1">
                </div>
                <div id="materialFormMsg" class="small-muted"></div>
                <div style="text-align:right;margin-top:15px">
                    <button type="button" class="btn btn-primary" onclick="submitMaterialUpdate()">Simpan</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Share Options -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Kirim Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Pilih Metode Pengiriman</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="shareMethod" id="shareWA" value="wa" checked>
                        <label class="form-check-label" for="shareWA">WhatsApp</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="shareMethod" id="shareTelegram" value="telegram">
                        <label class="form-check-label" for="shareTelegram">Telegram</label>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Pilih Teknisi</label>
                    <select id="teknisiSelect" class="form-control"></select>
                </div>
                <div id="shareFormMsg" class="small-muted"></div>
                <div style="text-align:right">
                    <button type="button" class="btn btn-primary" onclick="sendOrder()">Kirim</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- toast -->
<div id="toast" style="position:fixed;right:18px;bottom:18px;background:#111;color:#fff;padding:8px 12px;border-radius:8px;z-index:9999;display:none"></div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ================================
Local DB + helpers (source of truth: localStorage)
================================ */
const LS_KEY = 'starnet_v1_db';
const LS_SESSION = 'starnet_v1_session';

function defaultDB(){
    return {
        users: {
            'admin': { 
                nik:'admin', 
                nama:'Admin', 
                password:'admin', 
                role:'admin', 
                email:'admin@starnet.id',
                wa: '628123456789',
                telegram: '@adminstarnet'
            },
            'teknisi': { 
                nik:'teknisi', 
                nama:'Teknisi', 
                password:'1234', 
                role:'teknisi', 
                email:'teknisi@starnet.id',
                wa: '628987654321',
                telegram: '@teknisi'
            }
        },
        paket: {
            'pkg1': { id: 'pkg1', name: 'Home 10Mbps', bandwidth: '10', price: 120000, desc: 'Paket rumahan 10Mbps' },
            'pkg2': { id: 'pkg2', name: 'Pro 30Mbps', bandwidth: '30', price: 250000, desc: 'Paket profesional 30Mbps' }
        }, 
        pelanggan: {}, 
        pasang: {}, 
        gangguan: {}, 
        billing: {}, 
        kas: {}, 
        odp: {}, 
        material: {},
        mikrotik: {}, 
        sharedOrders: {},
        history: [],
        feedback: [],
        tiketCounter: 1
    };
}

function loadDB(){ 
    try{ 
        const raw = localStorage.getItem(LS_KEY); 
        if(!raw){ 
            const d = defaultDB(); 
            localStorage.setItem(LS_KEY, JSON.stringify(d)); 
            return d; 
        } 
        const db = JSON.parse(raw);
        // Initialize tiketCounter if not exists
        if (!db.tiketCounter) db.tiketCounter = 1;
        return db;
    }catch(e){ 
        const d = defaultDB(); 
        localStorage.setItem(LS_KEY, JSON.stringify(d)); 
        return d; 
    } 
}

function saveDB(db){ 
    localStorage.setItem(LS_KEY, JSON.stringify(db)); 
    DB = db; 
}

let DB = loadDB();

function uid(prefix='id'){ 
    return prefix + Date.now().toString(36) + Math.random().toString(36).slice(2,6); 
}

function now(){ 
    return new Date().toISOString(); 
}

function toast(msg, t=2400){ 
    const el = document.getElementById('toast'); 
    el.innerText = msg;
    el.style.display = 'block'; 
    setTimeout(() => el.style.display = 'none', t); 
    console.log('TOAST:', msg); 
}

function escapeHtml(s){ 
    if(s == undefined || s == null) return ''; 
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); 
}

function hist(type, item, desc){ 
    DB.history.unshift({ ts: now(), type, item, desc });
    if(DB.history.length > 1000) DB.history.length = 1000; 
    saveDB(DB); 
}

/* ===============================
Session management (FIXED: session persists on refresh)
================================ */
function saveSession(user){ 
    localStorage.setItem(LS_SESSION, JSON.stringify(user)); 
}

function loadSession(){ 
    try{ 
        const s = localStorage.getItem(LS_SESSION); 
        return s ? JSON.parse(s) : null; 
    }catch(e){ 
        return null; 
    } 
}

function clearSession(){ 
    localStorage.removeItem(LS_SESSION); 
}

let currentUser = null;
let currentShareId = null;

function checkSession(){ 
    currentUser = loadSession(); 
    if(currentUser){ 
        document.getElementById('loginRoot').classList.add('hidden'); 
        document.getElementById('appShell').classList.remove('hidden'); 
        document.getElementById('whoami').innerText = currentUser.nama + ' (' + currentUser.role + ')'; 
        document.getElementById('btnLogout').style.display = 'block';
        document.getElementById('p_inputer').value = currentUser.nama;
        
        // Auto-fill portal fields for pelanggan
        if(currentUser.role === 'pelanggan') {
            document.getElementById('portal_no_inet').value = currentUser.noInternet || '';
            document.getElementById('portal_nama').value = currentUser.nama || '';
            document.getElementById('g_noinet').value = currentUser.noInternet || '';
            document.getElementById('g_name').value = currentUser.nama || '';
        }
        
        updateTime();
        loadDashboard();
        openPage('dashboard');
    }else{ 
        document.getElementById('loginRoot').classList.remove('hidden'); 
        document.getElementById('appShell').classList.add('hidden'); 
        document.getElementById('btnLogout').style.display = 'none';
    } 
}

/* ===============================
Login & Auth
================================ */
document.getElementById('btnDemo').addEventListener('click', (e) => { 
    e.preventDefault(); 
    document.getElementById('username').value = 'admin'; 
    document.getElementById('password').value = 'admin'; 
});

document.getElementById('btnSelfTest').addEventListener('click', (e) => { 
    e.preventDefault(); 
    runSelfTest();
});

document.getElementById('btnResetDB').addEventListener('click', (e) => { 
    e.preventDefault(); 
    if(confirm('Reset semua data? Ini akan menghapus semua data kecuali user admin dan teknisi.')){ 
        const d = defaultDB(); 
        localStorage.setItem(LS_KEY, JSON.stringify(d)); 
        DB = d; 
        toast('DB reset selesai'); 
        location.reload();
    } 
});

document.getElementById('loginForm').addEventListener('submit', (e) => { 
    e.preventDefault(); 
    const nik = document.getElementById('username').value.trim(); 
    const pass = document.getElementById('password').value; 
    const msg = document.getElementById('loginMsg'); 
    msg.innerText = ''; 
    
    if(!nik || !pass){ 
        msg.innerText = 'NIK dan password harus diisi'; 
        return; 
    } 
    
    // Check users
    const user = DB.users[nik]; 
    if(user && user.password === pass){ 
        saveSession(user); 
        checkSession(); 
        toast(`Login berhasil, selamat datang ${user.nama}`); 
        return;
    }
    
    // Check pelanggan
    const pelanggan = Object.values(DB.pelanggan).find(p => p.noInternet === nik);
    if(pelanggan && pelanggan.password === pass) {
        const userData = {
            nik: pelanggan.noInternet,
            nama: pelanggan.nama,
            role: 'pelanggan',
            noInternet: pelanggan.noInternet
        };
        saveSession(userData);
        checkSession();
        toast(`Login berhasil, selamat datang ${pelanggan.nama}`);
        return;
    }
    
    msg.innerText = 'NIK atau password salah'; 
});

document.getElementById('btnLogout').addEventListener('click', () => { 
    clearSession(); 
    checkSession(); 
    toast('Anda telah logout'); 
});

/* ===============================
UI & Navigation
================================ */
function updateTime(){ 
    const el = document.getElementById('timeNow'); 
    if(el){ 
        const d = new Date(); 
        el.innerText = d.toLocaleString('id-ID'); 
    } 
}

setInterval(updateTime, 1000);

function openPage(pageId){ 
    document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active')); 
    const activeLink = document.querySelector(`.nav-link[data-page="${pageId}"]`);
    if(activeLink) activeLink.classList.add('active');
    
    document.querySelectorAll('section').forEach(s => s.classList.add('hidden')); 
    
    // Handle mobile view - close sidebar when a page is selected
    if(window.innerWidth <= 1000) {
        document.getElementById('sidebar').classList.remove('show');
    }
    
    if(pageId === 'dashboard') {
        document.getElementById('dashboard').classList.remove('hidden');
        loadDashboard();
    } else {
        const pageElement = document.getElementById(`page-${pageId}`);
        if(pageElement) {
            pageElement.classList.remove('hidden');
            // Load page-specific data
            switch(pageId) {
                case 'pasang': loadPasang(); break;
                case 'gangguan': loadGangguan(); break;
                case 'pelanggan': loadPelanggan(); break;
                case 'billing': loadBilling(); break;
                case 'kas': loadKas(); break;
                case 'odp': loadODP(); break;
                case 'material': loadMaterial(); break;
                case 'paket': loadPaket(); break;
                case 'mikrotik': loadMikrotik(); break;
                case 'shared': loadSharedOrders(); break;
                case 'history': loadHistory(); break;
                case 'feedback': loadFeedback(); break;
                case 'portal': loadPortal(); break;
                case 'reports': loadReports(); break;
                case 'users': loadUsers(); break;
            }
        }
    }
    
    window.scrollTo(0,0); 
}

document.getElementById('hambBtn').addEventListener('click', () => { 
    document.getElementById('sidebar').classList.toggle('show'); 
});

/* ===============================
Dashboard
================================ */
function loadDashboard(){ 
    const pelanggan = Object.keys(DB.pelanggan).length; 
    const gangguan = Object.values(DB.gangguan).filter(g => g.status !== 'Close').length; 
    const pendapatan = Object.values(DB.billing).filter(b => b.status === 'Lunas').reduce((a,b) => a + (b.jumlah || 0), 0); 
    const kas = Object.values(DB.kas).reduce((a, b) => a + (b.masuk || 0) - (b.keluar || 0), 0); 
    
    document.getElementById('kpiUser').innerText = currentUser.role; 
    document.getElementById('kpiPelanggan').innerText = pelanggan; 
    document.getElementById('kpiGangguan').innerText = gangguan; 
    document.getElementById('kpiPendapatan').innerText = 'Rp '+pendapatan.toLocaleString('id-ID'); 
    document.getElementById('kpiKas').innerText = 'Rp '+kas.toLocaleString('id-ID'); 
    
    renderCharts(); 
}

function renderCharts(){ 
    // Chart 1: Tren Bulanan
    const ctx1 = document.getElementById('chartMain'); 
    if(ctx1) {
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
        const currentMonth = new Date().getMonth();
        const billData = Array(12).fill(0).map((_, i) => Math.floor(Math.random() * 20) + 5);
        const incomeData = billData.map(val => val * 150000);
        
        if(window.mainChart) window.mainChart.destroy();
        window.mainChart = new Chart(ctx1, { 
            type: 'bar', 
            data: { 
                labels: months, 
                datasets: [
                    { 
                        label: 'Jumlah Tagihan', 
                        data: billData, 
                        backgroundColor: '#3b82f6',
                        borderRadius: 6,
                        barThickness: 18
                    },
                    { 
                        label: 'Pendapatan (Rp)', 
                        data: incomeData, 
                        type: 'line',
                        borderColor: '#10b981',
                        tension: 0.3,
                        pointRadius: 4
                    }
                ]
            }, 
            options: { 
                responsive: true, 
                plugins: { 
                    legend: { display: true, position: 'top' }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Jumlah Tagihan'
                        }
                    },
                    y1: {
                        position: 'right',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Pendapatan (Rp)'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            } 
        });
    }
    
    // Chart 2: Gangguan per Bulan
    const ctx2 = document.getElementById('chartGangguan');
    if(ctx2) {
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
        const gangguanData = Array(12).fill(0).map((_, i) => Math.floor(Math.random() * 15) + 3);
        
        if(window.gangguanChart) window.gangguanChart.destroy();
        window.gangguanChart = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [{
                    label: 'Jumlah Gangguan',
                    data: gangguanData,
                    backgroundColor: '#ef4444',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Chart 3: Status Koneksi ISP
    const ctx3 = document.getElementById('chartKoneksi');
    if(ctx3) {
        const statusData = [75, 15, 7, 3]; // Aktif, Gangguan, Pending, Non-aktif
        
        if(window.koneksiChart) window.koneksiChart.destroy();
        window.koneksiChart = new Chart(ctx3, {
            type: 'doughnut',
            data: {
                labels: ['Aktif', 'Gangguan', 'Pending', 'Non-aktif'],
                datasets: [{
                    data: statusData,
                    backgroundColor: ['#10b981', '#ef4444', '#f59e0b', '#6b7280']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
}

/* ===============================
Pasang Baru
================================ */
function setLocation() {
    const mapContainer = document.getElementById('mapContainer');
    mapContainer.classList.toggle('hidden');
    toast('Fitur maps akan diimplementasikan lengkap dengan API');
}

function createPasang(){ 
    const nama = document.getElementById('p_nama').value; 
    const alamat = document.getElementById('p_alamat').value; 
    const hp = document.getElementById('p_hp').value; 
    const tglPasang = document.getElementById('p_tgl_pasang').value;
    const tagging = document.getElementById('p_tagging').value; 
    const paket = document.getElementById('p_paket').value; 
    
    if(!nama || !alamat || !hp){ 
        toast('Nama, alamat, dan no HP harus diisi'); 
        return; 
    } 
    
    const id = uid('pasang_'); 
    const noInternet = generateNoInternet();
    
    DB.pasang[id] = { 
        id, 
        noInternet,
        inputer: currentUser.nik, 
        nama, 
        alamat, 
        hp, 
        tglPasang: tglPasang || now(),
        tagging, 
        paket, 
        status: 'Menunggu',
        created: now() 
    }; 
    
    saveDB(DB); 
    hist('pasang', id, `Pasang baru: ${nama}`); 
    toast('Data pasang baru berhasil disimpan'); 
    loadPasang(); 
    
    // Reset form
    document.getElementById('p_nama').value = '';
    document.getElementById('p_alamat').value = '';
    document.getElementById('p_hp').value = '';
    document.getElementById('p_tagging').value = '';
}

function generateNoInternet() {
    const year = new Date().getFullYear().toString().substr(2);
    const month = (new Date().getMonth() + 1).toString().padStart(2, '0');
    const count = Object.keys(DB.pasang).length + 1;
    return `${year}${month}${count.toString().padStart(4, '0')}`;
}

function loadPasang(){ 
    const tbl = document.getElementById('tblPasang'); 
    if(!tbl) return; 
    
    // Populate paket dropdown
    const paketSelect = document.getElementById('p_paket');
    paketSelect.innerHTML = '<option value="">-- Pilih Paket --</option>';
    Object.values(DB.paket).forEach(p => {
        const option = document.createElement('option');
        option.value = p.id;
        option.textContent = `${p.name} - Rp ${p.price.toLocaleString('id-ID')}`;
        paketSelect.appendChild(option);
    });
    
    tbl.innerHTML = ''; 
    Object.values(DB.pasang).forEach(p => { 
        const paketInfo = DB.paket[p.paket] ? `${DB.paket[p.paket].name}` : 'Tidak diketahui';
        const statusClass = getStatusClass(p.status);
        
        const tr = document.createElement('tr'); 
        tr.innerHTML = ` 
            <td>${escapeHtml(p.noInternet)}</td> 
            <td>${escapeHtml(p.inputer)}</td> 
            <td>${escapeHtml(p.nama)}</td> 
            <td>${escapeHtml(p.alamat)}</td> 
            <td>${escapeHtml(p.tagging)}</td> 
            <td>${escapeHtml(paketInfo)}</td> 
            <td>${escapeHtml(p.hp)}</td> 
            <td><span class="badge ${statusClass}">${escapeHtml(p.status)}</span></td> 
            <td> 
                ${p.status === 'Menunggu' ? 
                    `<button class="btn btn-xs btn-primary" onclick="openShareModal('pasang', '${p.id}')">Order ke Teknisi</button>` : 
                p.status === 'Menunggu Konfirmasi' ? 
                    `<span class="badge bg-warning">Menunggu Konfirmasi</span>` :
                p.status === 'Progres' ? 
                    `<button class="btn btn-xs btn-success" onclick="openMaterialModal('${p.id}')">Update Material</button>` :
                p.status === 'Aktif' ? 
                    `<span class="badge bg-success">Aktif</span>` : ''}
            </td> 
        `; 
        tbl.appendChild(tr); 
    }); 
}

function getStatusClass(status) {
    switch(status) {
        case 'Menunggu': return 'bg-secondary';
        case 'Menunggu Konfirmasi': return 'bg-warning';
        case 'Progres': return 'bg-info';
        case 'Aktif': return 'bg-success';
        case 'Ditolak': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

function openShareModal(type, id) {
    currentShareId = id;
    
    // Populate teknisi dropdown
    const teknisiSelect = document.getElementById('teknisiSelect');
    teknisiSelect.innerHTML = '';
    
    Object.values(DB.users)
        .filter(u => u.role === 'teknisi')
        .forEach(tek => {
            const option = document.createElement('option');
            option.value = tek.nik;
            option.textContent = `${tek.nama} (WA: ${tek.wa}, Telegram: ${tek.telegram})`;
            teknisiSelect.appendChild(option);
        });
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('shareModal'));
    modal.show();
}

function sendOrder() {
    if (!currentShareId) return;
    
    const shareMethod = document.querySelector('input[name="shareMethod"]:checked').value;
    const teknisiNik = document.getElementById('teknisiSelect').value;
    const teknisi = DB.users[teknisiNik];
    
    if (!teknisi) {
        document.getElementById('shareFormMsg').innerText = 'Pilih teknisi terlebih dahulu';
        return;
    }
    
    const order = DB.pasang[currentShareId];
    if (!order) {
        toast('Order tidak ditemukan');
        return;
    }
    
    // Update status order
    order.status = 'Menunggu Konfirmasi';
    order.teknisi = teknisiNik;
    order.orderTime = now();
    
    // Create shared order record
    const shareId = uid('share_');
    DB.sharedOrders[shareId] = {
        id: shareId,
        type: 'pasang',
        orderId: currentShareId,
        teknisi: teknisiNik,
        status: 'pending',
        method: shareMethod,
        created: now()
    };
    
    saveDB(DB);
    
    // Show success message
    toast(`Order berhasil dikirim ke ${teknisi.nama} via ${shareMethod === 'wa' ? 'WhatsApp' : 'Telegram'}`);
    
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('shareModal')).hide();
    
    // Reload data
    loadPasang();
}

function openMaterialModal(pasangId) {
    currentShareId = pasangId;
    const modal = new bootstrap.Modal(document.getElementById('materialModal'));
    modal.show();
}

function submitMaterialUpdate() {
    if (!currentShareId) return;
    
    const ont = document.getElementById('mat_ont').value;
    const kabel = document.getElementById('mat_kabel').value;
    const ps = document.getElementById('mat_ps').value;
    const pc = document.getElementById('mat_pc').value;
    const adaptor = document.getElementById('mat_adaptor').value;
    
    const order = DB.pasang[currentShareId];
    if (order) {
        order.status = 'Aktif';
        order.material = { ont, kabel, ps, pc, adaptor };
        order.installTime = now();
        
        // Create pelanggan from order
        const pelangganId = uid('pel_');
        DB.pelanggan[pelangganId] = {
            id: pelangganId,
            noInternet: order.noInternet,
            nama: order.nama,
            alamat: order.alamat,
            hp: order.hp,
            paket: order.paket,
            odp: order.tagging,
            status: 'Aktif',
            tglPasang: order.tglPasang,
            created: now()
        };
        
        saveDB(DB);
        toast('Material berhasil diupdate dan pelanggan diaktifkan');
        
        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('materialModal')).hide();
        
        // Reload data
        loadPasang();
        loadPelanggan();
    }
}

/* ===============================
Gangguan
================================ */
function createGangguan(){ 
    const noinet = document.getElementById('g_noinet').value; 
    const name = document.getElementById('g_name').value; 
    const nohp = document.getElementById('g_nohp').value; 
    const alamat = document.getElementById('g_alamat').value; 
    const odp = document.getElementById('g_odp').value;
    const jenis = document.getElementById('g_jenis').value; 
    const status = 'Open'; // Status selalu Open ketika dibuat
    const pending_until = document.getElementById('g_pending_until').value; 
    
    if(!noinet || !name || !jenis){ 
        toast('No Internet, nama, dan jenis gangguan harus diisi'); 
        return; 
    } 
    
    // Generate ticket number
    const tiketNumber = `TC${DB.tiketCounter.toString().padStart(4, '0')}`;
    DB.tiketCounter++;
    
    const id = uid('tkt_'); 
    DB.gangguan[id] = { 
        id,
        tiket: tiketNumber,
        noInternet: noinet, 
        nama: name, 
        nohp, 
        alamat, 
        odp,
        jenis, 
        status, 
        ttr: '0 jam', // Akan dihitung otomatis
        pending_until: pending_until || null, 
        created: now(), 
        updated: now(),
        progres: 'Menunggu Konfirmasi'
    }; 
    
    saveDB(DB); 
    hist('gangguan', id, `Gangguan baru: ${name} (${jenis})`); 
    toast('Tiket gangguan berhasil dibuat'); 
    loadGangguan(); 
    
    // Reset form
    document.getElementById('g_noinet').value = '';
    document.getElementById('g_name').value = '';
    document.getElementById('g_nohp').value = '';
    document.getElementById('g_alamat').value = '';
    document.getElementById('g_odp').value = '';
    document.getElementById('g_jenis').value = '';
    document.getElementById('g_pending_until').value = '';
}

function loadGangguan(){ 
    const tbl = document.getElementById('tblGangguan'); 
    if(!tbl) return; 
    
    tbl.innerHTML = ''; 
    Object.values(DB.gangguan).forEach(g => { 
        // Calculate TTR
        const created = new Date(g.created);
        const now = new Date();
        const diffMs = now - created;
        const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
        const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
        
        let ttr = `${diffHrs} jam ${diffMins} menit`;
        if (g.status === 'Close') {
            const closed = new Date(g.closed || g.updated);
            const resolvedMs = closed - created;
            const resolvedHrs = Math.floor(resolvedMs / (1000 * 60 * 60));
            const resolvedMins = Math.floor((resolvedMs % (1000 * 60 * 60)) / (1000 * 60));
            ttr = `${resolvedHrs} jam ${resolvedMins} menit`;
        }
        
        const statusClass = getGangguanStatusClass(g.status);
        const progresClass = getProgresStatusClass(g.progres);
        
        const tr = document.createElement('tr'); 
        tr.innerHTML = ` 
            <td>${escapeHtml(g.tiket)}</td>
            <td>${escapeHtml(g.noInternet)}</td> 
            <td>${escapeHtml(g.nama)}</td> 
            <td>${escapeHtml(g.nohp || '-')}</td> 
            <td>${escapeHtml(g.alamat)}</td> 
            <td>${escapeHtml(g.odp || '-')}</td> 
            <td>${escapeHtml(g.jenis)}</td> 
            <td><span class="badge ${statusClass}">${escapeHtml(g.status)}</span></td> 
            <td>${ttr}</td>
            <td><span class="badge ${progresClass}">${escapeHtml(g.progres || 'Menunggu')}</span></td>
            <td> 
                ${g.status === 'Open' ? 
                    `<button class="btn btn-xs btn-primary" onclick="openShareModal('gangguan', '${g.id}')">Kirim Order</button>` : 
                g.progres === 'Menunggu Konfirmasi' ? 
                    `<button class="btn btn-xs btn-warning" onclick="confirmGangguan('${g.id}')">Konfirmasi</button>` :
                g.progres === 'Terkonfirmasi' ? 
                    `<button class="btn btn-xs btn-info" onclick="startProgress('${g.id}')">Mulai Progres</button>` :
                g.progres === 'Progres' ? 
                    `<button class="btn btn-xs btn-success" onclick="finishProgress('${g.id}')">Selesai</button>` : ''}
                
                <button class="btn btn-xs btn-danger" onclick="deleteGangguan('${g.id}')">Hapus</button>
            </td> 
        `; 
        tbl.appendChild(tr); 
    }); 
}

function getGangguanStatusClass(status) {
    switch(status) {
        case 'Open': return 'bg-danger';
        case 'Progress': return 'bg-warning';
        case 'Pending': return 'bg-info';
        case 'Close': return 'bg-success';
        default: return 'bg-secondary';
    }
}

function getProgresStatusClass(progres) {
    switch(progres) {
        case 'Menunggu Konfirmasi': return 'bg-warning';
        case 'Terkonfirmasi': return 'bg-info';
        case 'Progres': return 'bg-primary';
        case 'Selesai': return 'bg-success';
        default: return 'bg-secondary';
    }
}

function confirmGangguan(id) {
    const gangguan = DB.gangguan[id];
    if (gangguan) {
        gangguan.progres = 'Terkonfirmasi';
        gangguan.updated = now();
        saveDB(DB);
        loadGangguan();
        toast('Gangguan telah dikonfirmasi');
    }
}

function startProgress(id) {
    const gangguan = DB.gangguan[id];
    if (gangguan) {
        gangguan.progres = 'Progres';
        gangguan.status = 'Progress';
        gangguan.updated = now();
        saveDB(DB);
        loadGangguan();
        toast('Progres gangguan telah dimulai');
    }
}

function finishProgress(id) {
    const gangguan = DB.gangguan[id];
    if (gangguan) {
        gangguan.progres = 'Selesai';
        gangguan.status = 'Close';
        gangguan.closed = now();
        gangguan.updated = now();
        saveDB(DB);
        loadGangguan();
        toast('Gangguan telah selesai diperbaiki');
    }
}

function deleteGangguan(id){ 
    if(confirm('Hapus tiket gangguan ini?')){ 
        delete DB.gangguan[id]; 
        saveDB(DB); 
        hist('gangguan', id, 'Dihapus'); 
        toast('Tiket dihapus'); 
        loadGangguan(); 
    } 
}

/* ===============================
Pelanggan
================================ */
function loadPelanggan(){ 
    const tbl = document.getElementById('tblPelanggan'); 
    if(!tbl) return; 
    
    tbl.innerHTML = ''; 
    Object.values(DB.pelanggan).forEach(p => { 
        const tr = document.createElement('tr'); 
        tr.innerHTML = ` 
            <td>${escapeHtml(p.noInternet)}</td> 
            <td>${escapeHtml(p.nama)}</td> 
            <td><span class="badge bg-success">${escapeHtml(p.status)}</span></td> 
            <td>${escapeHtml(p.odp || '-')}</td> 
            <td>${escapeHtml(p.snOnt || '-')}</td> 
            <td>${escapeHtml(formatDate(p.tglPasang))}</td> 
            <td>${escapeHtml(dayDiff(p.tglPasang))} hari</td> 
            <td> 
                <button class="btn btn-xs btn-primary" onclick="editPelanggan('${p.id}')">Edit</button> 
                <button class="btn btn-xs btn-danger" onclick="deletePelanggan('${p.id}')">Hapus</button> 
            </td> 
        `; 
        tbl.appendChild(tr); 
    }); 
}

function searchPelanggan() {
    const query = document.getElementById('searchPelanggan').value.toLowerCase();
    const tbl = document.getElementById('tblPelanggan');
    if(!tbl) return;
    
    tbl.innerHTML = '';
    
    Object.values(DB.pelanggan)
        .filter(p => 
            p.noInternet.toLowerCase().includes(query) || 
            (p.snOnt && p.snOnt.toLowerCase().includes(query)) ||
            (p.odp && p.odp.toLowerCase().includes(query))
        )
        .forEach(p => {
            const tr = document.createElement('tr'); 
            tr.innerHTML = ` 
                <td>${escapeHtml(p.noInternet)}</td> 
                <td>${escapeHtml(p.nama)}</td> 
                <td><span class="badge bg-success">${escapeHtml(p.status)}</span></td> 
                <td>${escapeHtml(p.odp || '-')}</td> 
                <td>${escapeHtml(p.snOnt || '-')}</td> 
                <td>${escapeHtml(formatDate(p.tglPasang))}</td> 
                <td>${escapeHtml(dayDiff(p.tglPasang))} hari</td> 
                <td> 
                    <button class="btn btn-xs btn-primary" onclick="editPelanggan('${p.id}')">Edit</button> 
                    <button class="btn btn-xs btn-danger" onclick="deletePelanggan('${p.id}')">Hapus</button> 
                </td> 
            `; 
            tbl.appendChild(tr);
        });
}

function formatDate(d){ 
    if(!d) return '-'; 
    return new Date(d).toLocaleDateString('id-ID'); 
}

function dayDiff(d){ 
    if(!d) return 0; 
    const diff = new Date() - new Date(d); 
    return Math.floor(diff / (1000*60*60*24)); 
}

function editPelanggan(id){ 
    alert('Edit pelanggan belum diimplementasikan'); 
}

function deletePelanggan(id){ 
    if(confirm('Hapus pelanggan ini?')){ 
        delete DB.pelanggan[id]; 
        saveDB(DB); 
        hist('pelanggan', id, 'Dihapus'); 
        toast('Pelanggan dihapus'); 
        loadPelanggan(); 
    } 
}

/* ===============================
Billing
================================ */
function loadBilling(){ 
    const tbl = document.getElementById('tblBilling'); 
    if(!tbl) return; 
    
    tbl.innerHTML = ''; 
    Object.values(DB.billing).forEach(b => { 
        const tr = document.createElement('tr'); 
        tr.innerHTML = ` 
            <td><input type="checkbox" class="bill-check" data-id="${b.id}"></td> 
            <td>${escapeHtml(b.noInternet)}</td> 
            <td>${escapeHtml(b.nama)}</td> 
            <td>${escapeHtml(b.periode)}</td> 
            <td>Rp${escapeHtml((b.jumlah || 0).toLocaleString('id-ID'))}</td> 
            <td><span class="badge ${b.status==='Lunas'?'bg-success':'bg-danger'}">${escapeHtml(b.status)}</span></td> 
            <td> 
                <button class="btn btn-xs btn-primary" onclick="payBill('${b.id}')">Bayar</button> 
                <button class="btn btn-xs btn-secondary" onclick="printBill('${b.id}')">Cetak</button>
                <button class="btn btn-xs btn-info" onclick="shareBill('${b.id}')">Kirim</button>
                <button class="btn btn-xs btn-danger" onclick="deleteBill('${b.id}')">Hapus</button> 
            </td> 
        `; 
        tbl.appendChild(tr); 
    }); 
}

function searchBilling(){ 
    const q = document.getElementById('searchBilling').value.toLowerCase(); 
    const tbl = document.getElementById('tblBilling'); 
    if(!tbl) return; 
    
    tbl.innerHTML = ''; 
    Object.values(DB.billing).filter(b => { 
        return b.noInternet.toLowerCase().includes(q) || (b.nama && b.nama.toLowerCase().includes(q)); 
    }).forEach(b => { 
        const tr = document.createElement('tr'); 
        tr.innerHTML = ` 
            <td><input type="checkbox" class="bill-check" data-id="${b.id}"></td> 
            <td>${escapeHtml(b.noInternet)}</td> 
            <td>${escapeHtml(b.nama)}</td> 
            <td>${escapeHtml(b.periode)}</td> 
            <td>Rp${escapeHtml((b.jumlah || 0).toLocaleString('id-ID'))}</td> 
            <td><span class="badge ${b.status==='Lunas'?'bg-success':'bg-danger'}">${escapeHtml(b.status)}</span></td> 
            <td> 
                <button class="btn btn-xs btn-primary" onclick="payBill('${b.id}')">Bayar</button> 
                <button class="btn btn-xs btn-danger" onclick="deleteBill('${b.id}')">Hapus</button> 
            </td> 
        `; 
        tbl.appendChild(tr); 
    }); 
}

function toggleAllBills(checkbox){ 
    document.querySelectorAll('.bill-check').forEach(c => c.checked = checkbox.checked); 
}

function bulkGenerateBilling(){ 
    alert('Bulk generate billing belum diimplementasikan'); 
}

function generateForSelected(){ 
    alert('Generate untuk yang dipilih belum diimplementasikan'); 
}

function payBill(id){ 
    if(confirm('Tandai tagihan sebagai lunas?')){ 
        const b = DB.billing[id]; 
        if(b){ 
            b.status = 'Lunas'; 
            b.paidAt = now();
            saveDB(DB); 
            hist('billing', id, `Lunas: ${b.jumlah}`); 
            toast('Tagihan ditandai lunas'); 
            loadBilling(); 
        } 
    } 
}

function printBill(id) {
    const b = DB.billing[id];
    if(!b) return;
    
    const printWindow = window.open('', '_blank', 'width=600,height=600');
    printWindow.document.write(`
        <html>
        <head>
            <title>Struk Pembayaran - ${b.noInternet}</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                .header { text-align: center; margin-bottom: 20px; }
                .info { margin-bottom: 15px; }
                .info div { margin-bottom: 5px; }
                .footer { margin-top: 30px; text-align: center; font-size: 12px; }
            </style>
        </head>
        <body>
            <div class="header">
                <h2>STRUK PEMBAYARAN</h2>
                <h3>STARNET INTERNET</h3>
            </div>
            <div class="info">
                <div><strong>No. Internet:</strong> ${b.noInternet}</div>
                <div><strong>Pelanggan:</strong> ${b.nama}</div>
                <div><strong>Periode:</strong> ${b.periode}</div>
                <div><strong>Jumlah:</strong> Rp ${b.jumlah.toLocaleString('id-ID')}</div>
                <div><strong>Status:</strong> ${b.status}</div>
                <div><strong>Tanggal Bayar:</strong> ${new Date().toLocaleDateString('id-ID')}</div>
            </div>
            <div class="footer">
                <p>Terima kasih telah melakukan pembayaran</p>
                <p>www.starnet.id - Telp: 021-1234567</p>
            </div>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

function shareBill(id) {
    const b = DB.billing[id];
    if(!b) return;
    
    openShareModal('billing', id);
}

function deleteBill(id){ 
    if(confirm('Hapus tagihan ini?')){ 
        delete DB.billing[id]; 
        saveDB(DB); 
        hist('billing', id, 'Dihapus'); 
        toast('Tagihan dihapus'); 
        loadBilling(); 
    } 
}

/* ===============================
Kas
================================ */
function addKas(){ 
    const tanggal = document.getElementById('kas_tanggal').value; 
    const desc = document.getElementById('kas_desc').value; 
    const qty = parseFloat(document.getElementById('kas_qty').value) || 0; 
    const satuan = document.getElementById('kas_satuan').value;
    const masuk = parseFloat(document.getElementById('kas_masuk').value) || 0; 
    const keluar = parseFloat(document.getElementById('kas_keluar').value) || 0; 
    
    if(!desc){ 
        toast('Deskripsi harus diisi'); 
        return; 
    } 
    
    const id = uid('kas_'); 
    DB.kas[id] = { 
        id, 
        tanggal: tanggal || new Date().toISOString().split('T')[0],
        desc, 
        qty,
        satuan,
        masuk, 
        keluar, 
        created: now() 
    }; 
    
    saveDB(DB); 
    hist('kas', id, `Kas: ${desc} (${masuk}, ${keluar})`); 
    toast('Transaksi kas berhasil ditambahkan'); 
    loadKas(); 
    
    // Reset form
    document.getElementById('kas_tanggal').value = '';
    document.getElementById('kas_desc').value = '';
    document.getElementById('kas_qty').value = '';
    document.getElementById('kas_satuan').value = '';
    document.getElementById('kas_masuk').value = '';
    document.getElementById('kas_keluar').value = '';
}

function loadKas(){ 
    const tbl = document.getElementById('tblKas'); 
    if(!tbl) return; 
    
    tbl.innerHTML = ''; 
    let saldo = 0; 
    
    Object.values(DB.kas)
        .sort((a,b) => new Date(a.tanggal) - new Date(b.tanggal))
        .forEach((k, i) => { 
        saldo += k.masuk - k.keluar; 
        const tr = document.createElement('tr'); 
        tr.innerHTML = ` 
            <td>${i+1}</td> 
            <td>${escapeHtml(k.tanggal)}</td> 
            <td>${escapeHtml(k.desc)}</td> 
            <td>${escapeHtml(k.qty)}</td> 
            <td>${escapeHtml(k.satuan || '-')}</td> 
            <td>${escapeHtml(k.masuk.toLocaleString('id-ID'))}</td> 
            <td>${escapeHtml(k.keluar.toLocaleString('id-ID'))}</td> 
            <td>${escapeHtml(saldo.toLocaleString('id-ID'))}</td> 
        `; 
        tbl.appendChild(tr); 
    }); 
}

/* ===============================
ODP
================================ */
function createODP(){ 
    const name = document.getElementById('odp_name').value; 
    const kapasitas = document.getElementById('odp_kapasitas').value; 
    const distribusi = document.getElementById('odp_distribusi').value;
    const feeder = document.getElementById('odp_feeder').value; 
    const tagging = document.getElementById('odp_tagging').value; 
    
    if(!name){ 
        toast('Nama ODP harus diisi'); 
        return; 
    } 
    
    const id = uid('odp_'); 
    DB.odp[id] = { 
        id, 
        name, 
        kapasitas, 
        distribusi,
        feeder, 
        tagging, 
        created: now() 
    }; 
    
    saveDB(DB); 
    hist('odp', id, `ODP: ${name}`); 
    toast('ODP berhasil ditambahkan'); 
    loadODP(); 
    
    // Reset form
    document.getElementById('odp_name').value = '';
    document.getElementById('odp_kapasitas').value = '';
    document.getElementById('odp_distribusi').value = '';
    document.getElementById('odp_feeder').value = '';
    document.getElementById('odp_tagging').value = '';
}

function loadODP(){ 
    const tbl = document.getElementById('tblODP'); 
    if(!tbl) return; 
    
    tbl.innerHTML = ''; 
    Object.values(DB.odp).forEach(o => { 
        const tr = document.createElement('tr'); 
        tr.innerHTML = ` 
            <td>${escapeHtml(o.name)}</td> 
            <td>${escapeHtml(o.kapasitas)}</td> 
            <td>${escapeHtml(o.distribusi || '-')}</td> 
            <td>${escapeHtml(o.feeder)}</td> 
            <td>${escapeHtml(o.tagging)}</td> 
            <td> 
                <button class="btn btn-xs btn-primary" onclick="editODP('${o.id}')">Edit</button> 
                <button class="btn btn-xs btn-danger" onclick="deleteODP('${o.id}')">Hapus</button> 
            </td> 
        `; 
        tbl.appendChild(tr); 
    }); 
}

function editODP(id){ 
    alert('Edit ODP belum diimplementasikan'); 
}

function deleteODP(id){ 
    if(confirm('Hapus ODP ini?')){ 
        delete DB.odp[id]; 
        saveDB(DB); 
        hist('odp', id, 'Dihapus'); 
        toast('ODP dihapus'); 
        loadODP(); 
    } 
}

/* ===============================
Material
================================ */
function createMaterial(){ 
    const jenis = document.getElementById('m_jenis').value; 
    const qty = parseInt(document.getElementById('m_qty').value) || 0; 
    const satuan = document.getElementById('m_satuan').value; 
    
    if(!jenis){ 
        toast('Jenis material harus diisi'); 
        return; 
    } 
    
    const id = uid('mat_'); 
    DB.material[id] = { 
        id, 
        jenis, 
        qty, 
        satuan, 
        updated: now() 
    }; 
    
    saveDB(DB); 
    hist('material', id, `Material: ${jenis} (${qty} ${satuan})`); 
    toast('Material berhasil ditambahkan'); 
    loadMaterial(); 
    
    // Reset form
    document.getElementById('m_jenis').value = '';
    document.getElementById('m_qty').value = '';
    document.getElementById('m_satuan').value = '';
}

function loadMaterial(){ 
    const tbl = document.getElementById('tblMaterial'); 
    if(!tbl) return; 
    
    tbl.innerHTML = ''; 
    Object.values(DB.material).forEach(m => { 
        const tr = document.createElement('tr'); 
        tr.innerHTML = ` 
            <td>${escapeHtml(m.jenis)}</td> 
            <td>${escapeHtml(m.qty)}</td> 
            <td>${escapeHtml(m.satuan)}</td> 
            <td> 
                <button class="btn btn-xs btn-primary" onclick="editMaterial('${m.id}')">Edit</button> 
                <button class="btn btn-xs btn-danger" onclick="deleteMaterial('${m.id}')">Hapus</button> 
            </td> 
        `; 
        tbl.appendChild(tr); 
    }); 
}

function editMaterial(id){ 
    alert('Edit material belum diimplementasikan'); 
}

function deleteMaterial(id){ 
    if(confirm('Hapus material ini?')){ 
        delete DB.material[id]; 
        saveDB(DB); 
        hist('material', id, 'Dihapus'); 
        toast('Material dihapus'); 
        loadMaterial(); 
    } 
}

/* ===============================
Paket
================================ */
function createPaket(){ 
    const name = document.getElementById('pkg_name').value; 
    const bandwidth = document.getElementById('pkg_bandwidth').value;
    const price = parseInt(document.getElementById('pkg_price').value) || 0; 
    const desc = document.getElementById('pkg_desc').value;
    
    if(!name){ 
        toast('Nama paket harus diisi'); 
        return; 
    } 
    
    const id = uid('pkg_'); 
    DB.paket[id] = { 
        id, 
        name, 
        bandwidth,
        price, 
        desc,
        created: now() 
    }; 
    
    saveDB(DB); 
    hist('paket', id, `Paket: ${name} (${price})`); 
    toast('Paket berhasil ditambahkan'); 
    loadPaket(); 
    
    // Reset form
    document.getElementById('pkg_name').value = '';
    document.getElementById('pkg_bandwidth').value = '';
    document.getElementById('pkg_price').value = '';
    document.getElementById('pkg_desc').value = '';
}

function loadPaket(){ 
    const tbl = document.getElementById('tblPaket'); 
    if(!tbl) return; 
    
    tbl.innerHTML = ''; 
    Object.values(DB.paket).forEach(p => { 
        const tr = document.createElement('tr'); 
        tr.innerHTML = ` 
            <td>${escapeHtml(p.name)}</td> 
            <td>${escapeHtml(p.bandwidth)} Mbps</td> 
            <td>Rp${escapeHtml(p.price.toLocaleString('id-ID'))}</td> 
            <td>${escapeHtml(p.desc || '-')}</td> 
            <td> 
                <button class="btn btn-xs btn-primary" onclick="editPaket('${p.id}')">Edit</button> 
                <button class="btn btn-xs btn-danger" onclick="deletePaket('${p.id}')">Hapus</button> 
            </td> 
        `; 
        tbl.appendChild(tr); 
    }); 
}

function editPaket(id){ 
    alert('Edit paket belum diimplementasikan'); 
}

function deletePaket(id){ 
    if(confirm('Hapus paket ini?')){ 
        delete DB.paket[id]; 
        saveDB(DB); 
        hist('paket', id, 'Dihapus'); 
        toast('Paket dihapus'); 
        loadPaket(); 
    } 
}

/* ===============================
Mikrotik
================================ */
function createMikrotik(){ 
    const name = document.getElementById('mk_name').value; 
    const ip = document.getElementById('mk_ip').value; 
    
    if(!name || !ip){ 
        toast('Nama dan IP harus diisi'); 
        return; 
    } 
    
    const id = uid('mk_'); 
    DB.mikrotik[id] = { 
        id, 
        name, 
        ip, 
        created: now() 
    }; 
    
    saveDB(DB); 
    hist('mikrotik', id, `Mikrotik: ${name} (${ip})`); 
    toast('Mikrotik berhasil ditambahkan'); 
    loadMikrotik(); 
    
    // Reset form
    document.getElementById('mk_name').value = '';
    document.getElementById('mk_ip').value = '';
}

function loadMikrotik(){ 
    const tbl = document.getElementById('tblMikrotik'); 
    if(!tbl) return; 
    
    tbl.innerHTML = ''; 
    Object.values(DB.mikrotik).forEach(m => { 
        const tr = document.createElement('tr'); 
        tr.innerHTML = ` 
            <td>${escapeHtml(m.name)}</td> 
            <td>${escapeHtml(m.ip)}</td> 
            <td> 
                <button class="btn btn-xs btn-primary" onclick="editMikrotik('${m.id}')">Edit</button> 
                <button class="btn btn-xs btn-danger" onclick="deleteMikrotik('${m.id}')">Hapus</button> 
            </td> 
        `; 
        tbl.appendChild(tr); 
    }); 
}

function editMikrotik(id){ 
    alert('Edit mikrotik belum diimplementasikan'); 
}

function deleteMikrotik(id){ 
    if(confirm('Hapus mikrotik ini?')){ 
        delete DB.mikrotik[id]; 
        saveDB(DB); 
        hist('mikrotik', id, 'Dihapus'); 
        toast('Mikrotik dihapus'); 
        loadMikrotik(); 
    } 
}

/* ===============================
Users
================================ */
function openAddUserModal(){ 
    const modal = new bootstrap.Modal(document.getElementById('addUserModal')); 
    modal.show(); 
}

document.getElementById('addUserForm').addEventListener('submit', (e) => { 
    e.preventDefault(); 
    const nik = document.getElementById('u_nik').value.trim(); 
    const nama = document.getElementById('u_nama').value; 
    const email = document.getElementById('u_email').value; 
    const wa = document.getElementById('u_wa').value;
    const telegram = document.getElementById('u_telegram').value;
    const password = document.getElementById('u_password').value; 
    const role = document.getElementById('u_role').value; 
    
    if(DB.users[nik]){ 
        document.getElementById('userFormMsg').innerText = 'NIK sudah digunakan'; 
        return; 
    } 
    
    DB.users[nik] = { 
        nik, 
        nama, 
        email, 
        wa,
        telegram,
        password, 
        role 
    }; 
    
    saveDB(DB); 
    hist('users', nik, `User baru: ${nama} (${role})`); 
    toast('User berhasil ditambahkan'); 
    
    // Close modal and reset form
    bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide(); 
    document.getElementById('addUserForm').reset();
    
    loadUsers(); 
});

function loadUsers(){ 
    const tbl = document.getElementById('tblUsers'); 
    if(!tbl) return; 
    
    tbl.innerHTML = ''; 
    Object.values(DB.users).forEach(u => { 
        const tr = document.createElement('tr'); 
        tr.innerHTML = ` 
            <td>${escapeHtml(u.nik)}</td> 
            <td>${escapeHtml(u.nama)}</td> 
            <td>${escapeHtml(u.email)}</td> 
            <td>${escapeHtml(u.wa || '-')}</td> 
            <td>${escapeHtml(u.telegram || '-')}</td> 
            <td><span class="badge bg-secondary">${escapeHtml(u.role)}</span></td> 
            <td> 
                <button class="btn btn-xs btn-primary" onclick="editUser('${u.nik}')">Edit</button> 
                <button class="btn btn-xs btn-danger" onclick="deleteUser('${u.nik}')" ${u.nik === currentUser.nik ? 'disabled' : ''}>Hapus</button> 
            </td> 
        `; 
        tbl.appendChild(tr); 
    }); 
}

function editUser(nik){ 
    alert('Edit user belum diimplementasikan'); 
}

function deleteUser(nik){ 
    if(confirm('Hapus user ini?')){ 
        delete DB.users[nik]; 
        saveDB(DB); 
        hist('users', nik, 'Dihapus'); 
        toast('User dihapus'); 
        loadUsers(); 
    } 
}

/* ===============================
Portal Pelanggan
================================ */
function loadPortal(){ 
    // Show billing history
    const billingList = document.getElementById('portalBillingList');
    if (billingList) {
        const userBillings = Object.values(DB.billing)
            .filter(b => b.noInternet === currentUser.noInternet)
            .slice(0, 10);
        
        if (userBillings.length > 0) {
            let html = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Periode</th><th>Jumlah</th><th>Status</th><th>Aksi</th></tr></thead><tbody>';
            
            userBillings.forEach(b => {
                html += `
                    <tr>
                        <td>${b.periode}</td>
                        <td>Rp ${b.jumlah.toLocaleString('id-ID')}</td>
                        <td><span class="badge ${b.status === 'Lunas' ? 'bg-success' : 'bg-danger'}">${b.status}</span></td>
                        <td>
                            <button class="btn btn-xs btn-secondary" onclick="printBill('${b.id}')">Cetak</button>
                            <button class="btn btn-xs btn-info" onclick="shareBill('${b.id}')">Kirim</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            billingList.innerHTML = html;
        } else {
            billingList.innerHTML = '<div class="small-muted">Tidak ada data tagihan</div>';
        }
    }
    
    // Show gangguan history
    const gangguanList = document.getElementById('portalGangguanList');
    if (gangguanList) {
        const userGangguan = Object.values(DB.gangguan)
            .filter(g => g.noInternet === currentUser.noInternet)
            .slice(0, 10);
        
        if (userGangguan.length > 0) {
            let html = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Tiket</th><th>Masalah</th><th>Status</th><th>TTR</th></tr></thead><tbody>';
            
            userGangguan.forEach(g => {
                html += `
                    <tr>
                        <td>${g.tiket}</td>
                        <td>${g.jenis}</td>
                        <td><span class="badge ${getGangguanStatusClass(g.status)}">${g.status}</span></td>
                        <td>${g.ttr}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            gangguanList.innerHTML = html;
        } else {
            gangguanList.innerHTML = '<div class="small-muted">Tidak ada data gangguan</div>';
        }
    }
}

function laporkanGangguan() {
    const noInternet = document.getElementById('portal_no_inet').value;
    const nama = document.getElementById('portal_nama').value;
    const jenis = document.getElementById('portal_jenis_gangguan').value;
    const deskripsi = document.getElementById('portal_deskripsi').value;
    
    if (!noInternet || !nama || !jenis) {
        toast('No Internet, nama, dan jenis gangguan harus diisi');
        return;
    }
    
    // Generate ticket number
    const tiketNumber = `TC${DB.tiketCounter.toString().padStart(4, '0')}`;
    DB.tiketCounter++;
    
    const id = uid('tkt_'); 
    DB.gangguan[id] = { 
        id,
        tiket: tiketNumber,
        noInternet, 
        nama, 
        jenis, 
        deskripsi,
        status: 'Open', 
        ttr: '0 jam',
        created: now(), 
        updated: now(),
        progres: 'Menunggu Konfirmasi'
    }; 
    
    saveDB(DB); 
    hist('gangguan', id, `Laporan gangguan dari portal: ${nama} (${jenis})`); 
    toast('Laporan gangguan berhasil dikirim'); 
    
    // Reset form
    document.getElementById('portal_jenis_gangguan').value = '';
    document.getElementById('portal_deskripsi').value = '';
    
    // Reload data
    loadPortal();
}

function portalPrev(){ 
    const el = document.getElementById('portalPage'); 
    let page = parseInt(el.innerText) || 1; 
    if(page > 1) page--; 
    el.innerText = page; 
    loadPortal(); 
}

function portalNext(){ 
    const el = document.getElementById('portalPage'); 
    let page = parseInt(el.innerText) || 1; 
    page++; 
    el.innerText = page; 
    loadPortal(); 
}

/* ===============================
Reports
================================ */
function exportCSV(){ 
    alert('Export CSV belum diimplementasikan'); 
}

/* ===============================
Self Test
================================ */
function runSelfTest() {
    toast('Menjalankan self-test...');
    
    // Create sample data
    const pelangganId = uid('pel_');
    DB.pelanggan[pelangganId] = {
        id: pelangganId,
        noInternet: '2401001',
        nama: 'Pelanggan Contoh',
        alamat: 'Jl. Contoh No. 123',
        hp: '081234567890',
        paket: 'pkg1',
        status: 'Aktif',
        tglPasang: now(),
        created: now()
    };
    
    const gangguanId = uid('tkt_');
    DB.gangguan[gangguanId] = {
        id: gangguanId,
        tiket: 'TC0001',
        noInternet: '2401001',
        nama: 'Pelanggan Contoh',
        jenis: 'LOS Merah',
        status: 'Open',
        ttr: '2 jam',
        created: now(),
        updated: now(),
        progres: 'Menunggu Konfirmasi'
    };
    
    const billingId = uid('bill_');
    DB.billing[billingId] = {
        id: billingId,
        noInternet: '2401001',
        nama: 'Pelanggan Contoh',
        periode: '2024-01',
        jumlah: 150000,
        status: 'Belum Bayar',
        created: now()
    };
    
    saveDB(DB);
    
    // Reload all data
    loadDashboard();
    loadPasang();
    loadGangguan();
    loadPelanggan();
    loadBilling();
    
    toast('Self-test selesai. Data contoh telah ditambahkan.');
}

/* ===============================
Initialize
================================ */
function init(){ 
    checkSession(); 
    
    // Set current date for date inputs
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('p_tgl_pasang').value = today;
    document.getElementById('kas_tanggal').value = today;
    
    console.log('Starnet initialized'); 
}

// Start the app
init();
</script>
</body>
</html>
