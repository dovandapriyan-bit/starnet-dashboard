<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>ISP Manager Full</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:20px; background:#f9f9f9; }
    h1 { color:#333; }
    table { border-collapse: collapse; width:100%; margin-top:10px; background:white; }
    th, td { border:1px solid #ddd; padding:8px; font-size:14px; }
    th { background:#eee; }
    button { padding:5px 10px; margin:2px; border-radius:5px; border:1px solid #ccc; }
  </style>
</head>
<body>
<h1>ISP Manager</h1>

<h2>Pasang Baru</h2>
<form id="formPasang">
  Nama: <input id="nama" required>
  Alamat: <input id="alamat" required>
  Paket: <input id="paket" required>
  <button type="submit">Daftar</button>
</form>

<table id="tblPasang">
  <thead>
    <tr><th>No Internet</th><th>Nama</th><th>Alamat</th><th>Paket</th><th>Status</th><th>Aksi</th></tr>
  </thead>
  <tbody></tbody>
</table>

<h2>Pengaturan</h2>
<form id="formWebhook">
  URL Webhook WA: <input id="waUrl" style="width:400px">
  Auth Header: <input id="waAuth" style="width:200px">
  <button type="submit">Simpan</button>
</form>

<script>
  // --- Firebase Config (punya Anda) ---
  const firebaseConfig = {
    apiKey: "AIzaSyB-iBpZNC0YZBTAUzir7gJuU9kBQg82moc",
    authDomain: "dnt-network-7.firebaseapp.com",
    projectId: "dnt-network-7",
    storageBucket: "dnt-network-7.firebasestorage.app",
    messagingSenderId: "761179668371",
    appId: "1:761179668371:web:7d1468d0298041d4783266",
    measurementId: "G-CD3EQ350R4"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let counterDoc = db.collection('settings').doc('counter');

  // generate nomor internet
  async function getNextInternetNo() {
    const res = await db.runTransaction(async (tx)=>{
      const doc = await tx.get(counterDoc);
      let val = 19061401;
      if (doc.exists) val = doc.data().last+1;
      tx.set(counterDoc,{last:val});
      return val;
    });
    return res;
  }

  // simpan webhook
  document.getElementById('formWebhook').onsubmit = async (e)=>{
    e.preventDefault();
    await db.collection('settings').doc('waWebhook').set({
      url: document.getElementById('waUrl').value,
      authHeader: document.getElementById('waAuth').value
    });
    alert('Webhook disimpan');
  };

  // daftar pasang baru
  document.getElementById('formPasang').onsubmit = async (e)=>{
    e.preventDefault();
    const no = await getNextInternetNo();
    await db.collection('pasang_baru').add({
      internetNo:no,
      nama: document.getElementById('nama').value,
      alamat: document.getElementById('alamat').value,
      paket: document.getElementById('paket').value,
      status:'Survey',
      created: new Date()
    });
    e.target.reset();
  };

  // render tabel
  db.collection('pasang_baru').orderBy('created','desc').onSnapshot(snap=>{
    const tb = document.querySelector('#tblPasang tbody');
    tb.innerHTML='';
    snap.forEach(doc=>{
      const d=doc.data();
      let tr=document.createElement('tr');
      tr.innerHTML=`<td>${d.internetNo}</td><td>${d.nama}</td>
        <td>${d.alamat}</td><td>${d.paket}</td><td>${d.status}</td>
        <td>
          <button onclick="kirim('${doc.id}')">Kirim Teknisi</button>
          <button onclick="surveyOk('${doc.id}')">Survey OK</button>
          <button onclick="instalasiOk('${doc.id}')">Instalasi OK</button>
          <button onclick="materialOk('${doc.id}')">Material OK</button>
        </td>`;
      tb.appendChild(tr);
    });
  });

  // aksi simulasi
  async function kirim(id){
    const doc = await db.collection('pasang_baru').doc(id).get();
    const d=doc.data();
    await sendWa({action:'survey_request',task:d, pasangId:id});
    alert('Dikirim ke teknisi');
  }
  async function surveyOk(id){
    await db.collection('pasang_baru').doc(id).update({status:'Instalasi'});
    alert('Survey OK');
  }
  async function instalasiOk(id){
    await db.collection('pasang_baru').doc(id).update({status:'Verifikasi Material'});
    alert('Instalasi OK');
  }
  async function materialOk(id){
    const ref=db.collection('pasang_baru').doc(id);
    const doc=await ref.get();
    const d=doc.data();
    await db.runTransaction(async (tx)=>{
      // contoh: kurangi stok ont
      const mat= await tx.get(db.collection('material').doc('ont'));
      if(mat.exists){
        let stok=mat.data().stok||0;
        if(stok<=0) throw "Stok habis";
        tx.update(mat.ref,{stok:stok-1});
      }
      tx.update(ref,{status:'Active'});
    });
    // arsip
    const d2=doc.data();
    await db.collection('pasang_baru_archive').doc(id).set(d2);
    await ref.delete();
    await sendWa({action:'activated',task:d2,pasangId:id});
    alert('Material OK & status Active');
  }

  async function sendWa(payload){
    const cfg = await db.collection('settings').doc('waWebhook').get();
    if(!cfg.exists){ console.log('Webhook not set'); return; }
    const {url,authHeader} = cfg.data();
    fetch(url,{method:'POST',headers:{'Content-Type':'application/json','Authorization':authHeader||''},body:JSON.stringify({taskId:Date.now(),payload})});
  }
</script>
</body>
</html>
