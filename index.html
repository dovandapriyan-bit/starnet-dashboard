<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ISP Manager — Full Final (Mobile & Desktop)</title>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --blue: #1f3b6f;
    --accent: #4b6cb7;
    --muted: #6b7280;
    --bg: #f4f6fb;
    --success: #28a745;
    --danger: #dc3545;
    --card: #ffffff;
    --glass: rgba(255,255,255,0.6);
  }
  *{box-sizing:border-box}
  body{font-family:Inter, "Segoe UI", system-ui, -apple-system, Roboto, "Helvetica Neue", Arial; margin:0;background:var(--bg); color:#111}
  a{color:inherit}
  /* Topbar & layout */
  #loginPage{display:flex;align-items:center;justify-content:center;height:100vh;background:linear-gradient(135deg,var(--blue),var(--accent))}
  #loginBox{background:var(--card);padding:32px;border-radius:12px;box-shadow:0 14px 40px rgba(31,59,111,0.18);width:360px;max-width:92%}
  h1,h2{margin:0 0 6px 0;color:var(--blue)}
  p{margin:0}
  input, select, textarea, button {font-family:inherit}
  input, select, textarea {border-radius:8px;border:1px solid #d1d5db;padding:10px;outline:none;background:#fff}
  input:focus, select:focus, textarea:focus {border-color:var(--blue);box-shadow:0 0 0 3px rgba(31,59,111,0.06)}
  button {border-radius:8px;border:none;padding:8px 12px}
  .muted{color:var(--muted);font-size:13px}
  /* App layout */
  #appPage{display:none;min-height:100vh;display:flex}
  /* Sidebar */
  #sidebar{width:240px;background:linear-gradient(180deg,var(--blue),var(--accent));color:#fff;min-height:100vh;transition:width .2s ease, transform .2s ease;position:relative;z-index:50}
  #sidebar.collapsed{width:72px}
  #sidebar h2{padding:18px 16px;margin:0;font-size:18px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.06)}
  #sidebar ul{list-style:none;padding:0;margin:0}
  #sidebar ul li{padding:12px 18px;cursor:pointer;display:flex;gap:10px;align-items:center}
  #sidebar ul li:hover{background:rgba(255,255,255,0.06)}
  #sidebar ul li .label{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  /* Main */
  #mainContent{flex:1;padding:18px;display:flex;flex-direction:column;gap:12px}
  #topBar{display:flex;align-items:center;justify-content:space-between;background:var(--card);padding:10px 12px;border-radius:10px;box-shadow:0 6px 18px rgba(16,24,40,0.05)}
  #topLeft{display:flex;align-items:center;gap:12px}
  #hamburger{font-size:20px;padding:6px;background:transparent;border-radius:6px;cursor:pointer}
  .userBadge{display:flex;flex-direction:column;align-items:flex-end;font-size:13px}
  .cards{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(16,24,40,0.04);display:flex;flex-direction:column;gap:8px}
  .card h3{margin:0;font-size:14px;color:var(--muted)}
  .card .val{font-size:22px;font-weight:700;color:var(--blue)}
  .grid-two{display:grid;grid-template-columns:2fr 1fr;gap:12px}
  .panel{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(16,24,40,0.04)}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:left}
  th{background:linear-gradient(180deg,var(--blue),var(--accent));color:#fff;font-weight:600}
  tr:hover td{background:#fbfdff}
  .actions{display:flex;gap:6px;justify-content:flex-end}
  .small{font-size:12px;padding:6px 8px;border-radius:6px}
  .btn-primary{background:var(--blue);color:#fff}
  .btn-success{background:var(--success);color:#fff}
  .btn-danger{background:var(--danger);color:#fff}
  .btn-warning{background:#ffc107;color:#111}
  /* Responsive */
  @media(max-width:1100px){
    .cards{grid-template-columns:repeat(2,1fr)}
    .grid-two{grid-template-columns:1fr}
  }
  @media(max-width:720px){
    #sidebar{position:fixed;left:-320px;top:0;height:100vh;z-index:80}
    #sidebar.open{left:0}
    #mainContent{padding:12px}
    .cards{grid-template-columns:1fr}
    .userBadge{align-items:flex-start}
  }
  /* overlay when mobile menu open */
  #overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.3);z-index:60}
  #overlay.show{display:block}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage">
  <div id="loginBox">
    <h2>Login Karyawan / Pelanggan</h2>
    <input id="nik" placeholder="NIK / ID Pelanggan" />
    <input id="password" type="password" placeholder="Password" />
    <div style="margin-top:10px">
      <button id="btnLogin" class="btn-primary" onclick="loginNIK()">Login</button>
    </div>
    <p id="loginMsg" class="muted" style="color:crimson;margin-top:8px"></p>
    <p class="muted" style="margin-top:10px">by Dnt Grup - Starnet 💫 • dnt.network.lmj@gmail.com</p>
  </div>
</div>

<!-- APP -->
<div id="appPage" style="display:none">
  <div id="sidebar" aria-hidden="false">
    <h2>ISP 💫</h2>
    <ul>
      <li onclick="showPage('dashboard')">📊 <span class="label">Dashboard</span></li>
      <li onclick="showPage('gangguan')">⚠️ <span class="label">Gangguan</span></li>
      <li onclick="showPage('pasangBaru')">🆕 <span class="label">Pasang Baru</span></li>
      <li onclick="showPage('pelanggan')">👥 <span class="label">Pelanggan</span></li>
      <li onclick="showPage('billing')">💳 <span class="label">Billing</span></li>
      <li onclick="showPage('kas')">💰 <span class="label">Kas</span></li>
      <li onclick="showPage('odp')">🖧 <span class="label">ODP / Mikrotik</span></li>
      <li onclick="showPage('material')">📦 <span class="label">Material</span></li>
      <li onclick="showPage('paket')">📦 <span class="label">Paket / Tarif</span></li>
      <li onclick="showPage('karyawan')">👔 <span class="label">Karyawan</span></li>
      <li onclick="showPage('webhook')">⚙️ <span class="label">Webhook</span></li>
      <li onclick="showPage('history')">🗂️ <span class="label">History</span></li>
      <li onclick="showPage('portal')">🌐 <span class="label">Portal Pelanggan</span></li>
      <li onclick="logout()">🚪 <span class="label">Logout</span></li>
    </ul>
  </div>

  <div id="mainContent">
    <div id="topBar">
      <div id="topLeft">
        <button id="hamburger" aria-label="Toggle menu">☰</button>
        <div style="display:flex;flex-direction:column">
          <strong id="userName">-</strong>
          <span class="muted" id="userRole">-</span>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <div class="muted" id="timeNow"></div>
        <button class="btn-warning small" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboardPage">
      <h2>Dashboard</h2>
      <div class="cards" style="margin-top:10px">
        <div class="card">
          <h3>Aktif Pelanggan</h3>
          <div class="val" id="cardPelanggan">-</div>
          <div class="muted">Pelanggan yang aktif</div>
        </div>
        <div class="card">
          <h3>Gangguan Hari Ini</h3>
          <div class="val" id="cardGangguan">-</div>
          <div class="muted">Jumlah tiket hari ini</div>
        </div>
        <div class="card">
          <h3>Pasang Baru (Bulan)</h3>
          <div class="val" id="cardPasang">-</div>
          <div class="muted">Pendaftaran pasang baru bulan ini</div>
        </div>
        <div class="card">
          <h3>Pendapatan (Dummy)</h3>
          <div class="val" id="cardBilling">Rp 0</div>
          <div class="muted">Total billing dummy</div>
        </div>
      </div>

      <div class="grid-two" style="margin-top:12px;gap:12px">
        <div class="panel">
          <h3 style="margin-bottom:8px">Grafik Aktivitas</h3>
          <canvas id="chartDashboard" height="120"></canvas>
        </div>
        <div class="panel">
          <h3 style="margin-bottom:8px">Recent Activity</h3>
          <div id="recentList" style="max-height:220px;overflow:auto"></div>
        </div>
      </div>
    </div>

    <!-- GANGGUAN -->
    <div id="gangguanPage" class="hidden">
      <h2>Gangguan / Tiket Pelanggan</h2>

      <form id="formGangguan" style="margin-top:10px">
        <input id="g_pelanggan" placeholder="Nama Pelanggan" required />
        <input id="g_nohp" placeholder="No HP (opsional)" />
        <input id="g_alamat" placeholder="Alamat (opsional)" />
        <input id="g_masalah" placeholder="Ringkasan Masalah" required />
        <select id="g_prioritas" style="width:150px">
          <option value="Normal">Normal</option>
          <option value="Urgent">Urgent</option>
        </select>
        <button type="submit" class="btn-primary">Buat Tiket</button>
      </form>

      <table id="tblGangguan" style="margin-top:12px">
        <thead>
          <tr>
            <th>Tiket Gangguan</th>
            <th>Pelanggan</th>
            <th>No HP</th>
            <th>Masalah</th>
            <th>Status</th>
            <th>TTR</th>
            <th style="text-align:right">Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <button class="btn-primary small" onclick="generateDummyGangguan()">Generate Dummy Gangguan</button>
        <div class="muted">Prefix tetap <code>TC</code>. Reserved: <code>TC0000</code></div>
      </div>
    </div>

    <!-- PASANG BARU -->
    <div id="pasangBaruPage" class="hidden">
      <h2>Pasang Baru</h2>
      <form id="formPasang" style="margin-top:10px">
        <input id="p_nama" placeholder="Nama" required />
        <input id="p_nohp" placeholder="No HP" required />
        <input id="p_alamat" placeholder="Alamat" required />
        <input id="p_paket" placeholder="Paket" required />
        <input id="p_sn" placeholder="SN ONT (opsional)" />
        <input id="p_odp" placeholder="ODP (opsional)" />
        <select id="p_status" style="width:140px">
          <option>Menunggu</option><option>Survey</option><option>Instalasi</option><option>Active</option>
        </select>
        <button type="submit" class="btn-primary">Daftar</button>
      </form>

      <table id="tblPasang" style="margin-top:12px">
        <thead>
          <tr><th>No Internet</th><th>Nama</th><th>No HP</th><th>Alamat</th><th>Paket</th><th>SN ONT</th><th>ODP</th><th>Status</th><th style="text-align:right">Aksi</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- PELANGGAN -->
    <div id="pelangganPage" class="hidden">
      <h2>Pelanggan</h2>
      <table id="tblPelanggan" style="margin-top:12px">
        <thead><tr><th>No Internet</th><th>Nama</th><th>Alamat</th><th>No HP</th><th>Paket</th><th style="text-align:right">Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- BILLING -->
    <div id="billingPage" class="hidden">
      <h2>Billing</h2>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="btn-primary small" onclick="generateDummyBilling()">Generate Billing Dummy</button>
      </div>
      <table id="tblBilling" style="margin-top:12px">
        <thead><tr><th>No</th><th>Pelanggan</th><th>Periode</th><th>Jumlah</th><th>Status</th><th style="text-align:right">Aksi</th></tr></thead><tbody></tbody>
      </table>
    </div>

    <!-- KAS, ODP, MATERIAL, PAKET, KARYAWAN, WEBHOOK, HISTORY, PORTAL -->
    <div id="kasPage" class="hidden"><h2>Kas / Keuangan</h2><table id="tblKas" style="margin-top:12px"><thead><tr><th>No</th><th>Deskripsi</th><th>Masuk</th><th>Keluar</th><th>Saldo</th></tr></thead><tbody></tbody></table></div>

    <div id="odpPage" class="hidden"><h2>ODP / Mikrotik</h2><table id="tblODP" style="margin-top:12px"><thead><tr><th>ODP</th><th>SNONT</th><th>IP</th><th style="text-align:right">Aksi</th></tr></thead><tbody></tbody></table></div>

    <div id="materialPage" class="hidden">
      <h2>Material / Inventory</h2>
      <form id="formMaterial" style="margin-top:10px">
        <input id="m_nama" placeholder="Nama Material" required />
        <input id="m_stok" type="number" placeholder="Stok Awal" required />
        <button type="submit" class="btn-primary">Tambah Material</button>
      </form>
      <table id="tblMaterial" style="margin-top:12px"><thead><tr><th>Nama</th><th>Stok</th><th style="text-align:right">Aksi</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="paketPage" class="hidden">
      <h2>Paket / Tarif</h2>
      <form id="formPaket" style="margin-top:10px">
        <input id="pkg_nama" placeholder="Nama Paket" required />
        <input id="pkg_harga" type="number" placeholder="Harga" required />
        <input id="pkg_speed" placeholder="Kecepatan" required />
        <button type="submit" class="btn-primary">Tambah Paket</button>
      </form>
      <table id="tblPaket" style="margin-top:12px"><thead><tr><th>Nama Paket</th><th>Harga</th><th>Kecepatan</th><th style="text-align:right">Aksi</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="karyawanPage" class="hidden">
      <h2>Karyawan</h2>
      <form id="formKaryawan" style="margin-top:10px">
        <input id="k_nik" placeholder="NIK" required />
        <input id="k_nama" placeholder="Nama" required />
        <input id="k_pass" placeholder="Password" required />
        <select id="k_role"><option value="admin">Admin</option><option value="teknisi">Teknisi</option></select>
        <button type="submit" class="btn-primary">Tambah</button>
      </form>
      <table id="tblKaryawan" style="margin-top:12px"><thead><tr><th>NIK</th><th>Nama</th><th>Role</th><th style="text-align:right">Aksi</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="webhookPage" class="hidden">
      <h2>Webhook</h2>
      <form id="formWebhook" style="margin-top:10px">
        <input id="wh_url" placeholder="URL Webhook WA" />
        <input id="wh_auth" placeholder="Auth Header (opsional)" />
        <button type="submit" class="btn-primary">Simpan</button>
      </form>
    </div>

    <div id="historyPage" class="hidden">
      <h2>Arsip / History</h2>
      <table id="tblHistory" style="margin-top:12px"><thead><tr><th>Waktu</th><th>Jenis</th><th>Item</th><th>Deskripsi</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="portalPage" class="hidden">
      <h2>Portal Pelanggan</h2>
      <p class="muted">Demo read-only: tagihan & tiket pelanggan</p>
      <table id="tblPortalBilling" style="margin-top:12px"><thead><tr><th>No</th><th>Pelanggan</th><th>Periode</th><th>Jumlah</th><th>Status</th></tr></thead><tbody></tbody></table>
    </div>

  </div>
</div>

<!-- overlay for mobile menu -->
<div id="overlay"></div>

<script>
/* ================= FIREBASE SETUP ================= */
const firebaseConfig = {
  apiKey: "AIzaSyB-iBpZNC0YZBTAUzir7gJuU9kBQg82moc",
  authDomain: "dnt-network-7.firebaseapp.com",
  projectId: "dnt-network-7",
  storageBucket: "dnt-network-7.appspot.com",
  messagingSenderId: "761179668371",
  appId: "1:761179668371:web:7d1468d0298041d4783266",
  measurementId: "G-CD3EQ350R4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================ helpers ================ */
const q = id => document.getElementById(id);
const now = ()=> new Date().toLocaleString();
function toast(msg){ alert(msg); } // simple for demo; replace with non-blocking toast if desired

async function logHistory(type, item, desc){
  try{ await db.collection('history').add({ ts: firebase.firestore.FieldValue.serverTimestamp(), type, item, desc }); }catch(e){ console.warn('history err',e); }
}

/* ================ AUTH ================ */
let currentUser = null;
async function loginNIK(){
  q('loginMsg').innerText = '';
  const nik = (q('nik').value || '').trim().toLowerCase();
  const pass = (q('password').value || '').trim();
  if(!nik || !pass){ q('loginMsg').innerText = 'Isi NIK & password'; return; }
  try{
    const doc = await db.collection('users').doc(nik).get();
    if(!doc.exists){ q('loginMsg').innerText = 'ID tidak ditemukan'; return; }
    const data = doc.data();
    if(data.password !== pass){ q('loginMsg').innerText = 'Password salah'; return; }
    currentUser = { nik, ...data };
    q('loginPage').style.display = 'none';
    q('appPage').style.display = 'flex';
    q('userName').innerText = data.nama || nik;
    q('userRole').innerText = data.role || '-';
    await prepareReservedTicket();
    await initAll();
  }catch(e){ console.error(e); q('loginMsg').innerText = 'Login error'; }
}
function logout(){
  currentUser = null;
  q('loginPage').style.display = 'flex';
  q('appPage').style.display = 'none';
  // close sidebar on mobile
  closeMobileMenu();
}

/* ================ MOBILE / SIDEBAR HANDLING ================ */
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');
const hamburger = document.getElementById('hamburger');

function openMobileMenu(){ sidebar.classList.add('open'); overlay.classList.add('show'); }
function closeMobileMenu(){ sidebar.classList.remove('open'); overlay.classList.remove('show'); }
function toggleSidebar(){
  if(window.innerWidth <= 720){
    if(sidebar.classList.contains('open')) closeMobileMenu(); else openMobileMenu();
  } else {
    sidebar.classList.toggle('collapsed');
  }
}
hamburger.addEventListener('click', toggleSidebar);
overlay.addEventListener('click', closeMobileMenu);

/* auto time display */
setInterval(()=>{ const t = new Date(); q('timeNow').innerText = t.toLocaleString(); },1000);

/* ================ DASHBOARD ================ */
let chartDashboard = null;
function initDashboard(){
  const ctx = q('chartDashboard').getContext('2d');
  if(chartDashboard) chartDashboard.destroy();
  chartDashboard = new Chart(ctx, {
    type: 'line',
    data: {
      labels: ['Minggu-4','Minggu-3','Minggu-2','Minggu-1','Minggu ini'],
      datasets: [
        { label:'Pelanggan Baru', data:[5,8,6,12,9], tension:0.3, fill:true, backgroundColor:'rgba(31,59,111,0.06)', borderColor: 'rgba(31,59,111,0.9)' },
        { label:'Gangguan', data:[2,4,3,5,7], tension:0.3, fill:false, borderColor: '#dc3545' }
      ]
    },
    options: { responsive:true, plugins:{legend:{position:'bottom'}} }
  });
}

/* ================ GANGGUAN (Tiket Gangguan TC0001..) ================ */

/* Ensure TC0000 reserved exists and never changed */
async function prepareReservedTicket(){
  try{
    const docRef = db.collection('gangguan').doc('TC0000');
    const doc = await docRef.get();
    if(!doc.exists){
      await docRef.set({
        tiket:'TC0000',
        pelanggan:'RESERVED',
        masalah:'Reserved tiket - jangan ubah',
        status:'Reserved',
        ttr:'--',
        reserved:true,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
  }catch(e){ console.warn('prepareReservedTicket err', e); }
}

/* Find next ticket code by scanning existing TC docs */
async function getNextTicketCode(){
  try{
    const snap = await db.collection('gangguan').get();
    let max = 0;
    snap.forEach(doc => {
      const id = doc.id;
      if(!id.startsWith('TC')) return;
      if(id === 'TC0000') return;
      const num = parseInt(id.slice(2),10);
      if(!isNaN(num) && num > max) max = num;
    });
    const next = max + 1;
    return 'TC' + String(next).padStart(4,'0');
  }catch(e){ console.error('getNextTicketCode err', e); return 'TC0001'; }
}

q('formGangguan').addEventListener('submit', async function(e){
  e.preventDefault();
  const pelanggan = (q('g_pelanggan').value || '').trim();
  const nohp = (q('g_nohp').value || '').trim();
  const alamat = (q('g_alamat').value || '').trim();
  const masalah = (q('g_masalah').value || '').trim();
  const prioritas = (q('g_prioritas').value || 'Normal');
  if(!pelanggan || !masalah){ toast('Isi pelanggan & masalah'); return; }
  try{
    const code = await getNextTicketCode();
    await db.collection('gangguan').doc(code).set({
      tiket: code, pelanggan, nohp, alamat, masalah, prioritas,
      status:'Menunggu', ttr:'--', createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    await logHistory('gangguan.create', code, `Tiket dibuat oleh ${currentUser?.nik || 'unknown'}`);
    q('formGangguan').reset();
    await loadGangguan();
    toast('Tiket dibuat: ' + code);
  }catch(e){ console.error(e); toast('Gagal buat tiket'); }
});

async function loadGangguan(){
  try{
    const snap = await db.collection('gangguan').orderBy('createdAt','desc').get();
    const tbody = q('tblGangguan').querySelector('tbody'); tbody.innerHTML = '';
    let todayCount=0;
    snap.forEach(doc => {
      const d = doc.data();
      const id = doc.id;
      // create row
      const tr = document.createElement('tr');
      const masalahTxt = (d.masalah || '-');
      const statusTxt = (d.status || '-');
      const ttrTxt = (d.ttr || '--');
      if(d.createdAt){
        const created = d.createdAt.toDate();
        const today = new Date();
        if(created.toDateString() === today.toDateString()) todayCount++;
      }
      const aksi = (()=>{
        if(d.reserved) return `<span class="muted small">Reserved</span>`;
        if(statusTxt === 'Menunggu') return `<div class="actions"><button class="btn-success small" onclick="assignToTechnician('${id}')">Kirim ke Teknisi</button><button class="btn-danger small" onclick="hapusGangguan('${id}')">Hapus</button></div>`;
        if(statusTxt === 'Progres' || statusTxt === 'Material Dicek') return `<div class="actions"><button class="btn-primary small" onclick="closeGangguan('${id}')">Tutup</button><button class="btn-danger small" onclick="hapusGangguan('${id}')">Hapus</button></div>`;
        if(statusTxt === 'Selesai') return `<div class="actions"><span class="muted small">Selesai</span></div>`;
        return `<div class="actions"><button class="btn-danger small" onclick="hapusGangguan('${id}')">Hapus</button></div>`;
      })();
      tr.innerHTML = `<td>${id}</td><td>${d.pelanggan||'-'}</td><td>${d.nohp||'-'}</td><td>${masalahTxt}</td><td>${statusTxt}</td><td>${ttrTxt}</td><td style="text-align:right">${aksi}</td>`;
      tbody.appendChild(tr);
    });
    q('cardGangguan').innerText = String(todayCount);
  }catch(e){ console.error('loadGangguan', e); }
}

/* assign to technician => simulate WA send, then technicianVerify */
async function assignToTechnician(code){
  try{
    await db.collection('gangguan').doc(code).update({ status:'Progres', assignedAt: firebase.firestore.FieldValue.serverTimestamp() });
    await logHistory('gangguan.assign', code, `Assigned by ${currentUser?.nik||'unknown'}`);
    toast(`WA SIMULASI: Admin mengirim tiket ${code} ke teknisi`);
    await loadGangguan();
    setTimeout(()=> technicianVerify(code), 1200);
  }catch(e){ console.error(e); toast('Gagal assign'); }
}

/* technician verifies => checks material => reduces stock => close */
async function technicianVerify(code){
  try{
    await db.collection('gangguan').doc(code).update({ status:'Material Dicek' });
    await logHistory('gangguan.verify', code, 'Teknisi verifikasi progres');
    toast('WA SIMULASI: Teknisi verifikasi dan cek material');

    // reduce one unit from the first material found (demo)
    const matSnap = await db.collection('material').limit(1).get();
    if(!matSnap.empty){
      const matDoc = matSnap.docs[0];
      const mat = matDoc.data();
      const newStok = Math.max(0, (mat.stok || 0) - 1);
      await db.collection('material').doc(matDoc.id).update({ stok: newStok });
      await logHistory('material.update', matDoc.id, `Stok -1 for ticket ${code}`);
      toast(`Stok '${matDoc.id}' dikurangi 1 (sisa ${newStok})`);
    } else {
      toast('Tidak ada material untuk dikurangi (demo)');
    }

    // auto-close after a delay
    setTimeout(async ()=>{
      await db.collection('gangguan').doc(code).update({ status:'Selesai', ttr:'1 jam', closedAt: firebase.firestore.FieldValue.serverTimestamp() });
      await logHistory('gangguan.close', code, 'Closed by technician');
      toast(`Tiket ${code} selesai`);
      loadGangguan();
    }, 1400);

  }catch(e){ console.error('technicianVerify', e); }
}

async function hapusGangguan(id){
  if(!confirm('Hapus tiket ' + id + ' ?')) return;
  try{
    await db.collection('gangguan').doc(id).delete();
    await logHistory('gangguan.delete', id, 'Deleted by ' + (currentUser?.nik || 'unknown'));
    await loadGangguan();
    toast('Tiket dihapus');
  }catch(e){ console.error(e); toast('Gagal hapus'); }
}

async function closeGangguan(id){
  if(!confirm('Tutup tiket '+id+' ?')) return;
  try{
    await db.collection('gangguan').doc(id).update({ status:'Selesai', closedAt: firebase.firestore.FieldValue.serverTimestamp() });
    await logHistory('gangguan.close', id, 'Closed manually');
    await loadGangguan();
    toast('Tiket ditutup');
  }catch(e){ console.error(e); toast('Gagal tutup'); }
}

/* ================ PASANG BARU (auto number) ================ */
let localNextNo = 1906140000;
q('formPasang').addEventListener('submit', async function(e){
  e.preventDefault();
  const nama = (q('p_nama').value||'').trim();
  const nohp = (q('p_nohp').value||'').trim();
  const alamat = (q('p_alamat').value||'').trim();
  const paket = (q('p_paket').value||'').trim();
  const sn = (q('p_sn').value||'').trim();
  const odp = (q('p_odp').value||'').trim();
  const status = (q('p_status').value || 'Menunggu');
  if(!nama || !nohp || !alamat || !paket){ toast('Lengkapi field wajib'); return; }
  try{
    // find max existing id numeric
    const snap = await db.collection('pasangBaru').get();
    let max = 0;
    snap.forEach(doc => {
      const id = doc.id;
      const num = parseInt(id,10);
      if(!isNaN(num) && num > max) max = num;
    });
    const next = max > 0 ? max + 1 : localNextNo++;
    const idStr = String(next);
    await db.collection('pasangBaru').doc(idStr).set({ nama, nohp, alamat, paket, snOnt: sn, odp, status, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    await logHistory('pasang.create', idStr, 'Created by ' + (currentUser?.nik||'unknown'));
    q('formPasang').reset();
    loadPasangBaru();
    toast('Pasang baru terdaftar: ' + idStr);
  }catch(e){ console.error(e); toast('Gagal daftar'); }
});
async function loadPasangBaru(){
  try{
    const snap = await db.collection('pasangBaru').orderBy('createdAt','desc').get();
    const tbody = q('tblPasang').querySelector('tbody'); tbody.innerHTML = '';
    let count = 0;
    snap.forEach(doc => {
      const d = doc.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${doc.id}</td><td>${d.nama||'-'}</td><td>${d.nohp||'-'}</td><td>${d.alamat||'-'}</td><td>${d.paket||'-'}</td><td>${d.snOnt||'-'}</td><td>${d.odp||'-'}</td><td>${d.status||'-'}</td><td style="text-align:right"><button class="btn-danger small" onclick="hapusPasang('${doc.id}')">Hapus</button></td>`;
      tbody.appendChild(tr);
      count++;
    });
    q('cardPasang').innerText = String(count);
  }catch(e){ console.error(e); }
}
async function hapusPasang(id){
  if(!confirm('Hapus pasang '+id+'?')) return;
  try{ await db.collection('pasangBaru').doc(id).delete(); await logHistory('pasang.delete', id, 'Deleted'); loadPasangBaru(); }catch(e){ console.error(e); }
}

/* ================ PELANGGAN viewer ================ */
async function loadPelanggan(){
  try{
    const snap = await db.collection('pasangBaru').orderBy('createdAt','desc').get();
    const tbody = q('tblPelanggan').querySelector('tbody'); tbody.innerHTML = '';
    let count = 0;
    snap.forEach(doc => {
      const d = doc.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${doc.id}</td><td>${d.nama||'-'}</td><td>${d.alamat||'-'}</td><td>${d.nohp||'-'}</td><td>${d.paket||'-'}</td><td style="text-align:right"><button class="btn-danger small" onclick="hapusPasang('${doc.id}')">Non-aktif</button></td>`;
      tbody.appendChild(tr);
      count++;
    });
    q('cardPelanggan').innerText = String(count);
  }catch(e){ console.error(e); }
}

/* ================ BILLING (dummy) ================ */
function generateDummyBilling(){
  (async ()=>{
    for(let i=1;i<=5;i++){
      const id = 'B' + String(i).padStart(3,'0');
      await db.collection('billing').doc(id).set({ pelanggan:'Pelanggan'+i, periode:'2025-08', jumlah:100000, status:'Belum Lunas', createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      await logHistory('billing.create', id, 'Dummy created');
    }
    await loadBilling();
    toast('Dummy billing generated');
  })();
}
async function loadBilling(){
  try{
    const snap = await db.collection('billing').orderBy('createdAt','desc').get();
    const tbody = q('tblBilling').querySelector('tbody'); tbody.innerHTML='';
    let sum = 0;
    snap.forEach(doc=>{
      const d = doc.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${doc.id}</td><td>${d.pelanggan||'-'}</td><td>${d.periode||'-'}</td><td>${d.jumlah||0}</td><td>${d.status||'-'}</td><td style="text-align:right"><button class="btn-danger small" onclick="hapusBilling('${doc.id}')">Hapus</button></td>`;
      tbody.appendChild(tr);
      sum += (d.jumlah || 0);
    });
    q('cardBilling').innerText = 'Rp ' + sum.toLocaleString('id-ID');
    // portal table
    const pbody = q('tblPortalBilling').querySelector('tbody'); pbody.innerHTML='';
    snap.forEach(doc=>{ const d=doc.data(); const tr=document.createElement('tr'); tr.innerHTML=`<td>${doc.id}</td><td>${d.pelanggan||'-'}</td><td>${d.periode||'-'}</td><td>${d.jumlah||0}</td><td>${d.status||'-'}</td>`; pbody.appendChild(tr); });
  }catch(e){ console.error(e); }
}
async function hapusBilling(id){ if(!confirm('Hapus billing '+id+'?')) return; await db.collection('billing').doc(id).delete(); loadBilling(); }

/* ================ MATERIAL CRUD ================ */
q('formMaterial').addEventListener('submit', async function(e){
  e.preventDefault();
  const nama = (q('m_nama').value||'').trim();
  const stok = parseInt(q('m_stok').value,10) || 0;
  if(!nama){ toast('Nama material wajib'); return; }
  try{ await db.collection('material').doc(nama).set({ stok }); await logHistory('material.create', nama, `stok ${stok}`); q('formMaterial').reset(); loadMaterial(); }catch(e){ console.error(e); }
});
async function loadMaterial(){
  try{
    const snap = await db.collection('material').get();
    const tbody = q('tblMaterial').querySelector('tbody'); tbody.innerHTML='';
    snap.forEach(doc=>{ const d=doc.data(); const tr=document.createElement('tr'); tr.innerHTML=`<td>${doc.id}</td><td>${d.stok||0}</td><td style="text-align:right"><button class="btn-danger small" onclick="hapusMaterial('${doc.id}')">Hapus</button></td>`; tbody.appendChild(tr); });
  }catch(e){ console.error(e); }
}
async function hapusMaterial(id){ if(!confirm('Hapus material '+id+'?')) return; await db.collection('material').doc(id).delete(); await logHistory('material.delete', id, 'deleted'); loadMaterial(); }

/* ================ PAKET CRUD ================ */
q('formPaket').addEventListener('submit', async function(e){
  e.preventDefault();
  const nama = (q('pkg_nama').value||'').trim();
  const harga = parseInt(q('pkg_harga').value,10) || 0;
  const speed = (q('pkg_speed').value||'').trim();
  if(!nama){ toast('Nama paket wajib'); return; }
  await db.collection('paket').doc(nama).set({ harga, speed });
  await logHistory('paket.create', nama, `paket ${nama}`);
  q('formPaket').reset(); loadPaket();
});
async function loadPaket(){ try{ const snap = await db.collection('paket').get(); const tbody = q('tblPaket').querySelector('tbody'); tbody.innerHTML=''; snap.forEach(doc=>{ const d=doc.data(); const tr=document.createElement('tr'); tr.innerHTML=`<td>${doc.id}</td><td>${d.harga||0}</td><td>${d.speed||'-'}</td><td style="text-align:right"><button class="btn-danger small" onclick="hapusPaket('${doc.id}')">Hapus</button></td>`; tbody.appendChild(tr); }); }catch(e){ console.error(e); } }
async function hapusPaket(id){ if(!confirm('Hapus paket '+id+'?')) return; await db.collection('paket').doc(id).delete(); loadPaket(); }

/* ================ KARYAWAN CRUD ================ */
q('formKaryawan').addEventListener('submit', async function(e){
  e.preventDefault();
  const nik = (q('k_nik').value||'').trim().toLowerCase();
  const nama = (q('k_nama').value||'').trim();
  const pass = (q('k_pass').value||'').trim();
  const role = (q('k_role').value||'teknisi');
  if(!nik || !nama || !pass){ toast('Lengkapi data'); return; }
  await db.collection('users').doc(nik).set({ nama, password: pass, role });
  await logHistory('user.create', nik, `karyawan ${nama}`);
  q('formKaryawan').reset(); loadKaryawan();
});
async function loadKaryawan(){
  try{
    const snap = await db.collection('users').get();
    const tbody = q('tblKaryawan').querySelector('tbody'); tbody.innerHTML='';
    snap.forEach(doc=>{ const d=doc.data(); const tr=document.createElement('tr'); tr.innerHTML=`<td>${doc.id}</td><td>${d.nama||'-'}</td><td>${d.role||'-'}</td><td style="text-align:right"><button class="btn-danger small" onclick="hapusKaryawan('${doc.id}')">Hapus</button></td>`; tbody.appendChild(tr); });
  }catch(e){ console.error(e); }
}
async function hapusKaryawan(id){ if(!confirm('Hapus karyawan '+id+'?')) return; if(currentUser && currentUser.nik === id){ toast('Tidak bisa hapus diri sendiri'); return; } await db.collection('users').doc(id).delete(); loadKaryawan(); }

/* ================ WEBHOOK save ================ */
q('formWebhook').addEventListener('submit', async function(e){
  e.preventDefault();
  const url = (q('wh_url').value||'').trim();
  const auth = (q('wh_auth').value||'').trim();
  if(!url) { toast('URL wajib'); return; }
  await db.collection('webhook').doc('wa').set({ url, auth, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
  await logHistory('webhook.update','wa','webhook updated');
  toast('Webhook disimpan');
});

/* ================ HISTORY loader ================ */
async function loadHistory(){
  try{
    const snap = await db.collection('history').orderBy('ts','desc').limit(200).get();
    const tbody = q('tblHistory').querySelector('tbody'); tbody.innerHTML='';
    const recent = q('recentList'); recent.innerHTML='';
    snap.forEach(doc=>{ const d=doc.data(); const date = d.ts ? d.ts.toDate().toLocaleString() : '-'; const tr=document.createElement('tr'); tr.innerHTML=`<td>${date}</td><td>${d.type||'-'}</td><td>${d.item||'-'}</td><td>${d.desc||'-'}</td>`; tbody.appendChild(tr); const div=document.createElement('div'); div.className='muted'; div.style.marginBottom='6px'; div.innerText=`${date} — ${d.type||''} — ${d.item||''} — ${d.desc||''}`; recent.appendChild(div); });
  }catch(e){ console.error(e); }
}

/* ================ ODP, KAS loaders ================ */
async function loadODP(){ try{ const snap = await db.collection('odp').get(); const tbody = q('tblODP').querySelector('tbody'); tbody.innerHTML=''; snap.forEach(doc=>{ const d=doc.data(); const tr=document.createElement('tr'); tr.innerHTML=`<td>${doc.id}</td><td>${d.sn||'-'}</td><td>${d.ip||'-'}</td><td style="text-align:right"><button class="btn-danger small" onclick="hapusODP('${doc.id}')">Hapus</button></td>`; tbody.appendChild(tr); }); }catch(e){ console.error(e); } }
async function hapusODP(id){ if(!confirm('Hapus ODP '+id+'?')) return; await db.collection('odp').doc(id).delete(); loadODP(); }
async function loadKas(){ try{ const snap = await db.collection('kas').orderBy('ts','desc').get(); const tbody = q('tblKas').querySelector('tbody'); tbody.innerHTML=''; snap.forEach(doc=>{ const d=doc.data(); const tr=document.createElement('tr'); tr.innerHTML=`<td>${doc.id}</td><td>${d.desc||'-'}</td><td>${d.masuk||0}</td><td>${d.keluar||0}</td><td>${d.saldo||0}</td>`; tbody.appendChild(tr); }); }catch(e){ console.error(e); } }

/* ================ INIT ALL ================ */
async function initAll(){
  initDashboard();
  await Promise.all([
    loadGangguan(),
    loadPasangBaru(),
    loadPelanggan(),
    loadBilling(),
    loadMaterial(),
    loadPaket(),
    loadKaryawan(),
    loadHistory(),
    loadODP(),
    loadKas()
  ]);
  showPage('dashboard');
}

/* ================ small helpers run on load ================ */
window.addEventListener('load', ()=> {
  q('appPage').style.display = 'none';
  q('loginPage').style.display = 'flex';
  // close overlay initially
  overlay.classList.remove('show');
});
</script>

</body>
</html>
